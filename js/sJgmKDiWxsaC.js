!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t=t||self).firebase)}(this,(function(t){"use strict";try{(function(){t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,n)};function n(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r,i,o=function(){return(o=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function a(t,e,n,r){return new(n=n||Promise)((function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n((function(e){e(t.value)})).then(a,s)}u((r=r.apply(t,e||[])).next())}))}function s(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=0<(i=a.trys).length&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function u(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}function c(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}function h(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(!(e<t.logLevel)){var o=(new Date).toISOString();switch(e){case r.DEBUG:case r.VERBOSE:console.log.apply(console,c(["["+o+"]  "+t.name+":"],n));break;case r.INFO:console.info.apply(console,c(["["+o+"]  "+t.name+":"],n));break;case r.WARN:console.warn.apply(console,c(["["+o+"]  "+t.name+":"],n));break;case r.ERROR:console.error.apply(console,c(["["+o+"]  "+t.name+":"],n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}}(i=r=r||{})[i.DEBUG=0]="DEBUG",i[i.VERBOSE=1]="VERBOSE",i[i.INFO=2]="INFO",i[i.WARN=3]="WARN",i[i.ERROR=4]="ERROR",i[i.SILENT=5]="SILENT";var l=r.INFO,f=(Object.defineProperty(d.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in r))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),d.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,c([this,r.DEBUG],t))},d.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,c([this,r.VERBOSE],t))},d.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,c([this,r.INFO],t))},d.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,c([this,r.WARN],t))},d.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,c([this,r.ERROR],t))},d);function d(t){this.name=t,this._logLevel=l,this._logHandler=h}function p(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var m,y=(n(g,m=Error),g);function g(t,e){var n=m.call(this,e)||this;return n.code=t,n.name="FirebaseError",Object.setPrototypeOf(n,g.prototype),Error.captureStackTrace&&Error.captureStackTrace(n,v.prototype.create),n}var v=(b.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=e[0]||{},i=this.service+"/"+t,o=this.errors[t],a=o?function(t,e){return t.replace(S,(function(t,n){var r=e[n];return null!=r?r.toString():"<"+n+"?>"}))}(o,r):"Error",s=this.serviceName+": "+a+" ("+i+").",u=new y(i,s),c=0,h=Object.keys(r);c<h.length;c++){var l=h[c];"_"!==l.slice(-1)&&(l in u&&console.warn('Overwriting FirebaseError base field "'+l+'" can cause unexpected behavior.'),u[l]=r[l])}return u},b);function b(t,e,n){this.service=t,this.serviceName=e,this.errors=n}var w,S=/\{\$([^}]+)}/g,T="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},E=E||{},I=T;function C(t){return"string"==typeof t}function D(t){return"number"==typeof t}function N(t,e){t=t.split("."),e=e||I;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function A(){}function k(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function R(t){return"array"==k(t)}function M(t){var e=k(t);return"array"==e||"object"==e&&"number"==typeof t.length}function O(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var _="closure_uid_"+(1e9*Math.random()>>>0),L=0;function P(t,e,n){return t.call.apply(t.bind,arguments)}function x(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function q(t,e,n){return(q=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?P:x).apply(null,arguments)}function F(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}var V=Date.now||function(){return+new Date};function B(t,e){function n(){}n.prototype=e.prototype,t.N=e.prototype,t.prototype=new n,(t.prototype.constructor=t).yb=function(t,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return e.prototype[n].apply(t,i)}}function U(){this.j=this.j,this.i=this.i}U.prototype.j=!1,U.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[_]||(this[_]=++L))},U.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var Q=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(C(t))return C(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},K=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=C(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function j(t){return Array.prototype.concat.apply([],arguments)}function W(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function G(t){return/^[\s\xa0]*$/.test(t)}var z,H=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function Y(t,e){return-1!=t.indexOf(e)}function X(t,e){return t<e?-1:e<t?1:0}t:{var J=I.navigator;if(J){var Z=J.userAgent;if(Z){z=Z;break t}}z=""}function $(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function tt(t){var e,n={};for(e in t)n[e]=t[e];return n}var et="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function nt(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<et.length;o++)n=et[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function rt(t){return rt[" "](t),t}rt[" "]=A;var it,ot,at=Y(z,"Opera"),st=Y(z,"Trident")||Y(z,"MSIE"),ut=Y(z,"Edge"),ct=ut||st,ht=Y(z,"Gecko")&&!(Y(z.toLowerCase(),"webkit")&&!Y(z,"Edge"))&&!(Y(z,"Trident")||Y(z,"MSIE"))&&!Y(z,"Edge"),lt=Y(z.toLowerCase(),"webkit")&&!Y(z,"Edge");function ft(){var t=I.document;return t?t.documentMode:void 0}t:{var dt="",pt=(ot=z,ht?/rv:([^\);]+)(\)|;)/.exec(ot):ut?/Edge\/([\d\.]+)/.exec(ot):st?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ot):lt?/WebKit\/(\S+)/.exec(ot):at?/(?:Version)[ \/]?(\S+)/.exec(ot):void 0);if(pt&&(dt=pt?pt[1]:""),st){var mt=ft();if(null!=mt&&mt>parseFloat(dt)){it=String(mt);break t}}it=dt}var yt,gt={};function vt(t){return function(e,n){var r=gt;return Object.prototype.hasOwnProperty.call(r,e)?r[e]:r[e]=function(){for(var e=0,n=H(String(it)).split("."),r=H(String(t)).split("."),i=Math.max(n.length,r.length),o=0;0==e&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;e=X(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||X(0==a[2].length,0==s[2].length)||X(a[2],s[2]),a=a[3],s=s[3]}while(0==e)}return 0<=e}()}(t)}var bt=I.document;yt=bt&&st?ft()||("CSS1Compat"==bt.compatMode?parseInt(it,10):5):void 0;var wt=!st||9<=Number(yt),St=st&&!vt("9"),Tt=function(){if(!I.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{I.addEventListener("test",A,e),I.removeEventListener("test",A,e)}catch(t){}return t}();function Et(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function It(t,e){if(Et.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(ht){t:{try{rt(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=C(t.pointerType)?t.pointerType:Ct[t.pointerType]||"",(this.c=t).defaultPrevented&&this.b()}}Et.prototype.b=function(){this.Ja=!1},B(It,Et);var Ct={2:"touch",3:"pen",4:"mouse"};It.prototype.b=function(){It.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,St)try{(t.ctrlKey||112<=t.keyCode&&t.keyCode<=123)&&(t.keyCode=-1)}catch(t){}};var Dt="closure_listenable_"+(1e6*Math.random()|0),Nt=0;function At(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++Nt,this.X=this.Z=!1}function kt(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Rt(t){this.src=t,this.a={},this.b=0}function Mt(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=Q(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(kt(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function Ot(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Rt.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=Ot(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new At(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var _t="closure_lm_"+(1e6*Math.random()|0),Lt={};function Pt(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(R(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}return r=Kt(r),e&&e[Dt]?e.Ba(n,r,O(i)?!!i.capture:!!i,o):xt(e,n,r,!0,i,o)}(t,e,n,r,i);if(R(e)){for(var o=0;o<e.length;o++)Pt(t,e[o],n,r,i);return null}return n=Kt(n),t&&t[Dt]?t.Aa(e,n,O(r)?!!r.capture:!!r,i):xt(t,e,n,!1,r,i)}function xt(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=O(i)?!!i.capture:!!i;if(a&&!wt)return null;var s=Ut(t);if(s||(t[_t]=s=new Rt(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var t=Bt,e=wt?function(n){return t.call(e.src,e.listener,n)}:function(n){if(!(n=t.call(e.src,e.listener,n)))return n};return e}(),(n.proxy=r).src=t,r.listener=n,t.addEventListener)Tt||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Ft(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function qt(t){if(!D(t)&&t&&!t.X){var e=t.src;if(e&&e[Dt])Mt(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Ft(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Ut(e))?(Mt(n,t),0==n.b&&(n.src=null,e[_t]=null)):kt(t)}}}function Ft(t){return t in Lt?Lt[t]:Lt[t]="on"+t}function Vt(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&qt(t),n.call(r,e)}function Bt(t,e){return!!t.X||Vt(t,wt?new It(e,this):e=new It(e||N("window.event"),this))}function Ut(t){return(t=t[_t])instanceof Rt?t:null}var Qt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Kt(t){return"function"==k(t)?t:(t[Qt]||(t[Qt]=function(e){return t.handleEvent(e)}),t[Qt])}function jt(){U.call(this),this.c=new Rt(this),(this.J=this).B=null}function Wt(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&Mt(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}B(jt,U),jt.prototype[Dt]=!0,(w=jt.prototype).addEventListener=function(t,e,n,r){Pt(this,t,e,n,r)},w.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(R(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=O(i)?!!i.capture:!!i,r=Kt(r),e&&e[Dt]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=Ot(a=e.a[n],r,i,o))&&(kt(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):(e=e&&Ut(e))&&(n=e.a[n.toString()],e=-1,n&&(e=Ot(n,r,i,o)),(r=-1<e?n[e]:null)&&qt(r))}(this,t,e,n,r)},w.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(C(t))t=new Et(t,n);else if(t instanceof Et)t.target=t.target||n;else{var i=t;nt(t=new Et(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=Wt(a,r,!0,t)&&i}if(i=Wt(a=t.a=n,r,!0,t)&&i,i=Wt(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=Wt(a=t.a=e[o],r,!1,t)&&i;return i},w.G=function(){if(jt.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)kt(n[r]);delete e.a[t],e.b--}}this.B=null},w.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},w.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var Gt=I.JSON.stringify;function zt(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Ht(){this.b=this.a=null}zt.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var Yt,Xt=new zt((function(){return new Jt}),(function(t){t.reset()}));function Jt(){this.next=this.b=this.a=null}function Zt(t){I.setTimeout((function(){throw t}),0)}function $t(t,e){Yt||function(){var t=I.Promise.resolve(void 0);Yt=function(){t.then(ne)}}(),te||(Yt(),te=!0),ee.add(t,e)}Ht.prototype.add=function(t,e){var n=Xt.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},Jt.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null};var te=!(Jt.prototype.reset=function(){this.next=this.b=this.a=null}),ee=new Ht;function ne(){for(var t;r=n=void 0,r=null,(n=ee).a&&(r=n.a,n.a=n.a.next,n.a||(n.b=null),r.next=null),t=r;){try{t.a.call(t.b)}catch(t){Zt(t)}var e=Xt;e.f(t),e.b<100&&(e.b++,t.next=e.a,e.a=t)}var n,r;te=!1}function re(t,e){jt.call(this),this.b=t||1,this.a=e||I,this.f=q(this.gb,this),this.g=V()}function ie(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function oe(t,e,n){if("function"==k(t))n&&(t=q(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=q(t.handleEvent,t)}return 2147483647<Number(e)?-1:I.setTimeout(t,e||0)}function ae(t,e,n){U.call(this),this.f=null!=n?q(t,n):t,this.c=e,this.b=q(this.ab,this),this.a=[]}function se(t){t.U=oe(t.b,t.c),t.f.apply(null,t.a)}function ue(t){U.call(this),this.b=t,this.a={}}B(re,jt),(w=re.prototype).ba=!1,w.L=null,w.gb=function(){if(this.ba){var t=V()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(ie(this),this.start()))}},w.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=V())},w.G=function(){re.N.G.call(this),ie(this),delete this.a},B(ae,U),(w=ae.prototype).ea=!1,w.U=null,w.Ua=function(t){this.a=arguments,this.U?this.ea=!0:se(this)},w.G=function(){ae.N.G.call(this),this.U&&(I.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},w.ab=function(){this.U=null,this.ea&&(this.ea=!1,se(this))},B(ue,U);var ce=[];function he(t,e,n,r){R(n)||(n&&(ce[0]=n.toString()),n=ce);for(var i=0;i<n.length;i++){var o=Pt(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function le(t){$(t.a,(function(t,e){this.a.hasOwnProperty(e)&&qt(t)}),t),t.a={}}function fe(){}ue.prototype.G=function(){ue.N.G.call(this),le(this)},ue.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var de=new jt;function pe(t){Et.call(this,"serverreachability",t)}function me(t){de.dispatchEvent(new pe(de,t))}function ye(t){Et.call(this,"statevent",t)}function ge(t){de.dispatchEvent(new ye(de,t))}function ve(t){Et.call(this,"timingevent",t)}function be(t,e){if("function"!=k(t))throw Error("Fn must not be null and must be a function");return I.setTimeout((function(){t()}),e)}B(pe,Et),B(ye,Et),B(ve,Et);var we={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},Se={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function Te(){}function Ee(t){var e;return(e=t.a)||(e=t.a={}),e}function Ie(){}Te.prototype.a=null;var Ce,De={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Ne(){Et.call(this,"d")}function Ae(){Et.call(this,"c")}function ke(){}function Re(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new ue(this),this.O=Me,t=ct?125:void 0,this.P=new re(t),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}B(Ne,Et),B(Ae,Et),B(ke,Te),Ce=new ke;var Me=45e3,Oe={},_e={};function Le(t,e,n){t.F=1,t.f=an(Ze(e)),t.l=n,t.H=!0,xe(t,null)}function Pe(t,e,n,r){t.F=1,t.f=an(Ze(e)),t.l=null,t.H=n,xe(t,r)}function xe(t,e){t.v=V(),Ve(t),t.D=Ze(t.f),on(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new ae(q(t.Ka,t,t.a),t.J)),he(t.I,t.a,"readystatechange",t.eb),e=t.h?tt(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),me(1)}function qe(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=Fe(t,n);if(i==_e){4==e&&(t.c=4,ge(14),r=!1);break}if(i==Oe){t.c=4,ge(15),r=!1;break}je(t,i)}4==e&&0==n.length&&(t.c=1,ge(16),r=!1),t.b=t.b&&r,r||(Ke(t),Qe(t))}function Fe(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?_e:(n=Number(e.substring(n,r)),isNaN(n)?Oe:(r+=1)+n>e.length?_e:(e=e.substr(r,n),t.A=r+n,e))}function Ve(t){t.R=V()+t.O,Be(t,t.O)}function Be(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=be(q(t.bb,t),e)}function Ue(t){t.i&&(I.clearTimeout(t.i),t.i=null)}function Qe(t){t.g.Da()||t.m||t.g.na(t)}function Ke(t){Ue(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,ie(t.P),le(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function je(t,e){try{t.g.Ga(t,e),me(4)}catch(t){}}function We(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(M(t)||C(t))K(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(M(t)||C(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(C(t))return t.split("");if(M(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function Ge(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Ge)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function ze(t,e){Ye(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&He(t))}function He(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];Ye(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)Ye(i,r=t.a[e])||(i[t.a[n++]=r]=1),e++;t.a.length=n}}function Ye(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(w=Re.prototype).setTimeout=function(t){this.O=t},w.eb=function(t){t=t.target;var e=this.B;e&&3==Zn(t)?e.Ua():this.Ka(t)},w.Ka=function(t){try{if(t==this.a)t:{var e=Zn(this.a),n=this.a.ya(),r=this.a.T();if(!(e<3||3==e&&!ct&&!this.a.aa())){this.m||4!=e||7==n||me(8==n||r<=0?3:2),Ue(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=$n(this.a,"X-HTTP-Initial-Response");if(a&&!G(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,ge(12),Ke(this),Qe(this);break t}this.s=!0,je(this,s)}this.H?(qe(this,e,o),ct&&this.b&&3==e&&(he(this.I,this.P,"tick",this.cb),this.P.start())):je(this,o),4==e&&Ke(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,Ve(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,ge(12)):(this.c=0,ge(13)),Ke(this),Qe(this)}}}catch(t){}},w.cb=function(){if(this.a){var t=Zn(this.a),e=this.a.aa();this.A<e.length&&(Ue(this),qe(this,t,e),this.b&&4!=t&&Ve(this))}},w.cancel=function(){this.m=!0,Ke(this)},w.bb=function(){this.i=null;var t=V();0<=t-this.R?(2!=this.F&&(me(3),ge(17)),Ke(this),this.c=2,Qe(this)):Be(this,this.R-t)},(w=Ge.prototype).C=function(){He(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},w.K=function(){return He(this),this.a.concat()},w.get=function(t,e){return Ye(this.b,t)?this.b[t]:e},w.set=function(t,e){Ye(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},w.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var Xe=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Je(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof Je?(this.h=void 0!==e?e:t.h,$e(this,t.f),this.j=t.j,tn(this,t.b),en(this,t.i),this.a=t.a,nn(this,wn(t.c)),this.g=t.g):t&&(n=String(t).match(Xe))?(this.h=!!e,$e(this,n[1]||"",!0),this.j=sn(n[2]||""),tn(this,n[3]||"",!0),en(this,n[4]),this.a=sn(n[5]||"",!0),nn(this,n[6]||"",!0),this.g=sn(n[7]||"")):(this.h=!!e,this.c=new mn(null,this.h))}function Ze(t){return new Je(t)}function $e(t,e,n){t.f=n?sn(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function tn(t,e,n){t.b=n?sn(e,!0):e}function en(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.i=e}else t.i=null}function nn(t,e,n){e instanceof mn?(t.c=e,function(t,e){e&&!t.f&&(yn(t),t.c=null,t.a.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(gn(this,e),bn(this,n,t))}),t)),t.f=e}(t.c,t.h)):(n||(e=un(e,dn)),t.c=new mn(e,t.h))}function rn(t,e,n){t.c.set(e,n)}function on(t,e,n){R(n)||(n=[String(n)]),bn(t.c,e,n)}function an(t){return rn(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^V()).toString(36)),t}function sn(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function un(t,e,n){return C(t)?(t=encodeURI(t).replace(e,cn),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function cn(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Je.prototype.toString=function(){var t=[],e=this.f;e&&t.push(un(e,hn,!0),":");var n=this.b;return!n&&"file"!=e||(t.push("//"),(e=this.j)&&t.push(un(e,hn,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(un(n,"/"==n.charAt(0)?fn:ln,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",un(n,pn)),t.join("")},Je.prototype.resolve=function(t){var e=Ze(this),n=!!t.f;n?$e(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?tn(e,t.b):n=null!=t.i;var r=t.a;if(n)en(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(Y(i,"./")||Y(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?nn(e,wn(t.c)):n=!!t.g,n&&(e.g=t.g),e};var hn=/[#\/\?@]/g,ln=/[#\?:]/g,fn=/[#\?]/g,dn=/[#\?@]/g,pn=/#/g;function mn(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function yn(t){t.a||(t.a=new Ge,t.b=0,t.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(t.c,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function gn(t,e){yn(t),e=Sn(t,e),Ye(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,ze(t.a,e))}function vn(t,e){return yn(t),e=Sn(t,e),Ye(t.a.b,e)}function bn(t,e,n){gn(t,e),0<n.length&&(t.c=null,t.a.set(Sn(t,e),W(n)),t.b+=n.length)}function wn(t){var e=new mn;return e.c=t.c,t.a&&(e.a=new Ge(t.a),e.b=t.b),e}function Sn(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function Tn(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function En(t){var e=t.a.F.a;if(null!=e)ge(4),e?(ge(10),lr(t.a,t,!1)):(ge(11),lr(t.a,t,!0));else{t.b=new Re(t,void 0,void 0),t.b.h=t.h,e=yr(e=t.a,e.Y()?t.f:null,t.i),ge(4),on(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&rn(e,n,r),Pe(t.b,e,!1,t.f)}}function In(){this.a=this.b=null}function Cn(){this.a=new Ge}function Dn(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[_]||(t[_]=++L)):e.charAt(0)+t}function Nn(t,e){this.b=t,this.a=e}function An(t){this.g=t||kn,t=I.PerformanceNavigationTiming?0<(t=I.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(I.ka&&I.ka.Ea&&I.ka.Ea()&&I.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Cn),this.b=null,this.c=[]}(w=mn.prototype).add=function(t,e){yn(this),this.c=null,t=Sn(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},w.forEach=function(t,e){yn(this),this.a.forEach((function(n,r){K(n,(function(n){t.call(e,n,r,this)}),this)}),this)},w.K=function(){yn(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},w.C=function(t){yn(this);var e=[];if(C(t))vn(this,t)&&(e=j(e,this.a.get(Sn(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=j(e,t[n])}return e},w.set=function(t,e){return yn(this),this.c=null,vn(this,t=Sn(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},w.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},w.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},B((function(){}),(function(){})),(w=Tn.prototype).M=null,w.$=function(t){return this.a.$(t)},w.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},w.Da=function(){return!1},w.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=$n(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=$n(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void pr(e,2)}this.f=r[0]}else(e=this.a).m=this.c,pr(e,2)}else 1==this.M&&(this.g?ge(6):"11111"==e?(ge(5),this.g=!0,(!st||10<=Number(yt))&&(this.c=200,this.b.cancel(),ge(11),lr(this.a,this,!0))):(ge(7),this.g=!1))},w.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,En(this)):1==this.M&&(this.g?(ge(11),lr(this.a,this,!0)):(ge(10),lr(this.a,this,!1)));else{0==this.M?ge(8):1==this.M&&ge(9);var t=this.a;t.m=this.c,pr(t,2)}},w.Y=function(){return this.a.Y()},w.ma=function(){return this.a.ma()},Cn.prototype.add=function(t){this.a.set(Dn(t),t)},Cn.prototype.C=function(){return this.a.C()};var kn=10;function Rn(t,e){!t.a&&(Y(e,"spdy")||Y(e,"quic")||Y(e,"h2"))&&(t.f=t.g,t.a=new Cn,t.b&&(Ln(t,t.b),t.b=null))}function Mn(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function On(t){return t.b?1:t.a?t.a.a.c:0}function _n(t,e){return t.b?t.b==e:!!t.a&&(e=Dn(e),Ye(t.a.a.b,e))}function Ln(t,e){t.a?t.a.add(e):t.b=e}function Pn(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=Dn(e),n=Ye(t.a.a.b,n)),n&&ze(t.a.a,Dn(e)))}function xn(t){if(null!=t.b)return t.c.concat(t.b.j);if(null==t.a||0==t.a.a.c)return W(t.c);var e=t.c;return K(t.a.C(),(function(t){e=e.concat(t.j)})),e}function qn(){}function Fn(){this.a=new qn}function Vn(t,e,n){var r=n||"";try{We(t,(function(t,n){var i=t;O(t)&&(i=Gt(t)),e.push(r+n+"="+encodeURIComponent(i))}))}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function Bn(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}An.prototype.cancel=function(){this.c=xn(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(K(this.a.C(),(function(t){t.cancel()})),function(t){t.b={},t.a.length=0,t.c=0}(this.a.a))},qn.prototype.stringify=function(t){return I.JSON.stringify(t,void 0)},qn.prototype.parse=function(t){return I.JSON.parse(t,void 0)};var Un=I.JSON.parse;function Qn(t){jt.call(this),this.headers=new Ge,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Kn,this.D=this.F=!1}B(Qn,jt);var Kn="",jn=/^https?$/i,Wn=["POST","PUT"];function Gn(t){return"content-type"==t.toLowerCase()}function zn(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Hn(t),Xn(t)}function Hn(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function Yn(t){if(t.b&&void 0!==E&&(!t.s[1]||4!=Zn(t)||2!=t.T()))if(t.l&&4==Zn(t))oe(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==Zn(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(Xe)[1]||null;if(!o&&I.self&&I.self.location){var a=I.self.location.protocol;o=a.substr(0,a.length-1)}i=!jn.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Hn(t))}finally{Xn(t)}}}function Xn(t,e){if(t.a){Jn(t);var n=t.a,r=t.s[0]?A:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function Jn(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(I.clearTimeout(t.m),t.m=null)}function Zn(t){return t.a?t.a.readyState:0}function $n(t,e){return t.a?t.a.getResponseHeader(e):null}function tr(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var e="";return $(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),C(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if((n=t.indexOf("#"))<0&&(n=t.length),(r=t.indexOf("?"))<0||n<r){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return rn(t,e,n),t}function er(t){this.f=[],this.F=new In,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!N("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=N("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=N("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=N("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=N("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new An(t&&t.concurrentRequestLimit),this.ja=new Fn,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function nr(t){if(rr(t),3==t.u){var e=t.P++,n=Ze(t.B);rn(n,"SID",t.H),rn(n,"RID",e),rn(n,"TYPE","terminate"),sr(t,n),(e=new Re(t,e,void 0)).F=2,e.f=an(Ze(n)),n=!1,I.navigator&&I.navigator.sendBeacon&&(n=I.navigator.sendBeacon(e.f.toString(),"")),!n&&I.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=V(),Ve(e)}mr(t)}function rr(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(I.clearTimeout(t.l),t.l=null),fr(t),t.b.cancel(),t.h&&(D(t.h)&&I.clearTimeout(t.h),t.h=null)}function ir(t,e){t.f.push(new Nn(t.Ra++,e)),3==t.u&&or(t)}function or(t){Mn(t.b)||t.h||(t.h=!0,$t(t.Ia,t),t.A=0)}function ar(t,e){var n;n=e?e.W:t.P++;var r=Ze(t.B);rn(r,"SID",t.H),rn(r,"RID",n),rn(r,"AID",t.O),sr(t,r),t.g&&t.i&&tr(r,t.g,t.i),n=new Re(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=ur(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Ln(t.b,n),Le(n,r,e)}function sr(t,e){t.c&&We({},(function(t,n){rn(e,n,t)}))}function ur(t,e,n){n=Math.min(t.f.length,n);var r=t.c?q(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{Vn(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function cr(t){t.a||t.l||(t.S=1,$t(t.Ha,t),t.v=0)}function hr(t){return!(t.a||t.l||3<=t.v||(t.S++,t.l=be(q(t.Ha,t),dr(t,t.v)),t.v++,0))}function lr(t,e,n){var r=e.l;r&&Rn(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=yr(t,null,t.ha),or(t)}function fr(t){null!=t.s&&(I.clearTimeout(t.s),t.s=null)}function dr(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function pr(t,e){if(2==e){var n=null;t.c&&(n=null);var r=q(t.fb,t);n||(n=new Je("//www.google.com/images/cleardot.gif"),I.location&&"http"==I.location.protocol||$e(n,"https"),an(n)),function(t,e){var n=new fe;if(I.Image){var r=new Image;r.onload=F(Bn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=F(Bn,n,r,"TestLoadImage: error",!1,e),r.onabort=F(Bn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=F(Bn,n,r,"TestLoadImage: timeout",!1,e),I.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(n.toString(),r)}else ge(2);t.u=0,t.c&&t.c.ta(e),mr(t),rr(t)}function mr(t){t.u=0,t.m=-1,t.c&&(0==xn(t.b).length&&0==t.f.length||(t.b.c.length=0,W(t.f),t.f.length=0),t.c.sa())}function yr(t,e,n){var r=function(t){return t instanceof Je?Ze(t):new Je(t,void 0)}(n);if(""!=r.b)e&&tn(r,e+"."+r.b),en(r,r.i);else{var i,o=I.location;i=e?e+"."+o.hostname:o.hostname,r=function(t,e,n,r){var i=new Je(null,void 0);return t&&$e(i,t),e&&tn(i,e),n&&en(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return t.V&&$(t.V,(function(t,e){rn(r,e,t)})),e=t.j,n=t.I,e&&n&&rn(r,e,n),rn(r,"VER",t.wa),sr(t,r),r}function gr(){}function vr(){if(st&&!(10<=Number(yt)))throw Error("Environmental error: no available transport.")}function br(t,e){jt.call(this),this.a=new er(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=t,n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!G(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!G(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&e in(t=this.b)&&delete t[e]),this.f=new Tr(this)}function wr(t){Ne.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function Sr(){Ae.call(this),this.status=1}function Tr(t){this.a=t}(w=Qn.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?Ee(this.H):Ee(Ce),this.a.onreadystatechange=q(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void zn(this,t)}t=n||"";var i=new Ge(this.headers);r&&We(r,(function(t,e){i.set(e,t)})),r=function(t){t:{for(var e=Gn,n=t.length,r=C(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return e<0?null:C(t)?t.charAt(e):t[e]}(i.K()),n=I.FormData&&t instanceof I.FormData,0<=Q(Wn,e)&&!r&&!n&&i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach((function(t,e){this.a.setRequestHeader(e,t)}),this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Jn(this),0<this.o&&((this.D=function(t){return st&&vt(9)&&D(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=q(this.Ca,this)):this.m=oe(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){zn(this,t)}},w.Ca=function(){void 0!==E&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},w.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),Xn(this))},w.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),Xn(this,!0)),Qn.N.G.call(this)},w.Fa=function(){this.j||(this.w||this.l||this.g?Yn(this):this.$a())},w.$a=function(){Yn(this)},w.T=function(){try{return 2<Zn(this)?this.a.status:-1}catch(t){return-1}},w.za=function(){try{return 2<Zn(this)?this.a.statusText:""}catch(t){return""}},w.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},w.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Un(e)}},w.ya=function(){return this.h},w.Ya=function(){return C(this.f)?this.f:String(this.f)},(w=er.prototype).wa=8,w.u=1,w.Da=function(){return 0==this.u},w.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var e,n=new Re(this,t=this.P++,void 0),r=this.i;if(this.J&&(r?nt(r=tt(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&C(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=ur(this,n,e),rn(i=Ze(this.B),"RID",t),rn(i,"CVER",22),this.o&&this.j&&rn(i,"X-HTTP-Session-Id",this.j),sr(this,i),this.g&&r&&tr(i,this.g,r),Ln(this.b,n),this.W?(rn(i,"$req",e),rn(i,"SID","null"),n.S=!0,Le(n,i,null)):Le(n,i,e),this.u=2}}else 3==this.u&&(t?ar(this,t):0==this.f.length||Mn(this.b)||ar(this))},w.Ha=function(){this.l=null,this.a=new Re(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=Ze(this.pa);rn(t,"RID","rpc"),rn(t,"SID",this.H),rn(t,"CI",this.ia?"0":"1"),rn(t,"AID",this.O),sr(this,t),rn(t,"TYPE","xmlhttp"),this.g&&this.i&&tr(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),Pe(this.a,t,!0,this.ga)},w.Ga=function(t,e){if(0!=this.u&&(this.a==t||_n(this.b,t)))if(this.m=t.o,!t.s&&_n(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(R(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;fr(this),this.a.cancel(),this.a=null}hr(this),ge(18)}}else this.ra=e[1],0<this.ra-this.O&&e[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=be(q(this.Za,this),6e3));if(On(this.b)<=1&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else pr(this,11)}else if(!t.s&&this.a!=t||fr(this),!G(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&D(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=$n(r,"X-Client-Wire-Protocol"))&&Rn(this.b,i),this.j&&(r=$n(r,"X-HTTP-Session-Id")))&&(this.I=r,rn(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=yr(this,this.Y()?this.ga:null,this.ha),r.s?(Pn(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(Ue(r),Ve(r)),this.a=r):cr(this),0<this.f.length&&or(this)}else"stop"!=r[0]&&"close"!=r[0]||pr(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?pr(this,7):nr(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},w.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,hr(this),ge(19))},w.na=function(t){var e=null;if(this.a==t){fr(this),this.a=null;var n=2}else{if(!_n(this.b,t))return;e=t.j,Pn(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=V()-t.v,de.dispatchEvent(new ve(de,t.l?t.l.length:0,e,this.A)),or(this)):cr(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(On(t.b)>=t.b.f-(t.h?1:0)||(t.h?(t.f=e.j.concat(t.f),0):1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa)||(t.h=be(q(t.Ia,t,e),dr(t,t.A)),t.A++,0)))}(this,t)||2==n&&hr(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:pr(this,5);break;case 4:pr(this,10);break;case 3:pr(this,6);break;default:pr(this,2)}}},w.fb=function(t){ge(t?2:1)},w.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new Qn(this.La)).F=this.R,t},w.ma=function(){return!!this.c&&!0},w.Y=function(){return this.R},(w=gr.prototype).va=function(){},w.ua=function(){},w.ta=function(){},w.sa=function(){},w.Ta=function(){},vr.prototype.a=function(t,e){return new br(t,e)},B(br,jt),(w=br.prototype).addEventListener=function(t,e,n,r){br.N.addEventListener.call(this,t,e,n,r)},w.removeEventListener=function(t,e,n,r){br.N.removeEventListener.call(this,t,e,n,r)},w.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;ge(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new Tn(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=tr(e,t.g,t.i)),(t=t.w).i=n,e=yr(t.a,null,t.i),ge(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,En(t)):(on(e,"MODE","init"),!t.a.o&&t.a.j&&on(e,"X-HTTP-Session-Id",t.a.j),t.b=new Re(t,void 0,void 0),t.b.h=t.h,Pe(t.b,e,!1,null),t.M=0)},w.close=function(){nr(this.a)},w.Xa=function(t){if(C(t)){var e={};e.__data__=t,ir(this.a,e)}else this.h?((e={}).__data__=Gt(t),ir(this.a,e)):ir(this.a,t)},w.G=function(){this.a.c=null,delete this.f,nr(this.a),delete this.a,br.N.G.call(this)},B(wr,Ne),B(Sr,Ae),B(Tr,gr),Tr.prototype.va=function(){this.a.dispatchEvent("a")},Tr.prototype.ua=function(t){this.a.dispatchEvent(new wr(t))},Tr.prototype.ta=function(t){this.a.dispatchEvent(new Sr(t))},Tr.prototype.sa=function(){this.a.dispatchEvent("b")};var Er=F((function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r}),vr);vr.prototype.createWebChannel=vr.prototype.a,br.prototype.send=br.prototype.Xa,br.prototype.open=br.prototype.Wa,br.prototype.close=br.prototype.close,we.NO_ERROR=0,we.TIMEOUT=8,we.HTTP_ERROR=6,Se.COMPLETE="complete",(Ie.EventType=De).OPEN="a",De.CLOSE="b",De.ERROR="c",De.MESSAGE="d",jt.prototype.listen=jt.prototype.Aa,Qn.prototype.listenOnce=Qn.prototype.Ba,Qn.prototype.getLastError=Qn.prototype.Ya,Qn.prototype.getLastErrorCode=Qn.prototype.ya,Qn.prototype.getStatus=Qn.prototype.T,Qn.prototype.getStatusText=Qn.prototype.za,Qn.prototype.getResponseJson=Qn.prototype.Va,Qn.prototype.getResponseText=Qn.prototype.aa,Qn.prototype.send=Qn.prototype.ca;var Ir,Cr,Dr={createWebChannelTransport:Er,ErrorCode:we,EventType:Se,WebChannel:Ie,XhrIo:Qn},Nr=Dr.createWebChannelTransport,Ar=Dr.ErrorCode,kr=Dr.EventType,Rr=Dr.WebChannel,Mr=Dr.XhrIo,Or=t.SDK_VERSION,_r=new f("@firebase/firestore");function Lr(){return _r.logLevel===r.DEBUG?Ir.DEBUG:_r.logLevel===r.SILENT?Ir.SILENT:Ir.ERROR}function Pr(t){switch(t){case Ir.DEBUG:_r.logLevel=r.DEBUG;break;case Ir.ERROR:_r.logLevel=r.ERROR;break;case Ir.SILENT:_r.logLevel=r.SILENT;break;default:_r.error("Firestore ("+Or+"): Invalid value passed to `setLogLevel`")}}function xr(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(_r.logLevel<=r.DEBUG){var o=n.map(Fr);_r.debug.apply(_r,u(["Firestore ("+Or+") ["+t+"]: "+e],o))}}function qr(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(_r.logLevel<=r.ERROR){var i=e.map(Fr);_r.error.apply(_r,u(["Firestore ("+Or+"): "+t],i))}}function Fr(t){if("string"==typeof t)return t;var e=Ur.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function Vr(t){var e="FIRESTORE ("+Or+") INTERNAL ASSERTION FAILED: "+t;throw qr(e),new Error(e)}function Br(t,e){t||Vr(e)}(Cr=Ir=Ir||{})[Cr.DEBUG=0]="DEBUG",Cr[Cr.ERROR=1]="ERROR",Cr[Cr.SILENT=2]="SILENT";var Ur=(Qr.setPlatform=function(t){Qr.platform&&Vr("Platform already defined"),Qr.platform=t},Qr.getPlatform=function(){return Qr.platform||Vr("Platform not set"),Qr.platform},Qr);function Qr(){}function Kr(){return Ur.getPlatform().emptyByteString}var jr,Wr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Gr=(n(zr,jr=Error),zr);function zr(t,e){var n=jr.call(this,e)||this;return n.code=t,n.message=e,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}function Hr(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Gr(Wr.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Yr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Xr(t,e){return void 0!==t?t:e}function Jr(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function Zr(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function $r(t){for(var e in Br(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function ti(t,e){if(0!==e.length)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+yi(e.length,"argument")+".")}function ei(t,e,n){if(e.length!==n)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires "+yi(n,"argument")+", but was called with "+yi(e.length,"argument")+".")}function ni(t,e,n){if(e.length<n)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires at least "+yi(n,"argument")+", but was called with "+yi(e.length,"argument")+".")}function ri(t,e,n,r){if(e.length<n||e.length>r)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+yi(e.length,"argument")+".")}function ii(t,e,n,r){ci(t,e,mi(n)+" argument",r)}function oi(t,e,n,r){void 0!==r&&ii(t,e,n,r)}function ai(t,e,n,r){ci(t,e,n+" option",r)}function si(t,e,n,r){void 0!==r&&ai(t,e,n,r)}function ui(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(li(u))}var c=li(r);throw new Gr(Wr.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function ci(t,e,n,r){if(!("object"===e?hi(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=li(r);throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function hi(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function li(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":Vr("Unknown wrong type: "+typeof t);if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&1<e.length)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}function fi(t,e,n){if(void 0===n)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+mi(e)+" argument, but it was undefined.")}function di(t,e,n){Zr(e,(function(e,r){if(n.indexOf(e)<0)throw new Gr(Wr.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))}))}function pi(t,e,n,r){var i=li(r);return new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires its "+mi(n)+" argument to be a "+e+", but it was: "+i)}function mi(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function yi(t,e){return t+" "+e+(1===t?"":"s")}var gi=(vi.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Br(20===e.length,"Invalid auto ID: "+e),e},vi);function vi(){}function bi(t,e){return t<e?-1:e<t?1:0}function wi(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function Si(t){return t+"\0"}function Ti(){if("undefined"==typeof Uint8Array)throw new Gr(Wr.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Ei(){if(!Ur.getPlatform().base64Available)throw new Gr(Wr.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Ii=(Ci.fromBase64String=function(t){ei("Blob.fromBase64String",arguments,1),ii("Blob.fromBase64String","string",1,t),Ei();try{return new Ci(Ur.getPlatform().atob(t))}catch(t){throw new Gr(Wr.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},Ci.fromUint8Array=function(t){if(ei("Blob.fromUint8Array",arguments,1),Ti(),!(t instanceof Uint8Array))throw pi("Blob.fromUint8Array","Uint8Array",1,t);return new Ci(Array.prototype.map.call(t,(function(t){return String.fromCharCode(t)})).join(""))},Ci.prototype.toBase64=function(){return ei("Blob.toBase64",arguments,0),Ei(),Ur.getPlatform().btoa(this._binaryString)},Ci.prototype.toUint8Array=function(){ei("Blob.toUint8Array",arguments,0),Ti();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},Ci.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Ci.prototype.isEqual=function(t){return this._binaryString===t._binaryString},Ci.prototype._compareTo=function(t){return bi(this._binaryString,t._binaryString)},Ci);function Ci(t){Ei(),this._binaryString=t}var Di=Hr(Ii,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),Ni=function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i},Ai="(default)",ki=(Object.defineProperty(Ri.prototype,"isDefaultDatabase",{get:function(){return this.database===Ai},enumerable:!0,configurable:!0}),Ri.prototype.isEqual=function(t){return t instanceof Ri&&t.projectId===this.projectId&&t.database===this.database},Ri.prototype.compareTo=function(t){return bi(this.projectId,t.projectId)||bi(this.database,t.database)},Ri);function Ri(t,e){this.projectId=t,this.database=e||Ai}var Mi=(Oi.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},Oi.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},Oi.INVALID=-1,Oi);function Oi(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}var _i="__name__",Li=(Object.defineProperty(Pi.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),Pi.prototype.isEqual=function(t){return 0===Pi.comparator(this,t)},Pi.prototype.child=function(t){var e=this.segments.slice(this.offset,this.limit());return t instanceof Pi?t.forEach((function(t){e.push(t)})):e.push(t),this.construct(e)},Pi.prototype.limit=function(){return this.offset+this.length},Pi.prototype.popFirst=function(t){return t=void 0===t?1:t,Br(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},Pi.prototype.popLast=function(){return Br(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},Pi.prototype.firstSegment=function(){return Br(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},Pi.prototype.lastSegment=function(){return this.get(this.length-1)},Pi.prototype.get=function(t){return Br(t<this.length,"Index out of range"),this.segments[this.offset+t]},Pi.prototype.isEmpty=function(){return 0===this.length},Pi.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Pi.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Pi.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},Pi.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},Pi.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(o<i)return 1}return t.length<e.length?-1:t.length>e.length?1:0},Pi);function Pi(t,e,n){void 0===e?e=0:e>t.length&&Vr("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&Vr("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n}var xi,qi=(n(Fi,xi=Li),Fi.prototype.construct=function(t,e,n){return new Fi(t,e,n)},Fi.prototype.canonicalString=function(){return this.toArray().join("/")},Fi.prototype.toString=function(){return this.canonicalString()},Fi.fromString=function(t){if(0<=t.indexOf("//"))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new Fi(t.split("/").filter((function(t){return 0<t.length})))},Fi.EMPTY_PATH=new Fi([]),Fi);function Fi(){return null!==xi&&xi.apply(this,arguments)||this}var Vi,Bi=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Ui=(n(Qi,Vi=Li),Qi.prototype.construct=function(t,e,n){return new Qi(t,e,n)},Qi.isValidIdentifier=function(t){return Bi.test(t)},Qi.prototype.canonicalString=function(){return this.toArray().map((function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),Qi.isValidIdentifier(t)||(t="`"+t+"`"),t})).join(".")},Qi.prototype.toString=function(){return this.canonicalString()},Qi.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===_i},Qi.keyField=function(){return new Qi([_i])},Qi.fromServerFormat=function(t){for(var e=[],n="",r=0,i=function(){if(0===n.length)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(n),n=""},o=!1;r<t.length;){var a=t[r];if("\\"===a){if(r+1===t.length)throw new Gr(Wr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var s=t[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new Gr(Wr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new Gr(Wr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Qi(e)},Qi.EMPTY_PATH=new Qi([]),Qi);function Qi(){return null!==Vi&&Vi.apply(this,arguments)||this}var Ki=(ji.prototype.hasCollectionId=function(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t},ji.prototype.isEqual=function(t){return null!==t&&0===qi.comparator(this.path,t.path)},ji.prototype.toString=function(){return this.path.toString()},ji.comparator=function(t,e){return qi.comparator(t.path,e.path)},ji.isDocumentKey=function(t){return t.length%2==0},ji.fromSegments=function(t){return new ji(new qi(t.slice()))},ji.fromPathString=function(t){return new ji(qi.fromString(t))},ji.EMPTY=new ji(new qi([])),ji);function ji(t){this.path=t,Br(ji.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}var Wi,Gi,zi=function(){var t=this;this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))};(Gi=Wi=Wi||{}).All="all",Gi.ListenStreamIdle="listen_stream_idle",Gi.ListenStreamConnectionBackoff="listen_stream_connection_backoff",Gi.WriteStreamIdle="write_stream_idle",Gi.WriteStreamConnectionBackoff="write_stream_connection_backoff",Gi.OnlineStateTimeout="online_state_timeout",Gi.ClientMetadataRefresh="client_metadata_refresh",Gi.LruGarbageCollection="lru_garbage_collection",Gi.RetryTransaction="retry_transaction";var Hi=(Yi.createAndSchedule=function(t,e,n,r,i){var o=new Yi(t,e,Date.now()+n,r,i);return o.start(n),o},Yi.prototype.start=function(t){var e=this;this.timerHandle=setTimeout((function(){return e.handleDelayElapsed()}),t)},Yi.prototype.skipDelay=function(){return this.handleDelayElapsed()},Yi.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Gr(Wr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},Yi.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget((function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then((function(e){return t.deferred.resolve(e)}))):Promise.resolve()}))},Yi.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},Yi);function Yi(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new zi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch((function(t){}))}var Xi=(Object.defineProperty(Ji.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),Ji.prototype.enqueueAndForget=function(t){this.enqueue(t)},Ji.prototype.enqueueAndForgetEvenAfterShutdown=function(t){this.verifyNotFailed(),this.enqueueInternal(t)},Ji.prototype.enqueueEvenAfterShutdown=function(t){return this.verifyNotFailed(),this.enqueueInternal(t)},Ji.prototype.enqueueAndInitiateShutdown=function(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(t)]);case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},Ji.prototype.enqueue=function(t){return this.verifyNotFailed(),this._isShuttingDown?new Promise((function(t){})):this.enqueueInternal(t)},Ji.prototype.enqueueInternal=function(t){var e=this,n=this.tail.then((function(){return e.operationInProgress=!0,t().catch((function(t){e.failure=t,e.operationInProgress=!1;var n=t.stack||t.message||"";throw qr("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout((function(){throw t}),0),t})).then((function(t){return e.operationInProgress=!1,t}))}));return this.tail=n},Ji.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Br(0<=e,"Attempted to schedule an operation with a negative delay of "+e),-1<this.timerIdsToSkip.indexOf(t)&&(e=0);var i=Hi.createAndSchedule(this,t,e,n,(function(t){return r.removeDelayedOperation(t)}));return this.delayedOperations.push(i),i},Ji.prototype.verifyNotFailed=function(){this.failure&&Vr("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},Ji.prototype.verifyOperationInProgress=function(){Br(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},Ji.prototype.drain=function(){return this.enqueueEvenAfterShutdown((function(){return Promise.resolve()}))},Ji.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},Ji.prototype.runDelayedOperationsEarly=function(t){var e=this;return this.drain().then((function(){Br(t===Wi.All||e.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),e.delayedOperations.sort((function(t,e){return t.targetTimeMs-e.targetTimeMs}));for(var n=0,r=e.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),t!==Wi.All&&i.timerId===t)break}return e.drain()}))},Ji.prototype.skipDelaysForTimerId=function(t){this.timerIdsToSkip.push(t)},Ji.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);Br(0<=e,"Delayed operation not found."),this.delayedOperations.splice(e,1)},Ji);function Ji(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}var Zi="";function $i(t){for(var e="",n=0;n<t.length;n++)0<e.length&&(e=eo(e)),e=to(t.get(n),e);return eo(e)}function to(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+="";break;case Zi:n+="";break;default:n+=o}}return n}function eo(t){return t+Zi+""}function no(t){var e=t.length;if(Br(2<=e,"Invalid path "+t),2===e)return Br(t.charAt(0)===Zi&&""===t.charAt(1),"Non-empty path "+t+" had length 2"),qi.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Zi,o);switch((a<0||n<a)&&Vr('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case"":var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case"":i+=t.substring(o,a),i+="\0";break;case"":i+=t.substring(o,a+1);break;default:Vr('Invalid encoded resource path: "'+t+'"')}o=a+2}return new qi(r)}var ro=(io.now=function(){return io.fromMillis(Date.now())},io.fromDate=function(t){return io.fromMillis(t.getTime())},io.fromMillis=function(t){var e=Math.floor(t/1e3);return new io(e,1e6*(t-1e3*e))},io.prototype.toDate=function(){return new Date(this.toMillis())},io.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},io.prototype._compareTo=function(t){return this.seconds===t.seconds?bi(this.nanoseconds,t.nanoseconds):bi(this.seconds,t.seconds)},io.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},io.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},io);function io(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Gr(Wr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Gr(Wr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Gr(Wr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Gr(Wr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}var oo=(ao.fromMicroseconds=function(t){var e=Math.floor(t/1e6);return new ao(new ro(e,t%1e6*1e3))},ao.fromTimestamp=function(t){return new ao(t)},ao.forDeletedDoc=function(){return ao.MIN},ao.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},ao.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},ao.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},ao.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},ao.prototype.toTimestamp=function(){return this.timestamp},ao.MIN=new ao(new ro(0,0)),ao);function ao(t){this.timestamp=t}var so=(uo.prototype.insert=function(t,e){return new uo(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,lo.BLACK,null,null))},uo.prototype.remove=function(t){return new uo(this.comparator,this.root.remove(t,this.comparator).copy(null,null,lo.BLACK,null,null))},uo.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null},uo.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1},uo.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(uo.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),uo.prototype.minKey=function(){return this.root.minKey()},uo.prototype.maxKey=function(){return this.root.maxKey()},uo.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},uo.prototype.forEach=function(t){this.inorderTraversal((function(e,n){return t(e,n),!1}))},uo.prototype.toString=function(){var t=[];return this.inorderTraversal((function(e,n){return t.push(e+":"+n),!1})),"{"+t.join(", ")+"}"},uo.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},uo.prototype.getIterator=function(){return new co(this.root,null,this.comparator,!1)},uo.prototype.getIteratorFrom=function(t){return new co(this.root,t,this.comparator,!1)},uo.prototype.getReverseIterator=function(){return new co(this.root,null,this.comparator,!0)},uo.prototype.getReverseIteratorFrom=function(t){return new co(this.root,t,this.comparator,!0)},uo);function uo(t,e){this.comparator=t,this.root=e||lo.EMPTY}var co=(ho.prototype.getNext=function(){Br(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},ho.prototype.hasNext=function(){return 0<this.nodeStack.length},ho.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},ho);function ho(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}var lo=(fo.prototype.copy=function(t,e,n,r,i){return new fo(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},fo.prototype.isEmpty=function(){return!1},fo.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},fo.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},fo.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},fo.prototype.minKey=function(){return this.min().key},fo.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},fo.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},fo.prototype.removeMin=function(){if(this.left.isEmpty())return fo.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()},fo.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return fo.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()},fo.prototype.isRed=function(){return this.color},fo.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},fo.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},fo.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},fo.prototype.rotateLeft=function(){var t=this.copy(null,null,fo.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},fo.prototype.rotateRight=function(){var t=this.copy(null,null,fo.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},fo.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},fo.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},fo.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Vr("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Vr("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw Vr("Black depths differ");return t+(this.isRed()?0:1)},fo.EMPTY=null,fo.RED=!0,fo.BLACK=!1,fo);function fo(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:fo.RED,this.left=null!=r?r:fo.EMPTY,this.right=null!=i?i:fo.EMPTY,this.size=this.left.size+1+this.right.size}var po=(Object.defineProperty(mo.prototype,"key",{get:function(){throw Vr("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(mo.prototype,"value",{get:function(){throw Vr("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(mo.prototype,"color",{get:function(){throw Vr("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(mo.prototype,"left",{get:function(){throw Vr("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(mo.prototype,"right",{get:function(){throw Vr("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),mo.prototype.copy=function(t,e,n,r,i){return this},mo.prototype.insert=function(t,e,n){return new lo(t,e)},mo.prototype.remove=function(t,e){return this},mo.prototype.isEmpty=function(){return!0},mo.prototype.inorderTraversal=function(t){return!1},mo.prototype.reverseTraversal=function(t){return!1},mo.prototype.minKey=function(){return null},mo.prototype.maxKey=function(){return null},mo.prototype.isRed=function(){return!1},mo.prototype.checkMaxDepth=function(){return!0},mo.prototype.check=function(){return 0},mo);function mo(){this.size=0}lo.EMPTY=new po;var yo=(go.fromMapKeys=function(t){var e=new go(t.comparator);return t.forEach((function(t){e=e.add(t)})),e},go.prototype.has=function(t){return null!==this.data.get(t)},go.prototype.first=function(){return this.data.minKey()},go.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(go.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),go.prototype.indexOf=function(t){return this.data.indexOf(t)},go.prototype.forEach=function(t){this.data.inorderTraversal((function(e,n){return t(e),!1}))},go.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}},go.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},go.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},go.prototype.getIterator=function(){return new vo(this.data.getIterator())},go.prototype.getIteratorFrom=function(t){return new vo(this.data.getIteratorFrom(t))},go.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},go.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},go.prototype.isEmpty=function(){return this.data.isEmpty()},go.prototype.unionWith=function(t){var e=this;return t.forEach((function(t){e=e.add(t)})),e},go.prototype.isEqual=function(t){if(!(t instanceof go))return!1;if(this.size!==t.size)return!1;for(var e=this.data.getIterator(),n=t.data.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},go.prototype.toArray=function(){var t=[];return this.forEach((function(e){t.push(e)})),t},go.prototype.toString=function(){var t=[];return this.forEach((function(e){return t.push(e)})),"SortedSet("+t.toString()+")"},go.prototype.copy=function(t){var e=new go(this.comparator);return e.data=t,e},go);function go(t){this.comparator=t,this.data=new so(this.comparator)}var vo=(bo.prototype.getNext=function(){return this.iter.getNext().key},bo.prototype.hasNext=function(){return this.iter.hasNext()},bo);function bo(t){this.iter=t}var wo=new so(Ki.comparator);function So(){return wo}function To(){return So()}var Eo=new so(Ki.comparator);function Io(){return Eo}var Co=new so(Ki.comparator);function Do(){return Co}var No=new yo(Ki.comparator);function Ao(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=No,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var ko=new yo(bi);function Ro(){return ko}var Mo=(Oo.prototype.applyToRemoteDocument=function(t,e,n){e&&Br(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Br(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){var a=r[i];e=o.applyToRemoteDocument(e,a)}}return e},Oo.prototype.applyToLocalView=function(t,e){e&&Br(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime));for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},Oo.prototype.applyToLocalDocumentSet=function(t){var e=this,n=t;return this.mutations.forEach((function(r){var i=e.applyToLocalView(r.key,t.get(r.key));i&&(n=n.insert(r.key,i))})),n},Oo.prototype.keys=function(){return this.mutations.reduce((function(t,e){return t.add(e.key)}),Ao())},Oo.prototype.isEqual=function(t){return this.batchId===t.batchId&&wi(this.mutations,t.mutations)&&wi(this.baseMutations,t.baseMutations)},Oo);function Oo(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,Br(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}var _o=(Lo.from=function(t,e,n,r){Br(t.mutations.length===n.length,"Mutations sent "+t.mutations.length+" must equal results received "+n.length);for(var i=Do(),o=t.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new Lo(t,e,n,r,i)},Lo);function Lo(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}var Po=(xo.prototype.catch=function(t){return this.next(void 0,t)},xo.prototype.next=function(t,e){var n=this;return this.callbackAttached&&Vr("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new xo((function(r,i){n.nextCallback=function(e){n.wrapSuccess(t,e).next(r,i)},n.catchCallback=function(t){n.wrapFailure(e,t).next(r,i)}}))},xo.prototype.toPromise=function(){var t=this;return new Promise((function(e,n){t.next(e,n)}))},xo.prototype.wrapUserFunction=function(t){try{var e=t();return e instanceof xo?e:xo.resolve(e)}catch(t){return xo.reject(t)}},xo.prototype.wrapSuccess=function(t,e){return t?this.wrapUserFunction((function(){return t(e)})):xo.resolve(e)},xo.prototype.wrapFailure=function(t,e){return t?this.wrapUserFunction((function(){return t(e)})):xo.reject(e)},xo.resolve=function(t){return new xo((function(e,n){e(t)}))},xo.reject=function(t){return new xo((function(e,n){n(t)}))},xo.waitFor=function(t){return new xo((function(e,n){var r=0,i=0,o=!1;t.forEach((function(t){++r,t.next((function(){++i,o&&i===r&&e()}),(function(t){return n(t)}))})),o=!0,i===r&&e()}))},xo.or=function(t){for(var e=xo.resolve(!1),n=function(t){e=e.next((function(e){return e?xo.resolve(e):t()}))},r=0,i=t;r<i.length;r++)n(i[r]);return e},xo.forEach=function(t,e){var n=this,r=[];return t.forEach((function(t,i){r.push(e.call(n,t,i))})),this.waitFor(r)},xo);function xo(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)}),(function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)}))}var qo,Fo,Vo=(Bo.forUser=function(t,e,n,r){return Br(""!==t.uid,"UserID must not be an empty string."),new Bo(t.isAuthenticated()?t.uid:"",e,n,r)},Bo.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return jo(t).iterate({index:lu.userMutationsIndex,range:n},(function(t,n,r){e=!1,r.done()})).next((function(){return e}))},Bo.prototype.acknowledgeBatch=function(t,e,n){return this.getMutationQueueMetadata(t).next((function(e){return e.lastStreamToken=Ko(n),Go(t).put(e)}))},Bo.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next((function(t){return t.lastStreamToken}))},Bo.prototype.setLastStreamToken=function(t,e){return this.getMutationQueueMetadata(t).next((function(n){return n.lastStreamToken=Ko(e),Go(t).put(n)}))},Bo.prototype.addMutationBatch=function(t,e,n,r){var i=this,o=Wo(t),a=jo(t);return a.add({}).next((function(s){Br("number"==typeof s,"Auto-generated key is not a number");for(var u=new Mo(s,e,n,r),c=i.serializer.toDbMutationBatch(i.userId,u),h=[],l=new yo((function(t,e){return bi(t.canonicalString(),e.canonicalString())})),f=0,d=r;f<d.length;f++){var p=d[f],m=du.key(i.userId,p.key.path,s);l=l.add(p.key.path.popLast()),h.push(a.put(c)),h.push(o.put(m,du.PLACEHOLDER))}return l.forEach((function(e){h.push(i.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((function(){i.documentKeysByBatchId[s]=u.keys()})),Po.waitFor(h).next((function(){return u}))}))},Bo.prototype.lookupMutationBatch=function(t,e){var n=this;return jo(t).get(e).next((function(t){return t?(Br(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null}))},Bo.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?Po.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next((function(t){if(t){var r=t.keys();return n.documentKeysByBatchId[e]=r}return null}))},Bo.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this,r=e+1,i=IDBKeyRange.lowerBound([this.userId,r]),o=null;return jo(t).iterate({index:lu.userMutationsIndex,range:i},(function(t,e,i){e.userId===n.userId&&(Br(e.batchId>=r,"Should have found mutation after "+r),o=n.serializer.fromDbMutationBatch(e)),i.done()})).next((function(){return o}))},Bo.prototype.getHighestUnacknowledgedBatchId=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return jo(t).iterate({index:lu.userMutationsIndex,range:e,reverse:!0},(function(t,e,r){n=e.batchId,r.done()})).next((function(){return n}))},Bo.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return jo(t).loadAll(lu.userMutationsIndex,n).next((function(t){return t.map((function(t){return e.serializer.fromDbMutationBatch(t)}))}))},Bo.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=du.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return Wo(t).iterate({range:i},(function(r,i,a){var s=r[0],u=r[1],c=r[2],h=no(u);if(s===n.userId&&e.path.isEqual(h))return jo(t).get(c).next((function(t){if(!t)throw Vr("Dangling document-mutation reference found: "+r+" which points to "+c);Br(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+c),o.push(n.serializer.fromDbMutationBatch(t))}));a.done()})).next((function(){return o}))},Bo.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new yo(bi),i=[];return e.forEach((function(e){var o=du.prefixForPath(n.userId,e.path),a=IDBKeyRange.lowerBound(o),s=Wo(t).iterate({range:a},(function(t,i,o){var a=t[0],s=t[1],u=t[2],c=no(s);a===n.userId&&e.path.isEqual(c)?r=r.add(u):o.done()}));i.push(s)})),Po.waitFor(i).next((function(){return n.lookupMutationBatches(t,r)}))},Bo.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this;Br(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Br(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=e.path,i=r.length+1,o=du.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new yo(bi);return Wo(t).iterate({range:a},(function(t,e,o){var a=t[0],u=t[1],c=t[2],h=no(u);a===n.userId&&r.isPrefixOf(h)?h.length===i&&(s=s.add(c)):o.done()})).next((function(){return n.lookupMutationBatches(t,s)}))},Bo.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach((function(e){i.push(jo(t).get(e).next((function(t){if(null===t)throw Vr("Dangling document-mutation reference found, which points to "+e);Br(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))})))})),Po.waitFor(i).next((function(){return r}))},Bo.prototype.removeMutationBatch=function(t,e){var n=this;return Qo(t.simpleDbTransaction,this.userId,e).next((function(r){return t.addOnCommittedListener((function(){n.removeCachedMutationKeys(e.batchId)})),Po.forEach(r,(function(e){return n.referenceDelegate.removeMutationReference(t,e)}))}))},Bo.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},Bo.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next((function(n){if(!n)return Po.resolve();var r=IDBKeyRange.lowerBound(du.prefixForUser(e.userId)),i=[];return Wo(t).iterate({range:r},(function(t,n,r){if(t[0]===e.userId){var o=no(t[1]);i.push(o)}else r.done()})).next((function(){Br(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map((function(t){return t.canonicalString()})))}))}))},Bo.prototype.containsKey=function(t,e){return Uo(t,this.userId,e)},Bo.prototype.getMutationQueueMetadata=function(t){var e=this;return Go(t).get(this.userId).next((function(t){return t||new cu(e.userId,-1,"")}))},Bo);function Bo(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function Uo(t,e,n){var r=du.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return Wo(t).iterate({range:o,keysOnly:!0},(function(t,n,r){var o=t[0],s=t[1];t[2],o===e&&s===i&&(a=!0),r.done()})).next((function(){return a}))}function Qo(t,e,n){var r=t.store(lu.store),i=t.store(du.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},(function(t,e,n){return s++,n.delete()}));o.push(u.next((function(){Br(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)})));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],d=du.key(e,f.key.path,n.batchId);o.push(i.delete(d)),c.push(f.key)}return Po.waitFor(o).next((function(){return c}))}function Ko(t){return t instanceof Uint8Array?(Br("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function jo(t){return ac.getStore(t,lu.store)}function Wo(t){return ac.getStore(t,du.store)}function Go(t){return ac.getStore(t,cu.store)}(Fo=qo=qo||{})[Fo.QueryCache=0]="QueryCache",Fo[Fo.SyncEngine=1]="SyncEngine";var zo=(Ho.prototype.next=function(){var t=this.nextId;return this.nextId+=2,t},Ho.prototype.after=function(t){return this.seek(t+2),this.next()},Ho.prototype.seek=function(t){Br((1&t)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},Ho.forQueryCache=function(){return new Ho(qo.QueryCache,2)},Ho.forSyncEngine=function(){return new Ho(qo.SyncEngine)},Ho);function Ho(t,e){Br((1&(this.generatorId=t))===t,"Generator ID "+t+" contains more than 1 reserved bits"),this.seek(void 0!==e?e:this.generatorId)}var Yo="SimpleDb",Xo=(Jo.openOrCreate=function(t,e,n){return Br(Jo.isAvailable(),"IndexedDB not supported in current environment."),xr(Yo,"Opening database:",t),new Po((function(r,i){var o=window.indexedDB.open(t,e);o.onsuccess=function(t){var e=t.target.result;r(new Jo(e))},o.onblocked=function(){i(new Gr(Wr.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},o.onerror=function(t){var e=t.target.error;"VersionError"===e.name?i(new Gr(Wr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):i(e)},o.onupgradeneeded=function(e){xr(Yo,'Database "'+t+'" requires upgrade from version:',e.oldVersion);var r=e.target.result;n.createOrUpgrade(r,o.transaction,e.oldVersion,ru).next((function(){xr(Yo,"Database upgrade to version "+ru+" complete")}))}})).toPromise()},Jo.delete=function(t){return xr(Yo,"Removing database:",t),ia(window.indexedDB.deleteDatabase(t)).toPromise()},Jo.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var t=p(),e=Jo.getIOSVersion(t),n=0<e&&e<10,r=Jo.getAndroidVersion(t),i=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||i)},Jo.getStore=function(t,e){return t.store(e)},Jo.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)},Jo.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},Jo.prototype.setVersionChangeListener=function(t){this.db.onversionchange=function(e){return t(e)}},Jo.prototype.runTransaction=function(t,e,n){return a(this,void 0,void 0,(function(){var r,i,o,a,u,c;return s(this,(function(h){switch(h.label){case 0:r=t.startsWith("readonly"),i=t.endsWith("idempotent"),o=0,a=function(){var t,a,c,h;return s(this,(function(s){switch(s.label){case 0:++o,t=ta.open(u.db,r?"readonly":"readwrite",e),s.label=1;case 1:return s.trys.push([1,3,,4]),(a=n(t).catch((function(e){return t.abort(e),Po.reject(e)})).toPromise()).catch((function(){})),[4,t.completionPromise];case 2:return s.sent(),[2,{value:a}];case 3:return c=s.sent(),h=i&&function(t){return"undefined"!=typeof DOMException&&t instanceof DOMException||"DOMException"===t.constructor.name}(c)&&o<3,xr("Transaction failed with error: %s. Retrying: %s.",c.message,h),h?[3,4]:[2,{value:Promise.reject(c)}];case 4:return[2]}}))},u=this,h.label=1;case 1:return[5,a()];case 2:return"object"==typeof(c=h.sent())?[2,c.value]:[3,1];case 3:return[2]}}))}))},Jo.prototype.close=function(){this.db.close()},Jo);function Jo(t){this.db=t,12.2===Jo.getIOSVersion(p())&&qr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var Zo=(Object.defineProperty($o.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty($o.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty($o.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),$o.prototype.done=function(){this.shouldStop=!0},$o.prototype.skip=function(t){this.nextKey=t},$o.prototype.delete=function(){return ia(this.dbCursor.delete())},$o);function $o(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}var ta=(ea.open=function(t,e,n){return new ea(t.transaction(n,e))},Object.defineProperty(ea.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),ea.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(xr(Yo,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},ea.prototype.store=function(t){var e=this.transaction.objectStore(t);return Br(!!e,"Object store not part of transaction: "+t),new na(e)},ea);function ea(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new zi,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){var n=aa(t.target.error);e.completionDeferred.reject(n)}}var na=(ra.prototype.put=function(t,e){return ia(void 0!==e?(xr(Yo,"PUT",this.store.name,t,e),this.store.put(e,t)):(xr(Yo,"PUT",this.store.name,"<auto-key>",t),this.store.put(t)))},ra.prototype.add=function(t){return xr(Yo,"ADD",this.store.name,t,t),ia(this.store.add(t))},ra.prototype.get=function(t){var e=this;return ia(this.store.get(t)).next((function(n){return void 0===n&&(n=null),xr(Yo,"GET",e.store.name,t,n),n}))},ra.prototype.delete=function(t){return xr(Yo,"DELETE",this.store.name,t),ia(this.store.delete(t))},ra.prototype.count=function(){return xr(Yo,"COUNT",this.store.name),ia(this.store.count())},ra.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,(function(t,e){r.push(e)})).next((function(){return r}))},ra.prototype.deleteAll=function(t,e){xr(Yo,"DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,(function(t,e,n){return n.delete()}))},ra.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},ra.prototype.iterateSerial=function(t){var e=this.cursor({});return new Po((function(n,r){e.onerror=function(t){var e=aa(t.target.error);r(e)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next((function(t){t?r.continue():n()})):n()}}))},ra.prototype.iterateCursor=function(t,e){var n=[];return new Po((function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new Zo(i),a=e(i.primaryKey,i.value,o);if(a instanceof Po){var s=a.catch((function(t){return o.done(),Po.reject(t)}));n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}})).next((function(){return Po.waitFor(n)}))},ra.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Br(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},ra.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},ra);function ra(t){this.store=t}function ia(t){return new Po((function(e,n){t.onsuccess=function(t){var n=t.target.result;e(n)},t.onerror=function(t){var e=aa(t.target.error);n(e)}}))}var oa=!1;function aa(t){var e=Xo.getIOSVersion(p());if(12.2<=e&&e<13){var n="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(n)){var r=new Gr("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return oa||(oa=!0,setTimeout((function(){throw r}),0)),r}}return t}var sa=(ua.prototype.allocateTargetId=function(t){var e=this;return this.retrieveMetadata(t).next((function(n){return n.highestTargetId=e.targetIdGenerator.after(n.highestTargetId),e.saveMetadata(t,n).next((function(){return n.highestTargetId}))}))},ua.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next((function(t){return oo.fromTimestamp(new ro(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))}))},ua.prototype.getHighestSequenceNumber=function(t){return la(t.simpleDbTransaction)},ua.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.retrieveMetadata(t).next((function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.saveMetadata(t,i)}))},ua.prototype.addQueryData=function(t,e){var n=this;return this.saveQueryData(t,e).next((function(){return n.retrieveMetadata(t).next((function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(e,r),n.saveMetadata(t,r)}))}))},ua.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},ua.prototype.removeQueryData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next((function(){return ca(t).delete(e.targetId)})).next((function(){return n.retrieveMetadata(t)})).next((function(e){return Br(0<e.targetCount,"Removing from an empty query cache"),e.targetCount-=1,n.saveMetadata(t,e)}))},ua.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return ca(t).iterate((function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=e&&null===n.get(u.targetId)&&(i++,o.push(r.removeQueryData(t,u)))})).next((function(){return Po.waitFor(o)})).next((function(){return i}))},ua.prototype.forEachTarget=function(t,e){var n=this;return ca(t).iterate((function(t,r){var i=n.serializer.fromDbTarget(r);e(i)}))},ua.prototype.retrieveMetadata=function(t){return ha(t.simpleDbTransaction)},ua.prototype.saveMetadata=function(t,e){return function(t){return ac.getStore(t,Cu.store)}(t).put(Cu.key,e)},ua.prototype.saveQueryData=function(t,e){return ca(t).put(this.serializer.toDbTarget(e))},ua.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},ua.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next((function(t){return t.targetCount}))},ua.prototype.getQueryData=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return ca(t).iterate({range:i,index:Su.queryTargetsIndexName},(function(t,r,i){var a=n.serializer.fromDbTarget(r);e.isEqual(a.query)&&(o=a,i.done())})).next((function(){return o}))},ua.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=fa(t);return e.forEach((function(e){var a=$i(e.path);i.push(o.put(new Eu(n,a))),i.push(r.referenceDelegate.addReference(t,e))})),Po.waitFor(i)},ua.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=fa(t);return Po.forEach(e,(function(e){var o=$i(e.path);return Po.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,e)])}))},ua.prototype.removeMatchingKeysForTargetId=function(t,e){var n=fa(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},ua.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=fa(t),i=Ao();return r.iterate({range:n,keysOnly:!0},(function(t,e,n){var r=no(t[1]),o=new Ki(r);i=i.add(o)})).next((function(){return i}))},ua.prototype.containsKey=function(t,e){var n=$i(e.path),r=IDBKeyRange.bound([n],[Si(n)],!1,!0),i=0;return fa(t).iterate({index:Eu.documentTargetsIndex,keysOnly:!0,range:r},(function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())})).next((function(){return 0<i}))},ua.prototype.getQueryDataForTarget=function(t,e){var n=this;return ca(t).get(e).next((function(t){return t?n.serializer.fromDbTarget(t):null}))},ua);function ua(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=zo.forQueryCache()}function ca(t){return ac.getStore(t,Su.store)}function ha(t){return Xo.getStore(t,Cu.store).get(Cu.key).next((function(t){return Br(null!==t,"Missing metadata row."),t}))}function la(t){return ha(t).next((function(t){return t.highestListenSequenceNumber}))}function fa(t){return ac.getStore(t,Eu.store)}var da=(pa.fromSet=function(t){return new pa(t)},pa.fromArray=function(t){var e=new yo(Ui.comparator);return t.forEach((function(t){return e=e.add(t)})),new pa(e)},pa.prototype.covers=function(t){var e=!1;return this.fields.forEach((function(n){n.isPrefixOf(t)&&(e=!0)})),e},pa.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},pa);function pa(t){this.fields=t}var ma=(ya.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},ya);function ya(t,e){this.field=t,this.transform=e}var ga,va,ba=function(t,e){this.version=t,this.transformResults=e};(va=ga=ga||{})[va.Set=0]="Set",va[va.Patch=1]="Patch",va[va.Transform=2]="Transform",va[va.Delete=3]="Delete";var wa=(Sa.exists=function(t){return new Sa(void 0,t)},Sa.updateTime=function(t){return new Sa(t)},Object.defineProperty(Sa.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),Sa.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof _s&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof _s:(Br(this.isNone,"Precondition should be empty"),!0)},Sa.prototype.isEqual=function(t){return function(t,e){return null!=t?!(!e||!t.isEqual(e)):t===e}(this.updateTime,t.updateTime)&&this.exists===t.exists},Sa.NONE=new Sa,Sa);function Sa(t,e){this.updateTime=t,this.exists=e,Br(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}var Ta=(Ea.prototype.verifyKeyMatches=function(t){null!=t&&Br(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},Ea.getPostMutationVersion=function(t){return t instanceof _s?t.version:oo.MIN},Ea);function Ea(){}var Ia,Ca=(n(Da,Ia=Ta),Da.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),Br(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new _s(this.key,n,{hasCommittedMutations:!0},this.value)},Da.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ta.getPostMutationVersion(t);return new _s(this.key,r,{hasLocalMutations:!0},this.value)},Da.prototype.extractBaseValue=function(t){return null},Da.prototype.isEqual=function(t){return t instanceof Da&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},Da);function Da(t,e,n){var r=Ia.call(this)||this;return r.key=t,r.value=e,r.precondition=n,r.type=ga.Set,r}var Na,Aa=(n(ka,Na=Ta),ka.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Br(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new Vs(this.key,e.version);var n=this.patchDocument(t);return new _s(this.key,e.version,{hasCommittedMutations:!0},n)},ka.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ta.getPostMutationVersion(t),i=this.patchDocument(t);return new _s(this.key,r,{hasLocalMutations:!0},i)},ka.prototype.extractBaseValue=function(t){return null},ka.prototype.isEqual=function(t){return t instanceof ka&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},ka.prototype.patchDocument=function(t){var e;return e=t instanceof _s?t.data():Cs.EMPTY,this.patchObject(e)},ka.prototype.patchObject=function(t){var e=this;return this.fieldMask.fields.forEach((function(n){if(!n.isEmpty()){var r=e.data.field(n);t=null!==r?t.set(n,r):t.delete(n)}})),t},ka);function ka(t,e,n,r){var i=Na.call(this)||this;return i.key=t,i.data=e,i.fieldMask=n,i.precondition=r,i.type=ga.Patch,i}var Ra,Ma=(n(Oa,Ra=Ta),Oa.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Br(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new Vs(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data(),r);return new _s(this.key,i,{hasCommittedMutations:!0},o)},Oa.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,t,e),o=this.transformObject(r.data(),i);return new _s(this.key,r.version,{hasLocalMutations:!0},o)},Oa.prototype.extractBaseValue=function(t){for(var e=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],o=t instanceof _s?t.field(i.field):void 0,a=i.transform.computeBaseValue(o||null);null!=a&&(e=null==e?Cs.EMPTY.set(i.field,a):e.set(i.field,a))}return e},Oa.prototype.isEqual=function(t){return t instanceof Oa&&this.key.isEqual(t.key)&&wi(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},Oa.prototype.requireDocument=function(t){Br(t instanceof _s,"Unknown MaybeDocument type "+t);var e=t;return Br(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},Oa.prototype.serverTransformResults=function(t,e){var n=[];Br(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof _s&&(a=t.field(i.field)),n.push(o.applyToRemoteDocument(a,e[r]))}return n},Oa.prototype.localTransformResults=function(t,e,n){for(var r=[],i=0,o=this.fieldTransforms;i<o.length;i++){var a=o[i],s=a.transform,u=null;e instanceof _s&&(u=e.field(a.field)),null===u&&n instanceof _s&&(u=n.field(a.field)),r.push(s.applyToLocalView(u,t))}return r},Oa.prototype.transformObject=function(t,e){Br(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},Oa);function Oa(t,e){var n=Ra.call(this)||this;return n.key=t,n.fieldTransforms=e,n.type=ga.Transform,n.precondition=wa.exists(!0),n}var _a,La,Pa,xa,qa,Fa=(n(Va,_a=Ta),Va.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Br(null==e.transformResults,"Transform results received by DeleteMutation."),new xs(this.key,e.version,{hasCommittedMutations:!0})},Va.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Br(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new xs(this.key,oo.forDeletedDoc())):t},Va.prototype.extractBaseValue=function(t){return null},Va.prototype.isEqual=function(t){return t instanceof Va&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Va);function Va(t,e){var n=_a.call(this)||this;return n.key=t,n.precondition=e,n.type=ga.Delete,n}(Pa=La=La||{})[Pa.NullValue=0]="NullValue",Pa[Pa.BooleanValue=1]="BooleanValue",Pa[Pa.NumberValue=2]="NumberValue",Pa[Pa.TimestampValue=3]="TimestampValue",Pa[Pa.StringValue=4]="StringValue",Pa[Pa.BlobValue=5]="BlobValue",Pa[Pa.RefValue=6]="RefValue",Pa[Pa.GeoPointValue=7]="GeoPointValue",Pa[Pa.ArrayValue=8]="ArrayValue",Pa[Pa.ObjectValue=9]="ObjectValue",(qa=xa=xa||{})[qa.Default=0]="Default",qa[qa.Estimate=1]="Estimate",qa[qa.Previous=2]="Previous";var Ba=(Ua.fromSnapshotOptions=function(t,e){switch(t.serverTimestamps){case"estimate":return new Ua(xa.Estimate,e);case"previous":return new Ua(xa.Previous,e);case"none":case void 0:return new Ua(xa.Default,e);default:return Vr("fromSnapshotOptions() called with invalid options.")}},Ua);function Ua(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}var Qa=(Ka.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},Ka.prototype.defaultCompareTo=function(t){return Br(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),bi(this.typeOrder,t.typeOrder)},Ka);function Ka(){}var ja,Wa=(n(Ga,ja=Qa),Ga.prototype.value=function(t){return null},Ga.prototype.isEqual=function(t){return t instanceof Ga},Ga.prototype.compareTo=function(t){return t instanceof Ga?0:this.defaultCompareTo(t)},Ga.INSTANCE=new Ga,Ga);function Ga(){var t=ja.call(this)||this;return t.typeOrder=La.NullValue,t.internalValue=null,t}var za,Ha=(n(Ya,za=Qa),Ya.prototype.value=function(t){return this.internalValue},Ya.prototype.isEqual=function(t){return t instanceof Ya&&this.internalValue===t.internalValue},Ya.prototype.compareTo=function(t){return t instanceof Ya?bi(this,t):this.defaultCompareTo(t)},Ya.of=function(t){return t?Ya.TRUE:Ya.FALSE},Ya.TRUE=new Ya(!0),Ya.FALSE=new Ya(!1),Ya);function Ya(t){var e=za.call(this)||this;return e.internalValue=t,e.typeOrder=La.BooleanValue,e}var Xa,Ja=(n(Za,Xa=Qa),Za.prototype.value=function(t){return this.internalValue},Za.prototype.compareTo=function(t){return t instanceof Za?function(t,e){return t<e?-1:e<t?1:t===e?0:isNaN(t)?isNaN(e)?0:-1:1}(this.internalValue,t.internalValue):this.defaultCompareTo(t)},Za);function Za(t){var e=Xa.call(this)||this;return e.internalValue=t,e.typeOrder=La.NumberValue,e}function $a(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var ts,es=(n(ns,ts=Ja),ns.prototype.isEqual=function(t){return t instanceof ns&&$a(this.internalValue,t.internalValue)},ns);function ns(){return null!==ts&&ts.apply(this,arguments)||this}var rs,is=(n(os,rs=Ja),os.prototype.isEqual=function(t){return t instanceof os&&$a(this.internalValue,t.internalValue)},os.NAN=new os(NaN),os.POSITIVE_INFINITY=new os(1/0),os.NEGATIVE_INFINITY=new os(-1/0),os);function os(){return null!==rs&&rs.apply(this,arguments)||this}var as,ss=(n(us,as=Qa),us.prototype.value=function(t){return this.internalValue},us.prototype.isEqual=function(t){return t instanceof us&&this.internalValue===t.internalValue},us.prototype.compareTo=function(t){return t instanceof us?bi(this.internalValue,t.internalValue):this.defaultCompareTo(t)},us);function us(t){var e=as.call(this)||this;return e.internalValue=t,e.typeOrder=La.StringValue,e}var cs,hs=(n(ls,cs=Qa),ls.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},ls.prototype.isEqual=function(t){return t instanceof ls&&this.internalValue.isEqual(t.internalValue)},ls.prototype.compareTo=function(t){return t instanceof ls?this.internalValue._compareTo(t.internalValue):t instanceof ds?-1:this.defaultCompareTo(t)},ls);function ls(t){var e=cs.call(this)||this;return e.internalValue=t,e.typeOrder=La.TimestampValue,e}var fs,ds=(n(ps,fs=Qa),ps.prototype.value=function(t){return t&&t.serverTimestampBehavior===xa.Estimate?new hs(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===xa.Previous&&this.previousValue?this.previousValue.value(t):null},ps.prototype.isEqual=function(t){return t instanceof ps&&this.localWriteTime.isEqual(t.localWriteTime)},ps.prototype.compareTo=function(t){return t instanceof ps?this.localWriteTime._compareTo(t.localWriteTime):t instanceof hs?1:this.defaultCompareTo(t)},ps.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},ps);function ps(t,e){var n=fs.call(this)||this;return n.localWriteTime=t,n.previousValue=e,n.typeOrder=La.TimestampValue,n}var ms,ys=(n(gs,ms=Qa),gs.prototype.value=function(t){return this.internalValue},gs.prototype.isEqual=function(t){return t instanceof gs&&this.internalValue.isEqual(t.internalValue)},gs.prototype.compareTo=function(t){return t instanceof gs?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},gs);function gs(t){var e=ms.call(this)||this;return e.internalValue=t,e.typeOrder=La.BlobValue,e}var vs,bs=(n(ws,vs=Qa),ws.prototype.value=function(t){return this.key},ws.prototype.isEqual=function(t){return t instanceof ws&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},ws.prototype.compareTo=function(t){if(t instanceof ws){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:Ki.comparator(this.key,t.key)}return this.defaultCompareTo(t)},ws);function ws(t,e){var n=vs.call(this)||this;return n.databaseId=t,n.key=e,n.typeOrder=La.RefValue,n}var Ss,Ts=(n(Es,Ss=Qa),Es.prototype.value=function(t){return this.internalValue},Es.prototype.isEqual=function(t){return t instanceof Es&&this.internalValue.isEqual(t.internalValue)},Es.prototype.compareTo=function(t){return t instanceof Es?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},Es);function Es(t){var e=Ss.call(this)||this;return e.internalValue=t,e.typeOrder=La.GeoPointValue,e}var Is,Cs=(n(Ds,Is=Qa),Ds.prototype.value=function(t){var e={};return this.internalValue.inorderTraversal((function(n,r){e[n]=r.value(t)})),e},Ds.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},Ds.prototype.isEqual=function(t){if(t instanceof Ds){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!e.hasNext()&&!n.hasNext()}return!1},Ds.prototype.compareTo=function(t){if(t instanceof Ds){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext(),o=bi(r.key,i.key)||r.value.compareTo(i.value);if(o)return o}return bi(e.hasNext(),n.hasNext())}return this.defaultCompareTo(t)},Ds.prototype.set=function(t,e){if(Br(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var n=this.child(t.firstSegment());n instanceof Ds||(n=Ds.EMPTY);var r=n.set(t.popFirst(),e);return this.setChild(t.firstSegment(),r)},Ds.prototype.delete=function(t){if(Br(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new Ds(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof Ds){var n=e.delete(t.popFirst());return new Ds(this.internalValue.insert(t.firstSegment(),n))}return this},Ds.prototype.contains=function(t){return null!==this.field(t)},Ds.prototype.field=function(t){Br(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach((function(t){e=e instanceof Ds?e.internalValue.get(t):null})),e},Ds.prototype.fieldMask=function(){var t=new yo(Ui.comparator);return this.internalValue.forEach((function(e,n){var r=new Ui([e]);if(n instanceof Ds){var i=n.fieldMask().fields;i.isEmpty()?t=t.add(r):i.forEach((function(e){t=t.add(r.child(e))}))}else t=t.add(r)})),da.fromSet(t)},Ds.prototype.toString=function(){return this.internalValue.toString()},Ds.prototype.child=function(t){return this.internalValue.get(t)||void 0},Ds.prototype.setChild=function(t,e){return new Ds(this.internalValue.insert(t,e))},Ds.EMPTY=new Ds(new so(bi)),Ds);function Ds(t){var e=Is.call(this)||this;return e.internalValue=t,e.typeOrder=La.ObjectValue,e}var Ns,As=(n(ks,Ns=Qa),ks.prototype.value=function(t){return this.internalValue.map((function(e){return e.value(t)}))},ks.prototype.contains=function(t){for(var e=0,n=this.internalValue;e<n.length;e++)if(n[e].isEqual(t))return!0;return!1},ks.prototype.forEach=function(t){this.internalValue.forEach(t)},ks.prototype.isEqual=function(t){if(t instanceof ks){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},ks.prototype.compareTo=function(t){if(t instanceof ks){for(var e=Math.min(this.internalValue.length,t.internalValue.length),n=0;n<e;n++){var r=this.internalValue[n].compareTo(t.internalValue[n]);if(r)return r}return bi(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},ks.prototype.toString=function(){return"["+this.internalValue.map((function(t){return t.toString()})).join(",")+"]"},ks);function ks(t){var e=Ns.call(this)||this;return e.internalValue=t,e.typeOrder=La.ArrayValue,e}var Rs=(Ms.compareByKey=function(t,e){return Ki.comparator(t.key,e.key)},Ms);function Ms(t,e){this.key=t,this.version=e}var Os,_s=(n(Ls,Os=Rs),Ls.prototype.field=function(t){if(this.objectValue)return this.objectValue.field(t);this.fieldValueCache||(this.fieldValueCache=new Map);var e=t.canonicalString(),n=this.fieldValueCache.get(e);if(void 0===n){var r=this.getProtoField(t);n=void 0===r?null:this.converter(r),this.fieldValueCache.set(e,n)}return n},Ls.prototype.data=function(){var t=this;if(!this.objectValue){var e=Cs.EMPTY;Zr(this.proto.fields||{},(function(n,r){e=e.set(new Ui([n]),t.converter(r))})),this.objectValue=e,this.fieldValueCache=void 0}return this.objectValue},Ls.prototype.value=function(){return this.data().value()},Ls.prototype.isEqual=function(t){return t instanceof Ls&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},Ls.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(Ls.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),Ls.prototype.getProtoField=function(t){Br(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var e=this.proto.fields?this.proto.fields[t.firstSegment()]:void 0,n=1;n<t.length;++n){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(n)]}return e},Ls.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return null!==r&&null!==i?r.compareTo(i):Vr("Trying to compare documents on fields that don't exist")},Ls);function Ls(t,e,n,r,i,o){var a=Os.call(this,t,e)||this;return a.objectValue=r,a.proto=i,a.converter=o,Br(void 0!==a.objectValue||void 0!==a.proto&&void 0!==a.converter,"If objectValue is not defined, proto and converter need to be set."),a.hasLocalMutations=!!n.hasLocalMutations,a.hasCommittedMutations=!!n.hasCommittedMutations,a}var Ps,xs=(n(qs,Ps=Rs),qs.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(qs.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),qs.prototype.isEqual=function(t){return t instanceof qs&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},qs);function qs(t,e,n){var r=Ps.call(this,t,e)||this;return r.hasCommittedMutations=!(!n||!n.hasCommittedMutations),r}var Fs,Vs=(n(Bs,Fs=Rs),Bs.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(Bs.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),Bs.prototype.isEqual=function(t){return t instanceof Bs&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Bs);function Bs(){return null!==Fs&&Fs.apply(this,arguments)||this}var Us=(Qs.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(t))return s}},Qs.prototype.has=function(t){return void 0!==this.get(t)},Qs.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},Qs.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},Qs.prototype.forEach=function(t){Zr(this.inner,(function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];t(a,s)}}))},Qs.prototype.isEmpty=function(){return $r(this.inner)},Qs);function Qs(t){this.mapKeyFn=t,this.inner={}}var Ks=(Object.defineProperty(js.prototype,"readTime",{get:function(){return Br(void 0!==this._readTime,"Read time is not set. All removeEntry() calls must include a readTime if `trackRemovals` is used."),this._readTime},set:function(t){Br(void 0===this._readTime||this._readTime.isEqual(t),"All changes in a RemoteDocumentChangeBuffer must have the same read time"),this._readTime=t},enumerable:!0,configurable:!0}),js.prototype.addEntry=function(t,e){this.assertNotApplied(),this.readTime=e,this.changes.set(t.key,t)},js.prototype.removeEntry=function(t,e){this.assertNotApplied(),e&&(this.readTime=e),this.changes.set(t,null)},js.prototype.getEntry=function(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?Po.resolve(n):this.getFromCache(t,e)},js.prototype.getEntries=function(t,e){return this.getAllFromCache(t,e)},js.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},js.prototype.assertNotApplied=function(){Br(!this.changesApplied,"Changes have already been applied.")},js);function js(){this.changes=new Us((function(t){return t.toString()})),this.changesApplied=!1}var Ws,Gs=(zs.prototype.addEntry=function(t,e,n){return Xs(t).put(Js(e),n)},zs.prototype.removeEntry=function(t,e){var n=Xs(t),r=Js(e);return n.delete(r)},zs.prototype.updateMetadata=function(t,e){var n=this;return this.getMetadata(t).next((function(r){return r.byteSize+=e,n.setMetadata(t,r)}))},zs.prototype.getEntry=function(t,e){var n=this;return Xs(t).get(Js(e)).next((function(t){return n.maybeDecodeDocument(t)}))},zs.prototype.getSizedEntry=function(t,e){var n=this;return Xs(t).get(Js(e)).next((function(t){var e=n.maybeDecodeDocument(t);return e?{maybeDocument:e,size:Zs(t)}:null}))},zs.prototype.getEntries=function(t,e){var n=this,r=To();return this.forEachDbEntry(t,e,(function(t,e){var i=n.maybeDecodeDocument(e);r=r.insert(t,i)})).next((function(){return r}))},zs.prototype.getSizedEntries=function(t,e){var n=this,r=To(),i=new so(Ki.comparator);return this.forEachDbEntry(t,e,(function(t,e){var o=n.maybeDecodeDocument(e);i=o?(r=r.insert(t,o),i.insert(t,Zs(e))):(r=r.insert(t,null),i.insert(t,0))})).next((function(){return{maybeDocuments:r,sizeMap:i}}))},zs.prototype.forEachDbEntry=function(t,e,n){if(e.isEmpty())return Po.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return Xs(t).iterate({range:r},(function(t,e,r){for(var a=Ki.fromSegments(t);o&&Ki.comparator(o,a)<0;)n(o,null),o=i.getNext();o&&o.isEqual(a)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()})).next((function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))},zs.prototype.getDocumentsMatchingQuery=function(t,e,n){var r=this;Br(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var i=Io(),o=e.path.length+1,a={};if(n.isEqual(oo.MIN)){var s=e.path.toArray();a.range=IDBKeyRange.lowerBound(s)}else{var u=e.path.toArray(),c=this.serializer.toDbTimestampKey(n);a.range=IDBKeyRange.lowerBound([u,c],!0),a.index=gu.collectionReadTimeIndex}return Xs(t).iterate(a,(function(t,n,a){if(t.length===o){var s=r.serializer.fromDbRemoteDocument(n);e.path.isPrefixOf(s.key.path)?s instanceof _s&&e.matches(s)&&(i=i.insert(s.key,s)):a.done()}})).next((function(){return i}))},zs.prototype.getNewDocumentChanges=function(t,e){var n=this,r=So(),i=this.serializer.toDbTimestampKey(e),o=Xs(t),a=IDBKeyRange.lowerBound(i,!0);return o.iterate({index:gu.readTimeIndex,range:a},(function(t,e){var o=n.serializer.fromDbRemoteDocument(e);r=r.insert(o.key,o),i=e.readTime})).next((function(){return{changedDocs:r,readTime:n.serializer.fromDbTimestampKey(i)}}))},zs.prototype.getLastDocumentChange=function(t){var e,n=this,r=Xs(t),i=oo.MIN;return r.iterate({index:gu.readTimeIndex,reverse:!0},(function(t,r,o){e=n.serializer.fromDbRemoteDocument(r),r.readTime&&(i=n.serializer.fromDbTimestampKey(r.readTime)),o.done()})).next((function(){return{changedDoc:e,readTime:i}}))},zs.prototype.newChangeBuffer=function(t){return new zs.RemoteDocumentChangeBuffer(this,!!t&&t.trackRemovals)},zs.prototype.getSize=function(t){return this.getMetadata(t).next((function(t){return t.byteSize}))},zs.prototype.getMetadata=function(t){return Ys(t).get(bu.key).next((function(t){return Br(!!t,"Missing document cache metadata"),t}))},zs.prototype.setMetadata=function(t,e){return Ys(t).put(bu.key,e)},zs.prototype.maybeDecodeDocument=function(t){if(t){var e=this.serializer.fromDbRemoteDocument(t);return e instanceof xs&&e.version.isEqual(oo.forDeletedDoc())?null:e}return null},zs.RemoteDocumentChangeBuffer=(n(Hs,Ws=Ks),Hs.prototype.applyChanges=function(t){var e=this,n=[],r=0,i=new yo((function(t,e){return bi(t.canonicalString(),e.canonicalString())}));return this.changes.forEach((function(o,a){var s=e.documentSizes.get(o);if(Br(void 0!==s,"Cannot modify a document that wasn't read (for "+o+")"),a){Br(!e.readTime.isEqual(oo.MIN),"Cannot add a document with a read time of zero");var u=e.documentCache.serializer.toDbRemoteDocument(a,e.readTime);i=i.add(o.path.popLast());var c=Zs(u);r+=c-s,n.push(e.documentCache.addEntry(t,o,u))}else if(r-=s,e.trackRemovals){var h=e.documentCache.serializer.toDbRemoteDocument(new xs(o,oo.forDeletedDoc()),e.readTime);n.push(e.documentCache.addEntry(t,o,h))}else n.push(e.documentCache.removeEntry(t,o))})),i.forEach((function(r){n.push(e.documentCache.indexManager.addToCollectionParentIndex(t,r))})),n.push(this.documentCache.updateMetadata(t,r)),Po.waitFor(n)},Hs.prototype.getFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntry(t,e).next((function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)}))},Hs.prototype.getAllFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntries(t,e).next((function(t){var e=t.maybeDocuments;return t.sizeMap.forEach((function(t,e){n.documentSizes.set(t,e)})),e}))},Hs),zs);function zs(t,e){this.serializer=t,this.indexManager=e}function Hs(t,e){var n=Ws.call(this)||this;return n.documentCache=t,n.trackRemovals=e,n.documentSizes=new Us((function(t){return t.toString()})),n}function Ys(t){return ac.getStore(t,bu.store)}function Xs(t){return ac.getStore(t,gu.store)}function Js(t){return t.path.toArray()}function Zs(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Vr("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var $s=(tu.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),Po.resolve()},tu.prototype.getCollectionParents=function(t,e){return Po.resolve(this.collectionParentIndex.getEntries(e))},tu);function tu(){this.collectionParentIndex=new eu}var eu=(nu.prototype.add=function(t){Br(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new yo(qi.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},nu.prototype.has=function(t){var e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)},nu.prototype.getEntries=function(t){return(this.index[t]||new yo(qi.comparator)).toArray()},nu);function nu(){this.index={}}var ru=9,iu=(ou.prototype.createOrUpgrade=function(t,e,n,r){var i=this;Br(n<r&&0<=n&&r<=ru,"Unexpected schema upgrade from v"+n+" to v{toVersion}.");var o=new ta(e);n<1&&1<=r&&(function(t){t.createObjectStore(su.store)}(t),function(t){t.createObjectStore(cu.store,{keyPath:cu.keyPath}),t.createObjectStore(lu.store,{keyPath:lu.keyPath,autoIncrement:!0}).createIndex(lu.userMutationsIndex,lu.userMutationsKeyPath,{unique:!0}),t.createObjectStore(du.store)}(t),ku(t),function(t){t.createObjectStore(gu.store)}(t));var a=Po.resolve();return n<3&&3<=r&&(0!==n&&(function(t){t.deleteObjectStore(Eu.store),t.deleteObjectStore(Su.store),t.deleteObjectStore(Cu.store)}(t),ku(t)),a=a.next((function(){return function(t){var e=t.store(Cu.store),n=new Cu(0,0,oo.MIN.toTimestamp(),0);return e.put(Cu.key,n)}(o)}))),n<4&&4<=r&&(0!==n&&(a=a.next((function(){return function(t,e){return e.store(lu.store).loadAll().next((function(n){t.deleteObjectStore(lu.store),t.createObjectStore(lu.store,{keyPath:lu.keyPath,autoIncrement:!0}).createIndex(lu.userMutationsIndex,lu.userMutationsKeyPath,{unique:!0});var r=e.store(lu.store),i=n.map((function(t){return r.put(t)}));return Po.waitFor(i)}))}(t,o)}))),a=a.next((function(){!function(t){t.createObjectStore(Ru.store,{keyPath:Ru.keyPath})}(t)}))),n<5&&5<=r&&(a=a.next((function(){return i.removeAcknowledgedMutations(o)}))),n<6&&6<=r&&(a=a.next((function(){return function(t){t.createObjectStore(bu.store)}(t),i.addDocumentGlobal(o)}))),n<7&&7<=r&&(a=a.next((function(){return i.ensureSequenceNumbers(o)}))),n<8&&8<=r&&(a=a.next((function(){return i.createCollectionParentIndex(t,o)}))),n<9&&9<=r&&(a=a.next((function(){!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){var e=t.objectStore(gu.store);e.createIndex(gu.readTimeIndex,gu.readTimeIndexPath,{unique:!1}),e.createIndex(gu.collectionReadTimeIndex,gu.collectionReadTimeIndexPath,{unique:!1})}(e)}))),a},ou.prototype.addDocumentGlobal=function(t){var e=0;return t.store(gu.store).iterate((function(t,n){e+=Zs(n)})).next((function(){var n=new bu(e);return t.store(bu.store).put(bu.key,n)}))},ou.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(cu.store),r=t.store(lu.store);return n.loadAll().next((function(n){return Po.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(lu.userMutationsIndex,i).next((function(r){return Po.forEach(r,(function(r){Br(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.fromDbMutationBatch(r);return Qo(t,n.userId,i).next((function(){}))}))}))}))}))},ou.prototype.ensureSequenceNumbers=function(t){var e=t.store(Eu.store),n=t.store(gu.store);return la(t).next((function(t){var r=[];return n.iterate((function(n,i){var o=new qi(n),a=function(t){return[0,$i(t)]}(o);r.push(e.get(a).next((function(n){return n?Po.resolve():function(n){return e.put(new Eu(0,$i(n),t))}(o)})))})).next((function(){return Po.waitFor(r)}))}))},ou.prototype.createCollectionParentIndex=function(t,e){function n(t){if(i.add(t)){var e=t.lastSegment(),n=t.popLast();return r.put({collectionId:e,parent:$i(n)})}}t.createObjectStore(Nu.store,{keyPath:Nu.keyPath});var r=e.store(Nu.store),i=new eu;return e.store(gu.store).iterate({keysOnly:!0},(function(t,e){return n(new qi(t).popLast())})).next((function(){return e.store(du.store).iterate({keysOnly:!0},(function(t,e){t[0];var r=t[1];return n((t[2],no(r)).popLast())}))}))},ou);function ou(t){this.serializer=t}var au=function(t,e){this.seconds=t,this.nanoseconds=e},su=(uu.store="owner",uu.key="owner",uu);function uu(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}var cu=(hu.store="mutationQueues",hu.keyPath="userId",hu);function hu(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}var lu=(fu.store="mutations",fu.keyPath="batchId",fu.userMutationsIndex="userMutationsIndex",fu.userMutationsKeyPath=["userId","batchId"],fu);function fu(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}var du=(pu.prefixForUser=function(t){return[t]},pu.prefixForPath=function(t,e){return[t,$i(e)]},pu.key=function(t,e,n){return[t,$i(e),n]},pu.store="documentMutations",pu.PLACEHOLDER=new pu,pu);function pu(){}var mu=function(t,e){this.path=t,this.readTime=e},yu=function(t,e){this.path=t,this.version=e},gu=(vu.store="remoteDocuments",vu.readTimeIndex="readTimeIndex",vu.readTimeIndexPath="readTime",vu.collectionReadTimeIndex="collectionReadTimeIndex",vu.collectionReadTimeIndexPath=["parentPath","readTime"],vu);function vu(t,e,n,r,i,o){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=o}var bu=(wu.store="remoteDocumentGlobal",wu.key="remoteDocumentGlobalKey",wu);function wu(t){this.byteSize=t}var Su=(Tu.store="targets",Tu.keyPath="targetId",Tu.queryTargetsIndexName="queryTargetsIndex",Tu.queryTargetsKeyPath=["canonicalId","targetId"],Tu);function Tu(t,e,n,r,i,o,a){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=o,this.query=a}var Eu=(Iu.store="targetDocuments",Iu.keyPath=["targetId","path"],Iu.documentTargetsIndex="documentTargetsIndex",Iu.documentTargetsKeyPath=["path","targetId"],Iu);function Iu(t,e,n){this.targetId=t,this.path=e,Br(0===t==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}var Cu=(Du.key="targetGlobalKey",Du.store="targetGlobal",Du);function Du(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}var Nu=(Au.store="collectionParents",Au.keyPath=["collectionId","parent"],Au);function Au(t,e){this.collectionId=t,this.parent=e}function ku(t){t.createObjectStore(Eu.store,{keyPath:Eu.keyPath}).createIndex(Eu.documentTargetsIndex,Eu.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Su.store,{keyPath:Su.keyPath}).createIndex(Su.queryTargetsIndexName,Su.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Cu.store)}var Ru=(Mu.store="clientMetadata",Mu.keyPath="clientId",Mu);function Mu(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}var Ou,_u,Lu=u(u(u([cu.store,lu.store,du.store,gu.store,Su.store,su.store,Cu.store,Eu.store],[Ru.store]),[bu.store]),[Nu.store]),Pu=(xu.prototype.addToCollectionParentIndex=function(t,e){var n=this;if(Br(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.has(e))return Po.resolve();var r=e.lastSegment(),i=e.popLast();return t.addOnCommittedListener((function(){n.collectionParentsCache.add(e)})),qu(t).put({collectionId:r,parent:$i(i)})},xu.prototype.getCollectionParents=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[Si(e),""],!1,!0);return qu(t).loadAll(r).next((function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r];if(o.collectionId!==e)break;n.push(no(o.parent))}return n}))},xu);function xu(){this.collectionParentsCache=new eu}function qu(t){return ac.getStore(t,Nu.store)}(_u=Ou=Ou||{})[_u.Listen=0]="Listen",_u[_u.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",_u[_u.LimboResolution=2]="LimboResolution";var Fu=(Vu.prototype.withSequenceNumber=function(t){return new Vu(this.query,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},Vu.prototype.withResumeToken=function(t,e){return new Vu(this.query,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)},Vu.prototype.withLastLimboFreeSnapshotVersion=function(t){return new Vu(this.query,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)},Vu.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.lastLimboFreeSnapshotVersion.isEqual(t.lastLimboFreeSnapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},Vu);function Vu(t,e,n,r,i,o,a){void 0===i&&(i=oo.MIN),void 0===o&&(o=oo.MIN),void 0===a&&(a=Kr()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a}var Bu=(Uu.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Ki.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new xs(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Ki.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new Vs(e,n)):Vr("Unexpected DbRemoteDocument")},Uu.prototype.toDbRemoteDocument=function(t,e){var n=this.toDbTimestampKey(e),r=t.key.path.popLast().toArray();if(t instanceof _s){var i=t.proto?t.proto:this.remoteSerializer.toDocument(t),o=t.hasCommittedMutations;return new gu(null,null,i,o,n,r)}if(t instanceof xs){var a=t.key.path.toArray(),s=this.toDbTimestamp(t.version);return o=t.hasCommittedMutations,new gu(null,new mu(a,s),null,o,n,r)}if(t instanceof Vs){a=t.key.path.toArray();var u=this.toDbTimestamp(t.version);return new gu(new yu(a,u),null,null,!0,n,r)}return Vr("Unexpected MaybeDocument")},Uu.prototype.toDbTimestampKey=function(t){var e=t.toTimestamp();return[e.seconds,e.nanoseconds]},Uu.prototype.fromDbTimestampKey=function(t){var e=new ro(t[0],t[1]);return oo.fromTimestamp(e)},Uu.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new au(e.seconds,e.nanoseconds)},Uu.prototype.fromDbTimestamp=function(t){var e=new ro(t.seconds,t.nanoseconds);return oo.fromTimestamp(e)},Uu.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map((function(t){return n.remoteSerializer.toMutation(t)})),i=e.mutations.map((function(t){return n.remoteSerializer.toMutation(t)}));return new lu(t,e.batchId,e.localWriteTime.toMillis(),r,i)},Uu.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map((function(t){return e.remoteSerializer.fromMutation(t)})),r=t.mutations.map((function(t){return e.remoteSerializer.fromMutation(t)})),i=ro.fromMillis(t.localWriteTimeMs);return new Mo(t.batchId,i,n,r)},Uu.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach((function(t){e.push($i(t.path))})),e},Uu.prototype.fromDbResourcePaths=function(t){for(var e=Ao(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new Ki(no(i)))}return e},Uu.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?this.fromDbTimestamp(t.lastLimboFreeSnapshotVersion):oo.MIN,i=t.resumeToken;return e=function(t){return void 0!==t.documents}(t.query)?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new Fu(e,t.targetId,Ou.Listen,t.lastListenSequenceNumber,n,r,i)},Uu.prototype.toDbTarget=function(t){Br(Ou.Listen===t.purpose,"Only queries with purpose "+Ou.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion),i=this.toDbTimestamp(t.lastLimboFreeSnapshotVersion);return e=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),n=t.resumeToken instanceof Uint8Array?(Br("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),t.resumeToken.toString()):t.resumeToken,new Su(t.targetId,t.query.canonicalId(),r,n,t.sequenceNumber,i,e)},Uu);function Uu(t){this.remoteSerializer=t}function Qu(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=bi(n,i);return 0===a?bi(r,o):a}var Ku=(ju.prototype.nextIndex=function(){return++this.previousIndex},ju.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();Qu(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(ju.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),ju);function ju(t){this.maxElements=t,this.buffer=new yo(Qu),this.previousIndex=0}var Wu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Gu=(zu.withCacheSize=function(t){return new zu(t,zu.DEFAULT_COLLECTION_PERCENTILE,zu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},zu.COLLECTION_DISABLED=-1,zu.MINIMUM_CACHE_SIZE_BYTES=1048576,zu.DEFAULT=new zu(zu.DEFAULT_CACHE_SIZE_BYTES=41943040,zu.DEFAULT_COLLECTION_PERCENTILE=10,zu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),zu.DISABLED=new zu(zu.COLLECTION_DISABLED,0,0),zu);function zu(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}var Hu=(Yu.prototype.start=function(){Br(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Gu.COLLECTION_DISABLED&&this.scheduleGC()},Yu.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(Yu.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),Yu.prototype.scheduleGC=function(){var t=this;Br(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;xr("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Wi.LruGarbageCollection,e,(function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then((function(){return t.scheduleGC()})).catch(uc)}))},Yu);function Yu(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.hasRun=!1,this.gcTask=null}var Xu=(Ju.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next((function(t){return Math.floor(e/100*t)}))},Ju.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return Po.resolve(Mi.INVALID);var r=new Ku(e);return this.delegate.forEachTarget(t,(function(t){return r.addElement(t.sequenceNumber)})).next((function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,(function(t){return r.addElement(t)}))})).next((function(){return r.maxValue}))},Ju.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},Ju.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},Ju.prototype.collect=function(t,e){var n=this;return this.params.cacheSizeCollectionThreshold===Gu.COLLECTION_DISABLED?(xr("LruGarbageCollector","Garbage collection skipped; disabled"),Po.resolve(Wu)):this.getCacheSize(t).next((function(r){return r<n.params.cacheSizeCollectionThreshold?(xr("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),Wu):n.runGarbageCollection(t,e)}))},Ju.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},Ju.prototype.runGarbageCollection=function(t,e){var n,r,i,o,a,s,u,c=this,h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((function(e){return r=e>c.params.maximumSequenceNumbersToCollect?(xr("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+c.params.maximumSequenceNumbersToCollect+" from "+e),c.params.maximumSequenceNumbersToCollect):e,o=Date.now(),c.nthSequenceNumber(t,r)})).next((function(r){return n=r,a=Date.now(),c.removeTargets(t,n,e)})).next((function(e){return i=e,s=Date.now(),c.removeOrphanedDocuments(t,n)})).next((function(t){return u=Date.now(),Lr()<=Ir.DEBUG&&xr("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(o-h)+"ms\n\tDetermined least recently used "+r+" in "+(a-o)+"ms\n\tRemoved "+i+" targets in "+(s-a)+"ms\n\tRemoved "+t+" documents in "+(u-s)+"ms\nTotal Duration: "+(u-h)+"ms"),Po.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:t})}))},Ju);function Ju(t,e){this.delegate=t,this.params=e}var Zu=($u.prototype.addOnCommittedListener=function(t){this.onCommittedListeners.push(t)},$u.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach((function(t){return t()}))},$u);function $u(){this.onCommittedListeners=[]}var tc,ec="IndexedDbPersistence",nc="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",rc="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",ic=(n(oc,tc=Zu),oc);function oc(t,e){var n=tc.call(this)||this;return n.simpleDbTransaction=t,n.currentSequenceNumber=e,n}var ac=(sc.getStore=function(t,e){if(t instanceof ic)return Xo.getStore(t.simpleDbTransaction,e);throw Vr("IndexedDbPersistence must use instances of IndexedDbTransaction")},sc.createIndexedDbPersistence=function(t){return a(this,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:if(!sc.isAvailable())throw new Gr(Wr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(e=new sc(t.allowTabSynchronization,t.persistenceKey,t.clientId,t.platform,t.lruParams,t.queue,t.serializer,t.sequenceNumberSyncer)).start()];case 1:return n.sent(),[2,e]}}))}))},sc.prototype.start=function(){var t=this;return Br(!this.started,"IndexedDbPersistence double-started!"),Br(null!==this.window,"Expected 'window' to be defined"),Xo.openOrCreate(this.dbName,ru,new iu(this.serializer)).then((function(e){return t.simpleDb=e,t.updateClientMetadataAndTryBecomePrimary()})).then((function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.simpleDb.runTransaction("readonly-idempotent",[Cu.store],(function(t){return la(t)}))})).then((function(e){t.listenSequence=new Mi(e,t.sequenceNumberSyncer)})).then((function(){t._started=!0})).catch((function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)}))},sc.prototype.setPrimaryStateListener=function(t){var e=this;return this.primaryStateListener=function(n){return a(e,void 0,void 0,(function(){return s(this,(function(e){return this.started?[2,t(n)]:[2]}))}))},t(this.isPrimary)},sc.prototype.setDatabaseDeletedListener=function(t){var e=this;this.simpleDb.setVersionChangeListener((function(n){return a(e,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return null!==n.newVersion?[3,2]:[4,t()];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}))},sc.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget((function(){return a(e,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))})))},sc.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",Lu,(function(e){return hc(e).put(new Ru(t.clientId,Date.now(),t.networkEnabled,t.inForeground)).next((function(){if(t.isPrimary)return t.verifyPrimaryLease(e).next((function(e){e||(t.isPrimary=!1,t.queue.enqueueAndForget((function(){return t.primaryStateListener(!1)})))}))})).next((function(){return t.canActAsPrimary(e)})).next((function(n){var r=t.isPrimary;return t.isPrimary=n,r!==t.isPrimary&&t.queue.enqueueAndForget((function(){return t.primaryStateListener(t.isPrimary)})),r&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(e):t.isPrimary?t.acquireOrExtendPrimaryLease(e):void 0}))}))},sc.prototype.verifyPrimaryLease=function(t){var e=this;return cc(t).get(su.key).next((function(t){return Po.resolve(e.isLocalClient(t))}))},sc.prototype.removeClientMetadata=function(t){return hc(t).delete(this.clientId)},sc.prototype.maybeGarbageCollectMultiClientState=function(){return a(this,void 0,void 0,(function(){var t,e,n=this;return s(this,(function(r){switch(r.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),e=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(function(r){var i=sc.getStore(r,Ru.store);return i.loadAll().next((function(r){return t=n.filterActiveClients(r,18e5),e=r.filter((function(e){return-1===t.indexOf(e)})),Po.forEach(e,(function(t){return i.delete(t.clientId)}))}))}))]);case 1:r.sent(),e.forEach((function(t){n.window.localStorage.removeItem(n.zombiedClientLocalStorageKey(t.clientId))})),r.label=2;case 2:return[2]}}))}))},sc.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Wi.ClientMetadataRefresh,4e3,(function(){return t.updateClientMetadataAndTryBecomePrimary().then((function(){return t.maybeGarbageCollectMultiClientState()})).then((function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()}))}))},sc.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},sc.prototype.canActAsPrimary=function(t){var e=this;return cc(t).get(su.key).next((function(n){if(null!==n&&e.isWithinAge(n.leaseTimestampMs,5e3)&&!e.isClientZombied(n.ownerId)){if(e.isLocalClient(n)&&e.networkEnabled)return!0;if(!e.isLocalClient(n)){if(!n.allowTabSynchronization)throw new Gr(Wr.FAILED_PRECONDITION,rc);return!1}}return!(!e.networkEnabled||!e.inForeground)||hc(t).loadAll().next((function(t){return void 0===e.filterActiveClients(t,5e3).find((function(t){if(e.clientId!==t.clientId){var n=!e.networkEnabled&&t.networkEnabled,r=!e.inForeground&&t.inForeground,i=e.networkEnabled===t.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(t){return e.isPrimary!==t&&xr(ec,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t}))},sc.prototype.shutdown=function(){return a(this,void 0,void 0,(function(){var t=this;return s(this,(function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite-idempotent",[su.store,Ru.store],(function(e){return t.releasePrimaryLeaseIfHeld(e).next((function(){return t.removeClientMetadata(e)}))}))];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}}))}))},sc.prototype.filterActiveClients=function(t,e){var n=this;return t.filter((function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)}))},sc.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly-idempotent",[Ru.store],(function(e){return hc(e).loadAll().next((function(e){return t.filterActiveClients(e,18e5).map((function(t){return t.clientId}))}))}))},sc.clearPersistence=function(t){return a(this,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:return sc.isAvailable()?(e=t+sc.MAIN_DATABASE,[4,Xo.delete(e)]):[2,Promise.resolve()];case 1:return n.sent(),[2]}}))}))},Object.defineProperty(sc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),sc.prototype.getMutationQueue=function(t){return Br(this.started,"Cannot initialize MutationQueue before persistence is started."),Vo.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},sc.prototype.getQueryCache=function(){return Br(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},sc.prototype.getRemoteDocumentCache=function(){return Br(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},sc.prototype.getIndexManager=function(){return Br(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},sc.prototype.runTransaction=function(t,e,n){var r=this;xr(ec,"Starting transaction:",t);var i,o=e.endsWith("idempotent"),a=e.startsWith("readonly")?o?"readonly-idempotent":"readonly":o?"readwrite-idempotent":"readwrite";return this.simpleDb.runTransaction(a,Lu,(function(o){return i=new ic(o,r.listenSequence.next()),"readwrite-primary"===e||"readwrite-primary-idempotent"===e?r.verifyPrimaryLease(o).next((function(e){if(!e)throw qr("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.queue.enqueueAndForget((function(){return r.primaryStateListener(!1)})),new Gr(Wr.FAILED_PRECONDITION,nc);return n(i)})).next((function(t){return r.acquireOrExtendPrimaryLease(o).next((function(){return t}))})):r.verifyAllowTabSynchronization(o).next((function(){return n(i)}))})).then((function(t){return i.raiseOnCommittedEvent(),t}))},sc.prototype.verifyAllowTabSynchronization=function(t){var e=this;return cc(t).get(su.key).next((function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Gr(Wr.FAILED_PRECONDITION,rc)}))},sc.prototype.acquireOrExtendPrimaryLease=function(t){var e=new su(this.clientId,this.allowTabSynchronization,Date.now());return cc(t).put(su.key,e)},sc.isAvailable=function(){return Xo.isAvailable()},sc.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},sc.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=cc(t);return n.get(su.key).next((function(t){return e.isLocalClient(t)?(xr(ec,"Releasing primary lease."),n.delete(su.key)):Po.resolve()}))},sc.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||n<t&&(qr("Detected an update time that is in the future: "+t+" > "+n),1))},sc.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget((function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()}))},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},sc.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Br(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},sc.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget((function(){return t.shutdown()}))},this.window.addEventListener("unload",this.windowUnloadHandler))},sc.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Br("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},sc.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return xr(ec,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return qr(ec,"Failed to get zombied client id.",t),!1}},sc.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){qr("Failed to set zombie client id.",t)}},sc.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},sc.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},sc.MAIN_DATABASE="main",sc);function sc(t,e,n,r,i,o,a,s){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.queue=o,this.sequenceNumberSyncer=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},this.referenceDelegate=new lc(this,i),this.dbName=e+sc.MAIN_DATABASE,this.serializer=new Bu(a),this.document=r.document,this.queryCache=new sa(this.referenceDelegate,this.serializer),this.indexManager=new Pu,this.remoteDocumentCache=new Gs(this.serializer,this.indexManager),!r.window||!r.window.localStorage)throw new Gr(Wr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}function uc(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){if(!function(t){return t.code===Wr.FAILED_PRECONDITION&&t.message===nc}(t))throw t;return xr(ec,"Unexpectedly lost primary lease"),[2]}))}))}function cc(t){return t.store(su.store)}function hc(t){return t.store(Ru.store)}var lc=(fc.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next((function(t){return e.next((function(e){return t+e}))}))},fc.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,(function(t){e++})).next((function(){return e}))},fc.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},fc.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){return this.forEachOrphanedDocument(t,(function(t,n){return e(n)}))},fc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},fc.prototype.addReference=function(t,e){return dc(t,e)},fc.prototype.removeReference=function(t,e){return dc(t,e)},fc.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},fc.prototype.removeMutationReference=function(t,e){return dc(t,e)},fc.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?Po.resolve(!0):function(t,e){var n=!1;return Go(t).iterateSerial((function(r){return Uo(t,r,e).next((function(t){return t&&(n=!0),Po.resolve(!t)}))})).next((function(){return n}))}(t,e)},fc.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],o=0;return this.forEachOrphanedDocument(t,(function(a,s){if(s<=e){var u=n.isPinned(t,a).next((function(e){if(!e)return o++,r.getEntry(t,a).next((function(){return r.removeEntry(a),fa(t).delete(function(t){return[0,$i(t.path)]}(a))}))}));i.push(u)}})).next((function(){return Po.waitFor(i)})).next((function(){return r.apply(t)})).next((function(){return o}))},fc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getQueryCache().updateQueryData(t,n)},fc.prototype.updateLimboDocument=function(t,e){return dc(t,e)},fc.prototype.forEachOrphanedDocument=function(t,e){var n,r=fa(t),i=Mi.INVALID;return r.iterate({index:Eu.documentTargetsIndex},(function(t,r){var o=t[0],a=(t[1],r.path),s=r.sequenceNumber;0===o?(i!==Mi.INVALID&&e(new Ki(no(n)),i),i=s,n=a):i=Mi.INVALID})).next((function(){i!==Mi.INVALID&&e(new Ki(no(n)),i)}))},fc.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},fc);function fc(t,e){this.db=t,this.inMemoryPins=null,this.garbageCollector=new Xu(this,e)}function dc(t,e){return fa(t).put(function(t,e){return new Eu(0,$i(t.path),e)}(e,t.currentSequenceNumber))}var pc=(mc.prototype.getDocument=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,e).next((function(r){return n.getDocumentInternal(t,e,r)}))},mc.prototype.getDocumentInternal=function(t,e,n){return this.remoteDocumentCache.getEntry(t,e).next((function(t){for(var r=0,i=n;r<i.length;r++)t=i[r].applyToLocalView(e,t);return t}))},mc.prototype.applyLocalMutationsToDocuments=function(t,e,n){var r=To();return e.forEach((function(t,e){for(var i=0,o=n;i<o.length;i++)e=o[i].applyToLocalView(t,e);r=r.insert(t,e)})),r},mc.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next((function(e){return n.getLocalViewOfDocuments(t,e)}))},mc.prototype.getLocalViewOfDocuments=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((function(r){var i=n.applyLocalMutationsToDocuments(t,e,r),o=So();return i.forEach((function(t,e){e=e||new xs(t,oo.forDeletedDoc()),o=o.insert(t,e)})),o}))},mc.prototype.getDocumentsMatchingQuery=function(t,e,n){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)},mc.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Ki(e)).next((function(t){var e=Io();return t instanceof _s&&(e=e.insert(t.key,t)),e}))},mc.prototype.getDocumentsMatchingCollectionGroupQuery=function(t,e,n){var r=this;Br(e.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=e.collectionGroup,o=Io();return this.indexManager.getCollectionParents(t,i).next((function(a){return Po.forEach(a,(function(a){var s=e.asCollectionQueryAtPath(a.child(i));return r.getDocumentsMatchingCollectionQuery(t,s,n).next((function(t){t.forEach((function(t,e){o=o.insert(t,e)}))}))})).next((function(){return o}))}))},mc.prototype.getDocumentsMatchingCollectionQuery=function(t,e,n){var r,i,o=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n).next((function(n){return r=n,o.mutationQueue.getAllMutationBatchesAffectingQuery(t,e)})).next((function(e){return i=e,o.addMissingBaseDocuments(t,i,r).next((function(t){r=t;for(var e=0,n=i;e<n.length;e++)for(var o=n[e],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key,h=r.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);r=l instanceof _s?r.insert(c,l):r.remove(c)}}))})).next((function(){return r.forEach((function(t,n){e.matches(n)||(r=r.remove(t))})),r}))},mc.prototype.addMissingBaseDocuments=function(t,e,n){for(var r=Ao(),i=0,o=e;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof Aa&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(t,r).next((function(t){return t.forEach((function(t,e){null!==e&&e instanceof _s&&(c=c.insert(t,e))})),c}))},mc);function mc(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}var yc=(gc.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},gc.prototype.addReference=function(t,e){var n=new vc(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},gc.prototype.addReferences=function(t,e){var n=this;t.forEach((function(t){return n.addReference(t,e)}))},gc.prototype.removeReference=function(t,e){this.removeRef(new vc(t,e))},gc.prototype.removeReferences=function(t,e){var n=this;t.forEach((function(t){return n.removeReference(t,e)}))},gc.prototype.removeReferencesForId=function(t){var e=this,n=Ki.EMPTY,r=new vc(n,t),i=new vc(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],(function(t){e.removeRef(t),o.push(t.key)})),o},gc.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach((function(e){return t.removeRef(e)}))},gc.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},gc.prototype.referencesForId=function(t){var e=Ki.EMPTY,n=new vc(e,t),r=new vc(e,t+1),i=Ao();return this.refsByTarget.forEachInRange([n,r],(function(t){i=i.add(t.key)})),i},gc.prototype.containsKey=function(t){var e=new vc(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},gc);function gc(){this.refsByKey=new yo(vc.compareByKey),this.refsByTarget=new yo(vc.compareByTargetId)}var vc=(bc.compareByKey=function(t,e){return Ki.comparator(t.key,e.key)||bi(t.targetOrBatchId,e.targetOrBatchId)},bc.compareByTargetId=function(t,e){return bi(t.targetOrBatchId,e.targetOrBatchId)||Ki.comparator(t.key,e.key)},bc);function bc(t,e){this.key=t,this.targetOrBatchId=e}var wc="LocalStore",Sc=(Tc.prototype.start=function(){return this.synchronizeLastDocumentChangeReadTime()},Tc.prototype.handleUserChange=function(t){return a(this,void 0,void 0,(function(){var e,n,r,i=this;return s(this,(function(o){switch(o.label){case 0:return e=this.mutationQueue,n=this.localDocuments,[4,this.persistence.runTransaction("Handle user change","readonly-idempotent",(function(r){var o;return i.mutationQueue.getAllMutationBatches(r).next((function(a){return o=a,e=i.persistence.getMutationQueue(t),n=new pc(i.remoteDocuments,e,i.persistence.getIndexManager()),e.getAllMutationBatches(r)})).next((function(t){for(var e=[],i=[],a=Ao(),s=0,u=o;s<u.length;s++){var c=u[s];e.push(c.batchId);for(var h=0,l=c.mutations;h<l.length;h++){var f=l[h];a=a.add(f.key)}}for(var d=0,p=t;d<p.length;d++){c=p[d],i.push(c.batchId);for(var m=0,y=c.mutations;m<y.length;m++)f=y[m],a=a.add(f.key)}return n.getDocuments(r,a).next((function(t){return{affectedDocuments:t,removedBatchIds:e,addedBatchIds:i}}))}))}))];case 1:return r=o.sent(),this.mutationQueue=e,this.localDocuments=n,this.queryEngine.setLocalDocumentsView(this.localDocuments),[2,r]}}))}))},Tc.prototype.localWrite=function(t){var e,n=this,r=ro.now(),i=t.reduce((function(t,e){return t.add(e.key)}),Ao());return this.persistence.runTransaction("Locally write mutations","readwrite-idempotent",(function(o){return n.localDocuments.getDocuments(o,i).next((function(i){e=i;for(var a=[],s=0,u=t;s<u.length;s++){var c=u[s],h=c.extractBaseValue(e.get(c.key));null!=h&&a.push(new Aa(c.key,h,h.fieldMask(),wa.exists(!0)))}return n.mutationQueue.addMutationBatch(o,r,a,t)}))})).then((function(t){var n=t.applyToLocalDocumentSet(e);return{batchId:t.batchId,changes:n}}))},Tc.prototype.lookupMutationDocuments=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly-idempotent",(function(n){return e.mutationQueue.lookupMutationKeys(n,t).next((function(t){return t?e.localDocuments.getDocuments(n,t):Po.resolve(null)}))}))},Tc.prototype.acknowledgeBatch=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary-idempotent",(function(n){var r=t.batch.keys(),i=e.remoteDocuments.newChangeBuffer({trackRemovals:!0});return e.mutationQueue.acknowledgeBatch(n,t.batch,t.streamToken).next((function(){return e.applyWriteToRemoteDocuments(n,t,i)})).next((function(){return i.apply(n)})).next((function(){return e.mutationQueue.performConsistencyCheck(n)})).next((function(){return e.localDocuments.getDocuments(n,r)}))}))},Tc.prototype.rejectBatch=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary-idempotent",(function(n){var r;return e.mutationQueue.lookupMutationBatch(n,t).next((function(t){return Br(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.mutationQueue.removeMutationBatch(n,t)})).next((function(){return e.mutationQueue.performConsistencyCheck(n)})).next((function(){return e.localDocuments.getDocuments(n,r)}))}))},Tc.prototype.getHighestUnacknowledgedBatchId=function(){var t=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly-idempotent",(function(e){return t.mutationQueue.getHighestUnacknowledgedBatchId(e)}))},Tc.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly-idempotent",(function(e){return t.mutationQueue.getLastStreamToken(e)}))},Tc.prototype.setLastStreamToken=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary-idempotent",(function(n){return e.mutationQueue.setLastStreamToken(n,t)}))},Tc.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly-idempotent",(function(e){return t.queryCache.getLastRemoteSnapshotVersion(e)}))},Tc.prototype.applyRemoteEvent=function(t){var e=this,n=t.snapshotVersion,r=this.queryDataByTarget;return this.persistence.runTransaction("Apply remote event","readwrite-primary-idempotent",(function(i){var o=e.remoteDocuments.newChangeBuffer({trackRemovals:!0});r=e.queryDataByTarget;var a=[];Jr(t.targetChanges,(function(t,o){var s=r.get(t);if(s){a.push(e.queryCache.removeMatchingKeys(i,o.removedDocuments,t).next((function(){return e.queryCache.addMatchingKeys(i,o.addedDocuments,t)})));var u=o.resumeToken;if(0<u.length){var c=s.withResumeToken(u,n).withSequenceNumber(i.currentSequenceNumber);r=r.insert(t,c),Tc.shouldPersistQueryData(s,c,o)&&a.push(e.queryCache.updateQueryData(i,c))}}}));var s=So(),u=Ao();if(t.documentUpdates.forEach((function(t,e){u=u.add(t)})),a.push(o.getEntries(i,u).next((function(r){t.documentUpdates.forEach((function(u,c){var h=r.get(u);c instanceof xs&&c.version.isEqual(oo.MIN)?(o.removeEntry(u,n),s=s.insert(u,c)):null==h||0<c.version.compareTo(h.version)||0===c.version.compareTo(h.version)&&h.hasPendingWrites?(oo.MIN.isEqual(n)&&qr(wc,"Cannot add a document when the remote version is zero"),o.addEntry(c,n),s=s.insert(u,c)):xr(wc,"Ignoring outdated watch update for ",u,". Current version:",h.version," Watch version:",c.version),t.resolvedLimboDocuments.has(u)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,u))}))}))),!n.isEqual(oo.MIN)){var c=e.queryCache.getLastRemoteSnapshotVersion(i).next((function(t){return Br(0<=n.compareTo(t),"Watch stream reverted to previous snapshot?? "+n+" < "+t),e.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,n)}));a.push(c)}return Po.waitFor(a).next((function(){return o.apply(i)})).next((function(){return e.localDocuments.getLocalViewOfDocuments(i,s)}))})).then((function(t){return e.queryDataByTarget=r,t}))},Tc.shouldPersistQueryData=function(t,e,n){return Br(0<e.resumeToken.length,"Attempted to persist query data with no resume token"),0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size},Tc.prototype.notifyLocalViewChanges=function(t){for(var e=this,n=0,r=t;n<r.length;n++){var i=r[n],o=i.targetId;if(this.localViewReferences.addReferences(i.addedKeys,o),this.localViewReferences.removeReferences(i.removedKeys,o),!i.fromCache){var a=this.queryDataByTarget.get(o);Br(null!==a,"Can't set limbo-free snapshot version for unknown target: "+o);var s=a.snapshotVersion,u=a.withLastLimboFreeSnapshotVersion(s);this.queryDataByTarget=this.queryDataByTarget.insert(o,u)}}return this.persistence.runTransaction("notifyLocalViewChanges","readwrite-idempotent",(function(n){return Po.forEach(t,(function(t){return Po.forEach(t.removedKeys,(function(t){return e.persistence.referenceDelegate.removeReference(n,t)}))}))}))},Tc.prototype.nextMutationBatch=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly-idempotent",(function(n){return void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)}))},Tc.prototype.readDocument=function(t){var e=this;return this.persistence.runTransaction("read document","readonly-idempotent",(function(n){return e.localDocuments.getDocument(n,t)}))},Tc.prototype.allocateQuery=function(t){var e=this;return this.persistence.runTransaction("Allocate query","readwrite-idempotent",(function(n){var r;return e.queryCache.getQueryData(n,t).next((function(i){return i?(r=i,Po.resolve(r)):e.queryCache.allocateTargetId(n).next((function(i){return r=new Fu(t,i,Ou.Listen,n.currentSequenceNumber),e.queryCache.addQueryData(n,r).next((function(){return r}))}))}))})).then((function(n){return Br(null===e.queryDataByTarget.get(n.targetId),"Tried to allocate an already allocated query: "+t),e.queryDataByTarget=e.queryDataByTarget.insert(n.targetId,n),e.targetIdByQuery.set(t,n.targetId),n}))},Tc.prototype.getQueryData=function(t,e){var n=this.targetIdByQuery.get(e);return void 0!==n?Po.resolve(this.queryDataByTarget.get(n)):this.queryCache.getQueryData(t,e)},Tc.prototype.releaseQuery=function(t,e){var n,r=this,i=e?"readwrite-idempotent":"readwrite-primary-idempotent";return this.persistence.runTransaction("Release query",i,(function(i){var o=r.targetIdByQuery.get(t);Br(void 0!==o,"Tried to release nonexistent query: "+t),n=o;var a=r.queryDataByTarget.get(n),s=r.localViewReferences.removeReferencesForId(n);return e?Po.resolve():Po.forEach(s,(function(t){return r.persistence.referenceDelegate.removeReference(i,t)})).next((function(){r.persistence.referenceDelegate.removeTarget(i,a)}))})).then((function(){r.queryDataByTarget=r.queryDataByTarget.remove(n),r.targetIdByQuery.delete(t)}))},Tc.prototype.executeQuery=function(t,e){var n=this,r=oo.MIN,i=Ao();return this.persistence.runTransaction("Execute query","readonly-idempotent",(function(o){return n.getQueryData(o,t).next((function(t){if(t)return r=t.lastLimboFreeSnapshotVersion,n.queryCache.getMatchingKeysForTargetId(o,t.targetId).next((function(t){i=t}))})).next((function(){return n.queryEngine.getDocumentsMatchingQuery(o,t,e?r:oo.MIN,e?i:Ao())})).next((function(t){return{documents:t,remoteKeys:i}}))}))},Tc.prototype.remoteDocumentKeys=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly-idempotent",(function(n){return e.queryCache.getMatchingKeysForTargetId(n,t)}))},Tc.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},Tc.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},Tc.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},Tc.prototype.applyWriteToRemoteDocuments=function(t,e,n){var r=this,i=e.batch,o=i.keys(),a=Po.resolve();return o.forEach((function(r){a=a.next((function(){return n.getEntry(t,r)})).next((function(t){var o=t,a=e.docVersions.get(r);Br(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&((o=i.applyToRemoteDocument(r,o,e))?n.addEntry(o,e.commitVersion):Br(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))}))})),a.next((function(){return r.mutationQueue.removeMutationBatch(t,i)}))},Tc.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary-idempotent",(function(n){return t.collect(n,e.queryDataByTarget)}))},Tc.prototype.getQueryForTarget=function(t){var e=this,n=this.queryDataByTarget.get(t);return n?Promise.resolve(n.query):this.persistence.runTransaction("Get query data","readonly-idempotent",(function(n){return e.queryCache.getQueryDataForTarget(n,t).next((function(t){return t?t.query:null}))}))},Tc.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly-idempotent",(function(e){return t.remoteDocuments.getNewDocumentChanges(e,t.lastDocumentChangeReadTime)})).then((function(e){var n=e.changedDocs,r=e.readTime;return t.lastDocumentChangeReadTime=r,n}))},Tc.prototype.synchronizeLastDocumentChangeReadTime=function(){return a(this,void 0,void 0,(function(){var t,e=this;return s(this,(function(n){return this.remoteDocuments instanceof Gs?(t=this.remoteDocuments,[2,this.persistence.runTransaction("Synchronize last document change read time","readonly-idempotent",(function(e){return t.getLastDocumentChange(e)})).then((function(t){var n=t.readTime;e.lastDocumentChangeReadTime=n}))]):[2]}))}))},Tc.RESUME_TOKEN_MAX_AGE_MICROS=3e8,Tc);function Tc(t,e,n){this.persistence=t,this.queryEngine=e,this.localViewReferences=new yc,this.queryDataByTarget=new so(bi),this.targetIdByQuery=new Us((function(t){return t.canonicalId()})),this.lastDocumentChangeReadTime=oo.MIN,Br(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(n),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new pc(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager()),this.queryEngine.setLocalDocumentsView(this.localDocuments)}var Ec=(Ic.prototype.checkEmpty=function(t){return Po.resolve(0===this.mutationQueue.length)},Ic.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");Br(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return Br(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,Po.resolve()},Ic.prototype.getLastStreamToken=function(t){return Po.resolve(this.lastStreamToken)},Ic.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,Po.resolve()},Ic.prototype.addMutationBatch=function(t,e,n,r){Br(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&Br(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new Mo(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new vc(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return Po.resolve(o)},Ic.prototype.lookupMutationBatch=function(t,e){return Po.resolve(this.findMutationBatch(e))},Ic.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return Br(null!=n,"Failed to find local mutation batch."),Po.resolve(n.keys())},Ic.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.indexOfBatchId(n),i=r<0?0:r;return Po.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},Ic.prototype.getHighestUnacknowledgedBatchId=function(){return Po.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},Ic.prototype.getAllMutationBatches=function(t){return Po.resolve(this.mutationQueue.slice())},Ic.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new vc(e,0),i=new vc(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],(function(t){Br(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(t.targetOrBatchId);Br(null!==r,"Batches in the index must exist in the main table"),o.push(r)})),Po.resolve(o)},Ic.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new yo(bi);return e.forEach((function(t){var e=new vc(t,0),i=new vc(t,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([e,i],(function(e){Br(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)}))})),Po.resolve(this.findMutationBatches(r))},Ic.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Br(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Ki.isDocumentKey(i)||(i=i.child(""));var o=new vc(new Ki(i),0),a=new yo(bi);return this.batchesByDocumentKey.forEachWhile((function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)}),o),Po.resolve(this.findMutationBatches(a))},Ic.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.findMutationBatch(t);null!==r&&n.push(r)})),n},Ic.prototype.removeMutationBatch=function(t,e){var n=this;Br(0===this.indexOfExistingBatchId(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return Po.forEach(e.mutations,(function(i){var o=new vc(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(t,i.key)})).next((function(){n.batchesByDocumentKey=r}))},Ic.prototype.removeCachedMutationKeys=function(t){},Ic.prototype.containsKey=function(t,e){var n=new vc(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return Po.resolve(e.isEqual(r&&r.key))},Ic.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Br(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),Po.resolve()},Ic.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return Br(0<=n&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},Ic.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},Ic.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return Br(n.batchId===t,"If found batch must match"),n},Ic);function Ic(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Kr(),this.batchesByDocumentKey=new yo(vc.compareByKey)}var Cc=(Dc.prototype.getTargetCount=function(t){return Po.resolve(this.targetCount)},Dc.prototype.forEachTarget=function(t,e){return this.queries.forEach((function(t,n){return e(n)})),Po.resolve()},Dc.prototype.getLastRemoteSnapshotVersion=function(t){return Po.resolve(this.lastRemoteSnapshotVersion)},Dc.prototype.getHighestSequenceNumber=function(t){return Po.resolve(this.highestSequenceNumber)},Dc.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,Po.resolve(e)},Dc.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),Po.resolve()},Dc.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},Dc.prototype.addQueryData=function(t,e){return Br(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,Po.resolve()},Dc.prototype.updateQueryData=function(t,e){return Br(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),Po.resolve()},Dc.prototype.removeQueryData=function(t,e){return Br(0<this.targetCount,"Removing a target from an empty cache"),Br(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,Po.resolve()},Dc.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.queries.forEach((function(a,s){s.sequenceNumber<=e&&null===n.get(s.targetId)&&(r.queries.delete(a),o.push(r.removeMatchingKeysForTargetId(t,s.targetId)),i++)})),Po.waitFor(o).next((function(){return i}))},Dc.prototype.getQueryCount=function(t){return Po.resolve(this.targetCount)},Dc.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return Po.resolve(n)},Dc.prototype.getQueryDataForTarget=function(t,e){return Vr("Not yet implemented.")},Dc.prototype.addMatchingKeys=function(t,e,n){this.references.addReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach((function(e){i.push(r.addReference(t,e))})),Po.waitFor(i)},Dc.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach((function(e){i.push(r.removeReference(t,e))})),Po.waitFor(i)},Dc.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),Po.resolve()},Dc.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return Po.resolve(n)},Dc.prototype.containsKey=function(t,e){return Po.resolve(this.references.containsKey(e))},Dc);function Dc(t){this.persistence=t,this.queries=new Us((function(t){return t.canonicalId()})),this.lastRemoteSnapshotVersion=oo.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new yc,this.targetCount=0,this.targetIdGenerator=zo.forQueryCache()}var Nc,Ac=(kc.prototype.addEntry=function(t,e,n){Br(!n.isEqual(oo.MIN),"Cannot add a document with a read time of zero");var r=e.key,i=this.docs.get(r),o=i?i.size:0,a=this.sizer(e);return this.docs=this.docs.insert(r,{maybeDocument:e,size:a,readTime:n}),this.size+=a-o,this.indexManager.addToCollectionParentIndex(t,r.path.popLast())},kc.prototype.removeEntry=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},kc.prototype.getEntry=function(t,e){var n=this.docs.get(e);return Po.resolve(n?n.maybeDocument:null)},kc.prototype.getEntries=function(t,e){var n=this,r=To();return e.forEach((function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)})),Po.resolve(r)},kc.prototype.getDocumentsMatchingQuery=function(t,e,n){Br(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var r=Io(),i=new Ki(e.path.child("")),o=this.docs.getIteratorFrom(i);o.hasNext();){var a=o.getNext(),s=a.key,u=a.value,c=u.maybeDocument,h=u.readTime;if(!e.path.isPrefixOf(s.path))break;h.compareTo(n)<=0||c instanceof _s&&e.matches(c)&&(r=r.insert(c.key,c))}return Po.resolve(r)},kc.prototype.forEachDocumentKey=function(t,e){return Po.forEach(this.docs,(function(t){return e(t)}))},kc.prototype.getNewDocumentChanges=function(t,e){throw new Error("getNewDocumentChanges() is not supported with MemoryPersistence")},kc.prototype.newChangeBuffer=function(t){return new kc.RemoteDocumentChangeBuffer(this)},kc.prototype.getSize=function(t){return Po.resolve(this.size)},kc.RemoteDocumentChangeBuffer=(n(Rc,Nc=Ks),Rc.prototype.applyChanges=function(t){var e=this,n=[];return this.changes.forEach((function(r,i){i?n.push(e.documentCache.addEntry(t,i,e.readTime)):e.documentCache.removeEntry(r)})),Po.waitFor(n)},Rc.prototype.getFromCache=function(t,e){return this.documentCache.getEntry(t,e)},Rc.prototype.getAllFromCache=function(t,e){return this.documentCache.getEntries(t,e)},Rc),kc);function kc(t,e){this.indexManager=t,this.sizer=e,this.docs=new so(Ki.comparator),this.size=0}function Rc(t){var e=Nc.call(this)||this;return e.documentCache=t,e}var Mc=(Oc.createLruPersistence=function(t,e,n){return new Oc(t,(function(t){return new Fc(t,new Bu(e),n)}))},Oc.createEagerPersistence=function(t){return new Oc(t,(function(t){return new xc(t)}))},Oc.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(Oc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Oc.prototype.getActiveClients=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){return[2,[this.clientId]]}))}))},Oc.prototype.setPrimaryStateListener=function(t){return t(!0)},Oc.prototype.setDatabaseDeletedListener=function(){},Oc.prototype.setNetworkEnabled=function(t){},Oc.prototype.getIndexManager=function(){return this.indexManager},Oc.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Ec(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},Oc.prototype.getQueryCache=function(){return this.queryCache},Oc.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},Oc.prototype.runTransaction=function(t,e,n){var r=this;xr("MemoryPersistence","Starting transaction:",t);var i=new Lc(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next((function(t){return r.referenceDelegate.onTransactionCommitted(i).next((function(){return t}))})).toPromise().then((function(t){return i.raiseOnCommittedEvent(),t}))},Oc.prototype.mutationQueuesContainKey=function(t,e){return Po.or(function(t){var e=[];return Zr(t,(function(t,n){return e.push(n)})),e}(this.mutationQueues).map((function(n){return function(){return n.containsKey(t,e)}})))},Oc);function Oc(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new Mi(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new Cc(this),this.indexManager=new $s,this.remoteDocumentCache=new Ac(this.indexManager,(function(t){return n.referenceDelegate.documentSize(t)}))}var _c,Lc=(n(Pc,_c=Zu),Pc);function Pc(t){var e=_c.call(this)||this;return e.currentSequenceNumber=t,e}var xc=(Object.defineProperty(qc.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw Vr("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),qc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},qc.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),Po.resolve()},qc.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),Po.resolve()},qc.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),Po.resolve()},qc.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next((function(t){t.forEach((function(t){return n.orphanedDocuments.add(t)}))})).next((function(){return r.removeQueryData(t,e)}))},qc.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},qc.prototype.onTransactionCommitted=function(t){var e=this,n=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Po.forEach(this.orphanedDocuments,(function(r){return e.isReferenced(t,r).next((function(t){t||n.removeEntry(r)}))})).next((function(){return e._orphanedDocuments=null,n.apply(t)}))},qc.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next((function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)}))},qc.prototype.documentSize=function(t){return 0},qc.prototype.isReferenced=function(t,e){var n=this;return Po.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return Po.resolve(n.inMemoryPins.containsKey(e))}])},qc);function qc(t){this.persistence=t,this.inMemoryPins=null,this._orphanedDocuments=null}var Fc=(Vc.prototype.onTransactionStarted=function(){},Vc.prototype.onTransactionCommitted=function(t){return Po.resolve()},Vc.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},Vc.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next((function(t){return e.next((function(e){return t+e}))}))},Vc.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,(function(t){e++})).next((function(){return e}))},Vc.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){var n=this;return Po.forEach(this.orphanedSequenceNumbers,(function(r,i){return n.isPinned(t,r,i).next((function(t){return t?Po.resolve():e(i)}))}))},Vc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Vc.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},Vc.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=this.persistence.getRemoteDocumentCache(),o=i.newChangeBuffer();return i.forEachDocumentKey(t,(function(i){return n.isPinned(t,i,e).next((function(t){t||(r++,o.removeEntry(i))}))})).next((function(){return o.apply(t)})).next((function(){return r}))},Vc.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Po.resolve()},Vc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getQueryCache().updateQueryData(t,n)},Vc.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Po.resolve()},Vc.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Po.resolve()},Vc.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Po.resolve()},Vc.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t,t.version);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw Vr("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},Vc.prototype.isPinned=function(t,e,n){var r=this;return Po.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return Po.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return Po.resolve(void 0!==t&&n<t)}])},Vc.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},Vc);function Vc(t,e,n){this.persistence=t,this.serializer=e,this.inMemoryPins=null,this.orphanedSequenceNumbers=new Us((function(t){return $i(t.path)})),this.garbageCollector=new Xu(this,n)}var Bc=(Uc.prototype.setLocalDocumentsView=function(t){this.localDocumentsView=t},Uc.prototype.getDocumentsMatchingQuery=function(t,e,n,r){return Br(void 0!==this.localDocumentsView,"setLocalDocumentsView() not called"),this.localDocumentsView.getDocumentsMatchingQuery(t,e,oo.MIN)},Uc);function Uc(){}var Qc=Number,Kc=Qc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),jc=Qc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,Wc=Qc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function Gc(t){return null==t}function zc(t){return Wc(t)&&t<=jc&&Kc<=t}var Hc=(Yc.prototype.reset=function(){this.currentBaseMs=0},Yc.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},Yc.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<this.currentBaseMs&&xr("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,(function(){return e.lastAttemptTime=Date.now(),t()})),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},Yc.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},Yc.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},Yc);function Yc(t,e,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}var Xc,Jc,Zc="PersistentStream";(Jc=Xc=Xc||{})[Jc.Initial=0]="Initial",Jc[Jc.Starting=1]="Starting",Jc[Jc.Open=2]="Open",Jc[Jc.Error=3]="Error",Jc[Jc.Backoff=4]="Backoff";var $c=(th.prototype.isStarted=function(){return this.state===Xc.Starting||this.state===Xc.Open||this.state===Xc.Backoff},th.prototype.isOpen=function(){return this.state===Xc.Open},th.prototype.start=function(){this.state!==Xc.Error?(Br(this.state===Xc.Initial,"Already started"),this.auth()):this.performBackoff()},th.prototype.stop=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Xc.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},th.prototype.inhibitBackoff=function(){Br(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Xc.Initial,this.backoff.reset()},th.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,(function(){return t.handleIdleCloseTimer()})))},th.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},th.prototype.handleIdleCloseTimer=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){return this.isOpen()?[2,this.close(Xc.Initial)]:[2]}))}))},th.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},th.prototype.close=function(t,e){return a(this,void 0,void 0,(function(){return s(this,(function(n){switch(n.label){case 0:return Br(this.isStarted(),"Only started streams should be closed."),Br(t===Xc.Error||Gc(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==Xc.Error?this.backoff.reset():e&&e.code===Wr.RESOURCE_EXHAUSTED?(qr(e.toString()),qr("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===Wr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(e)];case 1:return n.sent(),[2]}}))}))},th.prototype.tearDown=function(){},th.prototype.auth=function(){var t=this;Br(this.state===Xc.Initial,"Must be in initial state to auth"),this.state=Xc.Starting;var e=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then((function(e){t.closeCount===n&&t.startStream(e)}),(function(n){e((function(){var e=new Gr(Wr.UNKNOWN,"Fetching auth token failed: "+n.message);return t.handleStreamClose(e)}))}))},th.prototype.startStream=function(t){var e=this;Br(this.state===Xc.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen((function(){n((function(){return Br(e.state===Xc.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Xc.Open,e.listener.onOpen()}))})),this.stream.onClose((function(t){n((function(){return e.handleStreamClose(t)}))})),this.stream.onMessage((function(t){n((function(){return e.onMessage(t)}))}))},th.prototype.performBackoff=function(){var t=this;Br(this.state===Xc.Error,"Should only perform backoff when in Error state"),this.state=Xc.Backoff,this.backoff.backoffAndRun((function(){return a(t,void 0,void 0,(function(){return s(this,(function(t){return Br(this.state===Xc.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Xc.Initial,this.start(),Br(this.isStarted(),"PersistentStream should have started"),[2]}))}))}))},th.prototype.handleStreamClose=function(t){return Br(this.isStarted(),"Can't handle server close on non-started stream"),xr(Zc,"close with error: "+t),this.stream=null,this.close(Xc.Error,t)},th.prototype.getCloseGuardedDispatcher=function(t){var e=this;return function(n){e.queue.enqueueAndForget((function(){return e.closeCount===t?n():(xr(Zc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}},th);function th(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Xc.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Hc(t,e)}var eh,nh=(n(rh,eh=$c),rh.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},rh.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},rh.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},rh.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},rh);function rh(t,e,n,r,i){var o=eh.call(this,t,Wi.ListenStreamConnectionBackoff,Wi.ListenStreamIdle,e,n,i)||this;return o.serializer=r,o}var ih,oh=(n(ah,ih=$c),Object.defineProperty(ah.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),ah.prototype.start=function(){this.handshakeComplete_=!1,ih.prototype.start.call(this)},ah.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},ah.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},ah.prototype.onMessage=function(t){if(Br(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Br(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},ah.prototype.writeHandshake=function(){Br(this.isOpen(),"Writing handshake requires an opened stream"),Br(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},ah.prototype.writeMutations=function(t){var e=this;Br(this.isOpen(),"Writing mutations requires an opened stream"),Br(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Br(0<this.lastStreamToken.length,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map((function(t){return e.serializer.toMutation(t)}))};this.sendRequest(n)},ah);function ah(t,e,n,r,i){var o=ih.call(this,t,Wi.WriteStreamConnectionBackoff,Wi.WriteStreamIdle,e,n,i)||this;return o.serializer=r,o.handshakeComplete_=!1,o.lastStreamToken=Kr(),o}var sh=(uh.prototype.newPersistentWriteStream=function(t){return new oh(this.queue,this.connection,this.credentials,this.serializer,t)},uh.prototype.newPersistentWatchStream=function(t){return new nh(this.queue,this.connection,this.credentials,this.serializer,t)},uh.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map((function(t){return e.serializer.toMutation(t)}))};return this.invokeRPC("Commit",n).then((function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)}))},uh.prototype.lookup=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,documents:t.map((function(t){return e.serializer.toName(t)}))};return this.invokeStreamingRPC("BatchGetDocuments",n).then((function(n){var r=So();n.forEach((function(t){var n=e.serializer.fromMaybeDocument(t);r=r.insert(n.key,n)}));var i=[];return t.forEach((function(t){var e=r.get(t);Br(!!e,"Missing entity in write response for "+t),i.push(e)})),i}))},uh.prototype.invokeRPC=function(t,e){var n=this;return this.credentials.getToken().then((function(r){return n.connection.invokeRPC(t,e,r)})).catch((function(t){throw t.code===Wr.UNAUTHENTICATED&&n.credentials.invalidateToken(),t}))},uh.prototype.invokeStreamingRPC=function(t,e){var n=this;return this.credentials.getToken().then((function(r){return n.connection.invokeStreamingRPC(t,e,r)})).catch((function(t){throw t.code===Wr.UNAUTHENTICATED&&n.credentials.invalidateToken(),t}))},uh);function uh(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}var ch,hh,lh,fh,dh=(ph.prototype.lookup=function(t){return a(this,void 0,void 0,(function(){var e,n=this;return s(this,(function(r){switch(r.label){case 0:if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Gr(Wr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(t)];case 1:return(e=r.sent()).forEach((function(t){t instanceof xs||t instanceof _s?n.recordVersion(t):Vr("Document in a transaction was a "+t.constructor.name)})),[2,e]}}))}))},ph.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t))),this.writtenDocs.add(t)},ph.prototype.update=function(t,e){try{this.write(e.toMutations(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t)},ph.prototype.delete=function(t){this.write([new Fa(t,this.precondition(t))]),this.writtenDocs.add(t)},ph.prototype.commit=function(){return a(this,void 0,void 0,(function(){var t;return s(this,(function(e){switch(e.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(t=this.readVersions,this.mutations.forEach((function(e){t=t.remove(e.key)})),!t.isEmpty())throw new Gr(Wr.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return e.sent(),this.committed=!0,[2]}}))}))},ph.prototype.recordVersion=function(t){var e;if(t instanceof _s)e=t.version;else{if(!(t instanceof xs))throw Vr("Document in a transaction was a "+t.constructor.name);e=oo.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Gr(Wr.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},ph.prototype.precondition=function(t){var e=this.readVersions.get(t);return!this.writtenDocs.has(t)&&e?wa.updateTime(e):wa.NONE},ph.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(this.writtenDocs.has(t)||!e)return wa.exists(!0);if(e.isEqual(oo.forDeletedDoc()))throw new Gr(Wr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return wa.updateTime(e)},ph.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(t)},ph.prototype.ensureCommitNotCalled=function(){Br(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},ph);function ph(t){this.datastore=t,this.readVersions=Do(),this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}(hh=ch=ch||{})[hh.Unknown=0]="Unknown",hh[hh.Online=1]="Online",hh[hh.Offline=2]="Offline",(fh=lh=lh||{})[fh.RemoteStore=0]="RemoteStore",fh[fh.SharedClientState=1]="SharedClientState";var mh,yh,gh=(vh.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(ch.Unknown),Br(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Wi.OnlineStateTimeout,1e4,(function(){return t.onlineStateTimer=null,Br(t.state===ch.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(ch.Offline),Promise.resolve()})))},vh.prototype.handleWatchStreamFailure=function(t){this.state===ch.Online?(this.setAndBroadcast(ch.Unknown),Br(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Br(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(ch.Offline)))},vh.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===ch.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},vh.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},vh.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(qr(e),this.shouldWarnClientIsOffline=!1):xr("OnlineStateTracker",e)},vh.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},vh);function vh(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=ch.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}function bh(t){switch(t){case Wr.OK:return Vr("Treated status OK as error");case Wr.CANCELLED:case Wr.UNKNOWN:case Wr.DEADLINE_EXCEEDED:case Wr.RESOURCE_EXHAUSTED:case Wr.INTERNAL:case Wr.UNAVAILABLE:case Wr.UNAUTHENTICATED:return!1;case Wr.INVALID_ARGUMENT:case Wr.NOT_FOUND:case Wr.ALREADY_EXISTS:case Wr.PERMISSION_DENIED:case Wr.FAILED_PRECONDITION:case Wr.ABORTED:case Wr.OUT_OF_RANGE:case Wr.UNIMPLEMENTED:case Wr.DATA_LOSS:return!0;default:return Vr("Unknown status code: "+t)}}function wh(t){if(void 0===t)return qr("GRPC error has no .code"),Wr.UNKNOWN;switch(t){case mh.OK:return Wr.OK;case mh.CANCELLED:return Wr.CANCELLED;case mh.UNKNOWN:return Wr.UNKNOWN;case mh.DEADLINE_EXCEEDED:return Wr.DEADLINE_EXCEEDED;case mh.RESOURCE_EXHAUSTED:return Wr.RESOURCE_EXHAUSTED;case mh.INTERNAL:return Wr.INTERNAL;case mh.UNAVAILABLE:return Wr.UNAVAILABLE;case mh.UNAUTHENTICATED:return Wr.UNAUTHENTICATED;case mh.INVALID_ARGUMENT:return Wr.INVALID_ARGUMENT;case mh.NOT_FOUND:return Wr.NOT_FOUND;case mh.ALREADY_EXISTS:return Wr.ALREADY_EXISTS;case mh.PERMISSION_DENIED:return Wr.PERMISSION_DENIED;case mh.FAILED_PRECONDITION:return Wr.FAILED_PRECONDITION;case mh.ABORTED:return Wr.ABORTED;case mh.OUT_OF_RANGE:return Wr.OUT_OF_RANGE;case mh.UNIMPLEMENTED:return Wr.UNIMPLEMENTED;case mh.DATA_LOSS:return Wr.DATA_LOSS;default:return Vr("Unknown status code: "+t)}}(yh=mh=mh||{})[yh.OK=0]="OK",yh[yh.CANCELLED=1]="CANCELLED",yh[yh.UNKNOWN=2]="UNKNOWN",yh[yh.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",yh[yh.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",yh[yh.NOT_FOUND=5]="NOT_FOUND",yh[yh.ALREADY_EXISTS=6]="ALREADY_EXISTS",yh[yh.PERMISSION_DENIED=7]="PERMISSION_DENIED",yh[yh.UNAUTHENTICATED=16]="UNAUTHENTICATED",yh[yh.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",yh[yh.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",yh[yh.ABORTED=10]="ABORTED",yh[yh.OUT_OF_RANGE=11]="OUT_OF_RANGE",yh[yh.UNIMPLEMENTED=12]="UNIMPLEMENTED",yh[yh.INTERNAL=13]="INTERNAL",yh[yh.UNAVAILABLE=14]="UNAVAILABLE",yh[yh.DATA_LOSS=15]="DATA_LOSS";var Sh,Th,Eh,Ih,Ch=(Dh.emptySet=function(t){return new Dh(t.comparator)},Dh.prototype.has=function(t){return null!=this.keyedMap.get(t)},Dh.prototype.get=function(t){return this.keyedMap.get(t)},Dh.prototype.first=function(){return this.sortedSet.minKey()},Dh.prototype.last=function(){return this.sortedSet.maxKey()},Dh.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},Dh.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(Dh.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),Dh.prototype.forEach=function(t){this.sortedSet.inorderTraversal((function(e,n){return t(e),!1}))},Dh.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},Dh.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},Dh.prototype.isEqual=function(t){if(!(t instanceof Dh))return!1;if(this.size!==t.size)return!1;for(var e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},Dh.prototype.toString=function(){var t=[];return this.forEach((function(e){t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},Dh.prototype.copy=function(t,e){var n=new Dh;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n},Dh);function Dh(t){this.comparator=t?function(e,n){return t(e,n)||Ki.comparator(e.key,n.key)}:function(t,e){return Ki.comparator(t.key,e.key)},this.keyedMap=Io(),this.sortedSet=new so(this.comparator)}(Th=Sh=Sh||{})[Th.Added=0]="Added",Th[Th.Removed=1]="Removed",Th[Th.Modified=2]="Modified",Th[Th.Metadata=3]="Metadata",(Ih=Eh=Eh||{})[Ih.Local=0]="Local",Ih[Ih.Synced=1]="Synced";var Nh=(Ah.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==Sh.Added&&n.type===Sh.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===Sh.Metadata&&n.type!==Sh.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===Sh.Modified&&n.type===Sh.Modified?this.changeMap=this.changeMap.insert(e,{type:Sh.Modified,doc:t.doc}):t.type===Sh.Modified&&n.type===Sh.Added?this.changeMap=this.changeMap.insert(e,{type:Sh.Added,doc:t.doc}):t.type===Sh.Removed&&n.type===Sh.Added?this.changeMap=this.changeMap.remove(e):t.type===Sh.Removed&&n.type===Sh.Modified?this.changeMap=this.changeMap.insert(e,{type:Sh.Removed,doc:n.doc}):t.type===Sh.Added&&n.type===Sh.Removed?this.changeMap=this.changeMap.insert(e,{type:Sh.Modified,doc:t.doc}):Vr("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},Ah.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal((function(e,n){t.push(n)})),t},Ah);function Ah(){this.changeMap=new so(Ki.comparator)}var kh=(Rh.fromInitialDocuments=function(t,e,n,r){var i=[];return e.forEach((function(t){i.push({type:Sh.Added,doc:t})})),new Rh(t,e,Ch.emptySet(e),i,n,r,!0,!1)},Object.defineProperty(Rh.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),Rh.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},Rh);function Rh(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}var Mh=(Oh.createSynthesizedRemoteEventForCurrentChange=function(t,e){var n,r=((n={})[t]=_h.createSynthesizedTargetChangeForCurrentChange(t,e),n);return new Oh(oo.MIN,r,Ro(),So(),Ao())},Oh);function Oh(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}var _h=(Lh.createSynthesizedTargetChangeForCurrentChange=function(t,e){return new Lh(Kr(),e,Ao(),Ao(),Ao())},Lh);function Lh(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}var Ph,xh,qh=function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r},Fh=function(t,e){this.targetId=t,this.existenceFilter=e};(xh=Ph=Ph||{})[xh.NoChange=0]="NoChange",xh[xh.Added=1]="Added",xh[xh.Removed=2]="Removed",xh[xh.Current=3]="Current",xh[xh.Reset=4]="Reset";var Vh=function(t,e,n,r){void 0===n&&(n=Kr()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},Bh=(Object.defineProperty(Uh.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(Uh.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(Uh.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(Uh.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),Uh.prototype.updateResumeToken=function(t){0<t.length&&(this._hasPendingChanges=!0,this._resumeToken=t)},Uh.prototype.toTargetChange=function(){var t=Ao(),e=Ao(),n=Ao();return this.documentChanges.forEach((function(r,i){switch(i){case Sh.Added:t=t.add(r);break;case Sh.Modified:e=e.add(r);break;case Sh.Removed:n=n.add(r);break;default:Vr("Encountered invalid change type: "+i)}})),new _h(this._resumeToken,this._current,t,e,n)},Uh.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Wh()},Uh.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},Uh.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},Uh.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},Uh.prototype.recordTargetResponse=function(){this.pendingResponses-=1},Uh.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},Uh);function Uh(){this.pendingResponses=0,this.documentChanges=Wh(),this._resumeToken=Kr(),this._current=!1,this._hasPendingChanges=!0}var Qh=(Kh.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof _s?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof xs&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.removeDocumentFromTarget(r,t.key,t.newDoc)},Kh.prototype.handleTargetChange=function(t){var e=this;this.forEachTarget(t,(function(n){var r=e.ensureTargetState(n);switch(t.state){case Ph.NoChange:e.isActiveTarget(n)&&r.updateResumeToken(t.resumeToken);break;case Ph.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(t.resumeToken);break;case Ph.Removed:r.recordTargetResponse(),r.isPending||e.removeTarget(n),Br(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case Ph.Current:e.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(t.resumeToken));break;case Ph.Reset:e.isActiveTarget(n)&&(e.resetTarget(n),r.updateResumeToken(t.resumeToken));break;default:Vr("Unknown target watch change state: "+t.state)}}))},Kh.prototype.forEachTarget=function(t,e){0<t.targetIds.length?t.targetIds.forEach(e):Jr(this.targetStates,e)},Kh.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new Ki(i.path);this.removeDocumentFromTarget(e,o,new xs(o,oo.forDeletedDoc()))}else Br(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},Kh.prototype.createRemoteEvent=function(t){var e=this,n={};Jr(this.targetStates,(function(r,i){var o=e.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var a=new Ki(o.query.path);null!==e.pendingDocumentUpdates.get(a)||e.targetContainsDocument(r,a)||e.removeDocumentFromTarget(r,a,new xs(a,t))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}}));var r=Ao();this.pendingDocumentTargetMapping.forEach((function(t,n){var i=!0;n.forEachWhile((function(t){var n=e.queryDataForActiveTarget(t);return!n||n.purpose===Ou.LimboResolution||(i=!1)})),i&&(r=r.add(t))}));var i=new Mh(t,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=So(),this.pendingDocumentTargetMapping=jh(),this.pendingTargetResets=new yo(bi),i},Kh.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?Sh.Modified:Sh.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},Kh.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,Sh.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},Kh.prototype.removeTarget=function(t){delete this.targetStates[t]},Kh.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},Kh.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},Kh.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Bh),this.targetStates[t]},Kh.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new yo(bi),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},Kh.prototype.isActiveTarget=function(t){var e=null!==this.queryDataForActiveTarget(t);return e||xr("WatchChangeAggregator","Detected inactive target",t),e},Kh.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},Kh.prototype.resetTarget=function(t){var e=this;Br(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new Bh,this.metadataProvider.getRemoteKeysForTarget(t).forEach((function(n){e.removeDocumentFromTarget(t,n,null)}))},Kh.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},Kh);function Kh(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=So(),this.pendingDocumentTargetMapping=jh(),this.pendingTargetResets=new yo(bi)}function jh(){return new so(Ki.comparator)}function Wh(){return new so(Ki.comparator)}var Gh="RemoteStore",zh=(Hh.prototype.start=function(){return this.enableNetwork()},Hh.prototype.enableNetwork=function(){return a(this,void 0,void 0,(function(){var t;return s(this,(function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(ch.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},Hh.prototype.disableNetwork=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ch.Offline),[2]}}))}))},Hh.prototype.disableNetworkInternal=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),0<this.writePipeline.length&&(xr(Gh,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}}))}))},Hh.prototype.shutdown=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return xr(Gh,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(ch.Unknown),[2]}}))}))},Hh.prototype.listen=function(t){Br(!Yr(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},Hh.prototype.unlisten=function(t){Br(Yr(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),$r(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(ch.Unknown))},Hh.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},Hh.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},Hh.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},Hh.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},Hh.prototype.startWatchStream=function(){Br(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Qh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},Hh.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!$r(this.listenTargets)},Hh.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},Hh.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},Hh.prototype.onWatchStreamOpen=function(){return a(this,void 0,void 0,(function(){var t=this;return s(this,(function(e){return Jr(this.listenTargets,(function(e,n){t.sendWatchRequest(n)})),[2]}))}))},Hh.prototype.onWatchStreamClose=function(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){return void 0===t&&Br(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(ch.Unknown),[2]}))}))},Hh.prototype.onWatchStreamChange=function(t,e){return a(this,void 0,void 0,(function(){var n;return s(this,(function(r){switch(r.label){case 0:return this.onlineStateTracker.set(ch.Online),t instanceof Vh&&t.state===Ph.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof qh?this.watchChangeAggregator.handleDocumentChange(t):t instanceof Fh?this.watchChangeAggregator.handleExistenceFilter(t):(Br(t instanceof Vh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),e.isEqual(oo.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),0<=e.compareTo(n)?[4,this.raiseWatchSnapshot(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},Hh.prototype.raiseWatchSnapshot=function(t){var e=this;Br(!t.isEqual(oo.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(t);return Jr(n.targetChanges,(function(n,r){if(0<r.resumeToken.length){var i=e.listenTargets[n];i&&(e.listenTargets[n]=i.withResumeToken(r.resumeToken,t))}})),n.targetMismatches.forEach((function(t){var n=e.listenTargets[t];if(n){e.listenTargets[t]=n.withResumeToken(Kr(),n.snapshotVersion),e.sendUnwatchRequest(t);var r=new Fu(n.query,t,Ou.ExistenceFilterMismatch,n.sequenceNumber);e.sendWatchRequest(r)}})),this.syncEngine.applyRemoteEvent(n)},Hh.prototype.handleTargetError=function(t){var e=this;Br(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach((function(t){r=r.then((function(){return a(e,void 0,void 0,(function(){return s(this,(function(e){return Yr(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,n)]):[2]}))}))}))})),r},Hh.prototype.fillWritePipeline=function(){return a(this,void 0,void 0,(function(){var t,e;return s(this,(function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(t=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(t)]):[3,4];case 1:return null!==(e=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(e),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}}))}))},Hh.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},Hh.prototype.outstandingWrites=function(){return this.writePipeline.length},Hh.prototype.addToWritePipeline=function(t){Br(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},Hh.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},Hh.prototype.startWriteStream=function(){Br(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},Hh.prototype.onWriteStreamOpen=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){return this.writeStream.writeHandshake(),[2]}))}))},Hh.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then((function(){for(var e=0,n=t.writePipeline;e<n.length;e++){var r=n[e];t.writeStream.writeMutations(r.mutations)}})).catch(uc)},Hh.prototype.onMutationResult=function(t,e){var n=this;Br(0<this.writePipeline.length,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=_o.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then((function(){return n.fillWritePipeline()}))},Hh.prototype.onWriteStreamClose=function(t){return a(this,void 0,void 0,(function(){var e=this;return s(this,(function(n){return void 0===t&&Br(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&0<this.writePipeline.length?[2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then((function(){e.shouldStartWriteStream()&&e.startWriteStream()}))]:[2]}))}))},Hh.prototype.handleHandshakeError=function(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){return bh(t.code)?(xr(Gh,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Kr(),[2,this.localStore.setLastStreamToken(Kr()).catch(uc)]):[2]}))}))},Hh.prototype.handleWriteError=function(t){return a(this,void 0,void 0,(function(){var e,n=this;return s(this,(function(r){return function(t){return bh(t)&&t!==Wr.ABORTED}(t.code)?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,t).then((function(){return n.fillWritePipeline()}))]):[2]}))}))},Hh.prototype.createTransaction=function(){return new dh(this.datastore)},Hh.prototype.restartNetwork=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ch.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}}))}))},Hh.prototype.handleCredentialChange=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.canUseNetwork()?(xr(Gh,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},Hh.prototype.applyPrimaryState=function(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return(this.isPrimary=t)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(ch.Unknown),e.label=4;case 4:return[2]}}))}))},Hh);function Hh(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback((function(t){n.enqueueAndForget((function(){return a(o,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.canUseNetwork()?(xr(Gh,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))})),this.onlineStateTracker=new gh(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}var Yh=(Object.defineProperty(Xh.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(Xh.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),Xh.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},Xh.prototype._compareTo=function(t){return bi(this._lat,t._lat)||bi(this._long,t._long)},Xh);function Xh(t,e){if(ei("GeoPoint",arguments,2),ii("GeoPoint","number",1,t),ii("GeoPoint","number",2,e),!isFinite(t)||t<-90||90<t)throw new Gr(Wr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Gr(Wr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}var Jh=(Zh.atPath=function(t){return new Zh(t)},Object.defineProperty(Zh.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Cl]:this.memoizedOrderBy=[new El(t),Cl];else{Br(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field.");for(var n=!(this.memoizedOrderBy=[]),r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:bl.ASCENDING;this.memoizedOrderBy.push(a===bl.ASCENDING?Cl:Dl)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),Zh.prototype.addFilter=function(t){Br(null==this.getInequalityFilterField()||!(t instanceof nl)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Br(!this.isDocumentQuery(),"No filtering allowed for document query");var e=this.filters.concat([t]);return new Zh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),e,this.limit,this.startAt,this.endAt)},Zh.prototype.addOrderBy=function(t){Br(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var e=this.explicitOrderBy.concat([t]);return new Zh(this.path,this.collectionGroup,e,this.filters.slice(),this.limit,this.startAt,this.endAt)},Zh.prototype.withLimit=function(t){return new Zh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,this.startAt,this.endAt)},Zh.prototype.withStartAt=function(t){return new Zh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,t,this.endAt)},Zh.prototype.withEndAt=function(t){return new Zh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,t)},Zh.prototype.asCollectionQueryAtPath=function(t){return new Zh(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},Zh.prototype.matchesAllDocuments=function(){return 0===this.filters.length&&null===this.limit&&null==this.startAt&&null==this.endAt&&(0===this.explicitOrderBy.length||1===this.explicitOrderBy.length&&this.explicitOrderBy[0].field.isKeyField())},Zh.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";Gc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},Zh.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(t+=", filters: ["+this.filters.join(", ")+"]"),Gc(this.limit)||(t+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},Zh.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},Zh.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Br(n,"orderBy used that doesn't compare on key field"),0},Zh.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},Zh.prototype.hasLimit=function(){return!Gc(this.limit)},Zh.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},Zh.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof nl&&n.isInequality())return n.field}return null},Zh.prototype.findFilterOperator=function(t){for(var e=0,n=this.filters;e<n.length;e++){var r=n[e];if(r instanceof nl&&0<=t.indexOf(r.op))return r.op}return null},Zh.prototype.isDocumentQuery=function(){return Ki.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},Zh.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},Zh.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Ki.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},Zh.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&null===t.field(r.field))return!1}return!0},Zh.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},Zh.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},Zh.prototype.assertValidBound=function(t){Br(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},Zh);function Zh(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}var $h=(tl.fromString=function(t){switch(t){case"<":return tl.LESS_THAN;case"<=":return tl.LESS_THAN_OR_EQUAL;case"==":return tl.EQUAL;case">=":return tl.GREATER_THAN_OR_EQUAL;case">":return tl.GREATER_THAN;case"array-contains":return tl.ARRAY_CONTAINS;case"in":return tl.IN;case"array-contains-any":return tl.ARRAY_CONTAINS_ANY;default:return Vr("Unknown FieldFilter operator: "+t)}},tl.prototype.toString=function(){return this.name},tl.prototype.isEqual=function(t){return this.name===t.name},tl.LESS_THAN=new tl("<"),tl.LESS_THAN_OR_EQUAL=new tl("<="),tl.EQUAL=new tl("=="),tl.GREATER_THAN=new tl(">"),tl.GREATER_THAN_OR_EQUAL=new tl(">="),tl.ARRAY_CONTAINS=new tl("array-contains"),tl.IN=new tl("in"),tl.ARRAY_CONTAINS_ANY=new tl("array-contains-any"),tl);function tl(t){this.name=t}var el,nl=(n(rl,el=function(){}),rl.create=function(t,e,n){if(t.isKeyField())return e===$h.IN?(Br(n instanceof As,"Comparing on key with IN, but filter value not an ArrayValue"),Br(n.internalValue.every((function(t){return t instanceof bs})),"Comparing on key with IN, but an array value was not a RefValue"),new ul(t,n)):(Br(n instanceof bs,"Comparing on key, but filter value not a RefValue"),Br(e!==$h.ARRAY_CONTAINS&&e!==$h.ARRAY_CONTAINS_ANY,"'"+e.toString()+"' queries don't make sense on document keys."),new ol(t,e,n));if(n.isEqual(Wa.INSTANCE)){if(e!==$h.EQUAL)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new rl(t,e,n)}if(n.isEqual(is.NAN)){if(e!==$h.EQUAL)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new rl(t,e,n)}return e===$h.ARRAY_CONTAINS?new ll(t,n):e===$h.IN?(Br(n instanceof As,"IN filter has invalid value: "+n.toString()),new pl(t,n)):e===$h.ARRAY_CONTAINS_ANY?(Br(n instanceof As,"ARRAY_CONTAINS_ANY filter has invalid value: "+n.toString()),new gl(t,n)):new rl(t,e,n)},rl.prototype.matches=function(t){var e=t.field(this.field);return null!==e&&this.value.typeOrder===e.typeOrder&&this.matchesComparison(e.compareTo(this.value))},rl.prototype.matchesComparison=function(t){switch(this.op){case $h.LESS_THAN:return t<0;case $h.LESS_THAN_OR_EQUAL:return t<=0;case $h.EQUAL:return 0===t;case $h.GREATER_THAN:return 0<t;case $h.GREATER_THAN_OR_EQUAL:return 0<=t;default:return Vr("Unknown FieldFilter operator: "+this.op)}},rl.prototype.isInequality=function(){return 0<=[$h.LESS_THAN,$h.LESS_THAN_OR_EQUAL,$h.GREATER_THAN,$h.GREATER_THAN_OR_EQUAL].indexOf(this.op)},rl.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},rl.prototype.isEqual=function(t){return t instanceof rl&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},rl.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},rl);function rl(t,e,n){var r=el.call(this)||this;return r.field=t,r.op=e,r.value=n,r}var il,ol=(n(al,il=nl),al.prototype.matches=function(t){var e=this.value,n=Ki.comparator(t.key,e.key);return this.matchesComparison(n)},al);function al(){return null!==il&&il.apply(this,arguments)||this}var sl,ul=(n(cl,sl=nl),cl.prototype.matches=function(t){return this.value.internalValue.some((function(e){return t.key.isEqual(e.key)}))},cl);function cl(t,e){var n=sl.call(this,t,$h.IN,e)||this;return n.value=e,n}var hl,ll=(n(fl,hl=nl),fl.prototype.matches=function(t){var e=t.field(this.field);return e instanceof As&&e.contains(this.value)},fl);function fl(t,e){return hl.call(this,t,$h.ARRAY_CONTAINS,e)||this}var dl,pl=(n(ml,dl=nl),ml.prototype.matches=function(t){var e=this.value,n=t.field(this.field);return null!==n&&e.contains(n)},ml);function ml(t,e){var n=dl.call(this,t,$h.IN,e)||this;return n.value=e,n}var yl,gl=(n(vl,yl=nl),vl.prototype.matches=function(t){var e=this,n=t.field(this.field);return n instanceof As&&n.internalValue.some((function(t){return e.value.contains(t)}))},vl);function vl(t,e){var n=yl.call(this,t,$h.ARRAY_CONTAINS_ANY,e)||this;return n.value=e,n}var bl=(wl.prototype.toString=function(){return this.name},wl.ASCENDING=new wl("asc"),wl.DESCENDING=new wl("desc"),wl);function wl(t){this.name=t}var Sl=(Tl.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},Tl.prototype.sortsBeforeDocument=function(t,e){Br(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())Br(o instanceof bs,"Bound has a non-key value where the key path is being used."),n=Ki.comparator(o.key,e.key);else{var a=e.field(i.field);Br(null!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===bl.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},Tl.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];if(!n.isEqual(r))return!1}return!0},Tl);function Tl(t,e){this.position=t,this.before=e}var El=(Il.prototype.compare=function(t,e){var n=this.isKeyOrderBy?_s.compareByKey(t,e):_s.compareByField(this.field,t,e);switch(this.dir){case bl.ASCENDING:return n;case bl.DESCENDING:return-1*n;default:return Vr("Unknown direction: "+this.dir)}},Il.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},Il.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},Il.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},Il);function Il(t,e){this.field=t,void 0===e&&(e=bl.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}var Cl=new El(Ui.keyField(),bl.ASCENDING),Dl=new El(Ui.keyField(),bl.DESCENDING),Nl=(Al.prototype.applyToLocalView=function(t,e){return new ds(e,t)},Al.prototype.applyToRemoteDocument=function(t,e){return e},Al.prototype.computeBaseValue=function(t){return null},Al.prototype.isEqual=function(t){return t instanceof Al},Al.instance=new Al,Al);function Al(){}var kl=(Rl.prototype.applyToLocalView=function(t,e){return this.apply(t)},Rl.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Rl.prototype.apply=function(t){for(var e=Pl(t),n=function(t){e.find((function(e){return e.isEqual(t)}))||e.push(t)},r=0,i=this.elements;r<i.length;r++)n(i[r]);return new As(e)},Rl.prototype.computeBaseValue=function(t){return null},Rl.prototype.isEqual=function(t){return t instanceof Rl&&wi(t.elements,this.elements)},Rl);function Rl(t){this.elements=t}var Ml=(Ol.prototype.applyToLocalView=function(t,e){return this.apply(t)},Ol.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Ol.prototype.apply=function(t){for(var e=Pl(t),n=function(t){e=e.filter((function(e){return!e.isEqual(t)}))},r=0,i=this.elements;r<i.length;r++)n(i[r]);return new As(e)},Ol.prototype.computeBaseValue=function(t){return null},Ol.prototype.isEqual=function(t){return t instanceof Ol&&wi(t.elements,this.elements)},Ol);function Ol(t){this.elements=t}var _l=(Ll.prototype.applyToLocalView=function(t,e){var n=this.computeBaseValue(t);if(n instanceof es&&this.operand instanceof es){var r=n.internalValue+this.operand.internalValue;return new es(r)}return r=n.internalValue+this.operand.internalValue,new is(r)},Ll.prototype.applyToRemoteDocument=function(t,e){return Br(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},Ll.prototype.computeBaseValue=function(t){return t instanceof Ja?t:new es(0)},Ll.prototype.isEqual=function(t){return t instanceof Ll&&this.operand.isEqual(t.operand)},Ll);function Ll(t){this.operand=t}function Pl(t){return t instanceof As?t.internalValue.slice():[]}var xl=(ql.prototype.isEqual=function(t){return t&&t.count===this.count},ql);function ql(t){this.count=t}var Fl,Vl,Bl=((Fl={})[bl.ASCENDING.name]="ASCENDING",Fl[bl.DESCENDING.name]="DESCENDING",Fl),Ul=((Vl={})[$h.LESS_THAN.name]="LESS_THAN",Vl[$h.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Vl[$h.GREATER_THAN.name]="GREATER_THAN",Vl[$h.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Vl[$h.EQUAL.name]="EQUAL",Vl[$h.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Vl[$h.IN.name]="IN",Vl[$h.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",Vl),Ql=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Kl(t,e){Br(!Gc(t),e+" is missing")}function jl(t){return"number"==typeof t?t:"string"==typeof t?Number(t):Vr("can't parse "+t)}var Wl=(Gl.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},Gl.prototype.unsafeCastProtoByteString=function(t){return t},Gl.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Wr.UNKNOWN:wh(t.code);return new Gr(e,t.message||"")},Gl.prototype.toInt32Value=function(t){return this.options.useProto3Json||Gc(t)?t:{value:t}},Gl.prototype.fromInt32Value=function(t){var e;return Gc(e="object"==typeof t?t.value:t)?null:e},Gl.prototype.toTimestamp=function(t){return this.options.useProto3Json?new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+t.nanoseconds).slice(-9)+"Z":{seconds:""+t.seconds,nanos:t.nanoseconds}},Gl.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Br(!!t,"Cannot deserialize null or undefined timestamp.");var e=jl(t.seconds||"0"),n=t.nanos||0;return new ro(e,n)},Gl.prototype.fromIso8601String=function(t){var e=0,n=Ql.exec(t);if(Br(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new ro(o,e)},Gl.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},Gl.prototype.fromBlob=function(t){return"string"==typeof t?(Br(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ii.fromBase64String(t)):(Br(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ii.fromUint8Array(t))},Gl.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},Gl.prototype.fromVersion=function(t){return Br(!!t,"Trying to deserialize version that isn't set"),oo.fromTimestamp(this.fromTimestamp(t))},Gl.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},Gl.prototype.fromResourceName=function(t){var e=qi.fromString(t);return Br(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},Gl.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},Gl.prototype.fromName=function(t){var e=this.fromResourceName(t);return Br(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),Br(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Ki(this.extractLocalPathFromResourceName(e))},Gl.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},Gl.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?qi.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(Gl.prototype,"encodedDatabaseId",{get:function(){return new qi(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),Gl.prototype.fullyQualifiedPrefixPath=function(t){return new qi(["projects",t.projectId,"databases",t.database])},Gl.prototype.extractLocalPathFromResourceName=function(t){return Br(4<t.length&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},Gl.prototype.isValidResourceName=function(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)},Gl.prototype.toValue=function(t){if(t instanceof Wa)return{nullValue:"NULL_VALUE"};if(t instanceof Ha)return{booleanValue:t.value()};if(t instanceof es)return{integerValue:""+t.value()};if(t instanceof is){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof ss?{stringValue:t.value()}:t instanceof Cs?{mapValue:this.toMapValue(t)}:t instanceof As?{arrayValue:this.toArrayValue(t)}:t instanceof hs?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof Ts?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof ys?{bytesValue:this.toBytes(t.value())}:t instanceof bs?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:Vr("Unknown FieldValue "+JSON.stringify(t))},Gl.prototype.fromValue=function(t){var e=this;if("nullValue"in t)return Wa.INSTANCE;if("booleanValue"in t)return Ha.of(t.booleanValue);if("integerValue"in t)return new es(jl(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return is.NAN;if("Infinity"===t.doubleValue)return is.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return is.NEGATIVE_INFINITY}return new is(t.doubleValue)}if("stringValue"in t)return new ss(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t){Kl(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new As(n.map((function(t){return e.fromValue(t)})))}if("timestampValue"in t)return Kl(t.timestampValue,"timestampValue"),new hs(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t){Kl(t.geoPointValue,"geoPointValue");var r=t.geoPointValue.latitude||0,i=t.geoPointValue.longitude||0;return new Ts(new Yh(r,i))}if("bytesValue"in t){Kl(t.bytesValue,"bytesValue");var o=this.fromBlob(t.bytesValue);return new ys(o)}if("referenceValue"in t){Kl(t.referenceValue,"referenceValue");var a=this.fromResourceName(t.referenceValue),s=new ki(a.get(1),a.get(3)),u=new Ki(this.extractLocalPathFromResourceName(a));return new bs(s,u)}return Vr("Unknown Value proto "+JSON.stringify(t))},Gl.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},Gl.prototype.toDocument=function(t){return Br(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toTimestamp(t.version.toTimestamp())}},Gl.prototype.fromDocument=function(t,e){var n=this,r=this.fromName(t.name),i=this.fromVersion(t.updateTime);return new _s(r,i,{hasCommittedMutations:!!e},void 0,t,(function(t){return n.fromValue(t)}))},Gl.prototype.toFields=function(t){var e=this,n={};return t.forEach((function(t,r){n[t]=e.toValue(r)})),n},Gl.prototype.fromFields=function(t){var e=this,n=t,r=Cs.EMPTY;return Zr(n,(function(t,n){r=r.set(new Ui([t]),e.fromValue(n))})),r},Gl.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},Gl.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach((function(t){n.push(e.toValue(t))})),{values:n}},Gl.prototype.fromFound=function(t){var e=this;Br(!!t.found,"Tried to deserialize a found document from a missing document."),Kl(t.found.name,"doc.found.name"),Kl(t.found.updateTime,"doc.found.updateTime");var n=this.fromName(t.found.name),r=this.fromVersion(t.found.updateTime);return new _s(n,r,{},void 0,t.found,(function(t){return e.fromValue(t)}))},Gl.prototype.fromMissing=function(t){Br(!!t.missing,"Tried to deserialize a missing document from a found document."),Br(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new xs(e,n)},Gl.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):Vr("invalid batch get response: "+JSON.stringify(t))},Gl.prototype.toWatchTargetChangeState=function(t){switch(t){case Ph.Added:return"ADD";case Ph.Current:return"CURRENT";case Ph.NoChange:return"NO_CHANGE";case Ph.Removed:return"REMOVE";case Ph.Reset:return"RESET";default:return Vr("Unknown WatchTargetChangeState: "+t)}},Gl.prototype.toTestWatchChange=function(t){if(t instanceof Fh)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof qh){if(t.newDoc instanceof _s){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data()),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof xs)return e=t.newDoc,{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Vh){var n=void 0;return t.cause&&(n={code:function(t){if(void 0===t)return mh.OK;switch(t){case Wr.OK:return mh.OK;case Wr.CANCELLED:return mh.CANCELLED;case Wr.UNKNOWN:return mh.UNKNOWN;case Wr.DEADLINE_EXCEEDED:return mh.DEADLINE_EXCEEDED;case Wr.RESOURCE_EXHAUSTED:return mh.RESOURCE_EXHAUSTED;case Wr.INTERNAL:return mh.INTERNAL;case Wr.UNAVAILABLE:return mh.UNAVAILABLE;case Wr.UNAUTHENTICATED:return mh.UNAUTHENTICATED;case Wr.INVALID_ARGUMENT:return mh.INVALID_ARGUMENT;case Wr.NOT_FOUND:return mh.NOT_FOUND;case Wr.ALREADY_EXISTS:return mh.ALREADY_EXISTS;case Wr.PERMISSION_DENIED:return mh.PERMISSION_DENIED;case Wr.FAILED_PRECONDITION:return mh.FAILED_PRECONDITION;case Wr.ABORTED:return mh.ABORTED;case Wr.OUT_OF_RANGE:return mh.OUT_OF_RANGE;case Wr.UNIMPLEMENTED:return mh.UNIMPLEMENTED;case Wr.DATA_LOSS:return mh.DATA_LOSS;default:return Vr("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return Vr("Unrecognized watch change: "+JSON.stringify(t))},Gl.prototype.fromWatchChange=function(t){var e,n=this;if("targetChange"in t){Kl(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new Vh(r,i,o,s||null)}else if("documentChange"in t){Kl(t.documentChange,"documentChange"),Kl(t.documentChange.document,"documentChange.name"),Kl(t.documentChange.document.name,"documentChange.document.name"),Kl(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=new _s(c,h,{},void 0,u.document,(function(t){return n.fromValue(t)})),f=u.targetIds||[],d=u.removedTargetIds||[];e=new qh(f,d,l.key,l)}else if("documentDelete"in t){Kl(t.documentDelete,"documentDelete"),Kl(t.documentDelete.document,"documentDelete.document");var p=t.documentDelete;c=this.fromName(p.document),h=p.readTime?this.fromVersion(p.readTime):oo.forDeletedDoc(),l=new xs(c,h),d=p.removedTargetIds||[],e=new qh([],d,l.key,l)}else if("documentRemove"in t){Kl(t.documentRemove,"documentRemove"),Kl(t.documentRemove.document,"documentRemove");var m=t.documentRemove;c=this.fromName(m.document),d=m.removedTargetIds||[],e=new qh([],d,c,null)}else{if(!("filter"in t))return Vr("Unknown change type "+JSON.stringify(t));Kl(t.filter,"filter"),Kl(t.filter.targetId,"filter.targetId");var y=t.filter,g=y.count||0,v=new xl(g),b=y.targetId;e=new Fh(b,v)}return e},Gl.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?Ph.NoChange:"ADD"===t?Ph.Added:"REMOVE"===t?Ph.Removed:"CURRENT"===t?Ph.Current:"RESET"===t?Ph.Reset:Vr("Got unexpected TargetChange.state: "+t)},Gl.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return oo.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?oo.MIN:e.readTime?this.fromVersion(e.readTime):oo.MIN},Gl.prototype.toMutation=function(t){var e,n=this;if(t instanceof Ca)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Fa)e={delete:this.toName(t.key)};else if(t instanceof Aa)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof Ma))return Vr("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map((function(t){return n.toFieldTransform(t)}))}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},Gl.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):wa.NONE;if(t.update){Kl(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new Aa(r,i,o,n)}return new Ca(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new Fa(r,n);if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map((function(t){return e.fromFieldTransform(t)}));return Br(!0===n.exists,'Transforms only support precondition "exists == true"'),new Ma(r,a)}return Vr("unknown mutation proto: "+JSON.stringify(t))},Gl.prototype.toPrecondition=function(t){return Br(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Vr("Unknown precondition")},Gl.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?wa.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?wa.exists(t.exists):wa.NONE},Gl.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e);r.isEqual(oo.MIN)&&(r=this.fromVersion(e));var i=null;return t.transformResults&&0<t.transformResults.length&&(i=t.transformResults.map((function(t){return n.fromValue(t)}))),new ba(r,i)},Gl.prototype.fromWriteResults=function(t,e){var n=this;return t&&0<t.length?(Br(void 0!==e,"Received a write result without a commit time"),t.map((function(t){return n.fromWriteResult(t,e)}))):[]},Gl.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Nl)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof kl)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map((function(t){return e.toValue(t)}))}};if(n instanceof Ml)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map((function(t){return e.toValue(t)}))}};if(n instanceof _l)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw Vr("Unknown transform: "+t.transform)},Gl.prototype.fromFieldTransform=function(t){var e=this,n=null;if("setToServerValue"in t)Br("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),n=Nl.instance;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new kl(r.map((function(t){return e.fromValue(t)})))}else if("removeAllFromArray"in t)r=t.removeAllFromArray.values||[],n=new Ml(r.map((function(t){return e.fromValue(t)})));else if("increment"in t){var i=this.fromValue(t.increment);Br(i instanceof Ja,"NUMERIC_ADD transform requires a NumberValue"),n=new _l(i)}else Vr("Unknown transform proto: "+JSON.stringify(t));var o=Ui.fromServerFormat(t.fieldPath);return new ma(o,n)},Gl.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},Gl.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;Br(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return Jh.atPath(this.fromQueryPath(n))},Gl.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Br(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Br(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return null!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},Gl.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(0<r){Br(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new Jh(e,i,s,a,u,c,h)},Gl.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},Gl.prototype.toLabel=function(t){switch(t){case Ou.Listen:return null;case Ou.ExistenceFilterMismatch:return"existence-filter-mismatch";case Ou.LimboResolution:return"limbo-document";default:return Vr("Unrecognized query purpose: "+t)}},Gl.prototype.toTarget=function(t){var e,n=t.query;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,0<t.resumeToken.length&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},Gl.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map((function(t){return t instanceof nl?e.toUnaryOrFieldFilter(t):Vr("Unrecognized filter: "+JSON.stringify(t))}));return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},Gl.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromFieldFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((function(t){return e.fromFilter(t)})).reduce((function(t,e){return t.concat(e)})):Vr("Unknown filter: "+JSON.stringify(t)):[]},Gl.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map((function(t){return e.toPropertyOrder(t)}))},Gl.prototype.fromOrder=function(t){var e=this;return t.map((function(t){return e.fromPropertyOrder(t)}))},Gl.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map((function(t){return e.toValue(t)}))}},Gl.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map((function(t){return e.fromValue(t)}));return new Sl(r,n)},Gl.prototype.toDirection=function(t){return Bl[t.name]},Gl.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return bl.ASCENDING;case"DESCENDING":return bl.DESCENDING;default:return}},Gl.prototype.toOperatorName=function(t){return Ul[t.name]},Gl.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return $h.EQUAL;case"GREATER_THAN":return $h.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return $h.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return $h.LESS_THAN;case"LESS_THAN_OR_EQUAL":return $h.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return $h.ARRAY_CONTAINS;case"IN":return $h.IN;case"ARRAY_CONTAINS_ANY":return $h.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return Vr("Unspecified operator");default:return Vr("Unknown operator")}},Gl.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},Gl.prototype.fromFieldPathReference=function(t){return Ui.fromServerFormat(t.fieldPath)},Gl.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},Gl.prototype.fromPropertyOrder=function(t){return new El(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},Gl.prototype.fromFieldFilter=function(t){return nl.create(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},Gl.prototype.toUnaryOrFieldFilter=function(t){if(t.op===$h.EQUAL){if(t.value.isEqual(is.NAN))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}};if(t.value.isEqual(Wa.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}},Gl.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return nl.create(e,$h.EQUAL,is.NAN);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return nl.create(n,$h.EQUAL,Wa.INSTANCE);case"OPERATOR_UNSPECIFIED":return Vr("Unspecified filter");default:return Vr("Unknown filter")}},Gl.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach((function(t){return e.push(t.canonicalString())})),{fieldPaths:e}},Gl.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map((function(t){return Ui.fromServerFormat(t)}));return da.fromArray(e)},Gl);function Gl(t,e){this.databaseId=t,this.options=e}var zl=function(){this.viewSnap=null,this.targetId=0,this.listeners=[]},Hl=(Yl.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new zl,this.queries.set(e,r)),r.listeners.push(t),Br(!t.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),!r.viewSnap||t.onViewSnapshot(r.viewSnap)&&this.raiseSnapshotsInSyncEvent(),n?this.syncEngine.listen(e).then((function(t){return r.targetId=t})):Promise.resolve(r.targetId)},Yl.prototype.unlisten=function(t){return a(this,void 0,void 0,(function(){var e,n,r,i;return s(this,(function(o){return e=t.query,n=!1,(r=this.queries.get(e))&&0<=(i=r.listeners.indexOf(t))&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]}))}))},Yl.prototype.onWatchChange=function(t){for(var e=!1,n=0,r=t;n<r.length;n++){var i=r[n],o=i.query,a=this.queries.get(o);if(a){for(var s=0,u=a.listeners;s<u.length;s++)u[s].onViewSnapshot(i)&&(e=!0);a.viewSnap=i}}e&&this.raiseSnapshotsInSyncEvent()},Yl.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},Yl.prototype.onOnlineStateChange=function(t){this.onlineState=t;var e=!1;this.queries.forEach((function(n,r){for(var i=0,o=r.listeners;i<o.length;i++)o[i].applyOnlineStateChange(t)&&(e=!0)})),e&&this.raiseSnapshotsInSyncEvent()},Yl.prototype.addSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.add(t),t.next()},Yl.prototype.removeSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.delete(t)},Yl.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach((function(t){t.next()}))},Yl);function Yl(t){this.syncEngine=t,this.queries=new Us((function(t){return t.canonicalId()})),this.onlineState=ch.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}var Xl=(Jl.prototype.onViewSnapshot=function(t){if(Br(0<t.docChanges.length||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==Sh.Metadata&&e.push(i)}t=new kh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(t)&&(this.queryObserver.next(t),o=!0):this.shouldRaiseInitialEvent(t,this.onlineState)&&(this.raiseInitialEvent(t),o=!0),this.snap=t,o},Jl.prototype.onError=function(t){this.queryObserver.error(t)},Jl.prototype.applyOnlineStateChange=function(t){this.onlineState=t;var e=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&(this.raiseInitialEvent(this.snap),e=!0),e},Jl.prototype.shouldRaiseInitialEvent=function(t,e){if(Br(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==ch.Offline;return this.options.waitForSyncWhenOnline&&n?(Br(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===ch.Offline},Jl.prototype.shouldRaiseEvent=function(t){if(0<t.docChanges.length)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},Jl.prototype.raiseInitialEvent=function(t){Br(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=kh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},Jl);function Jl(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=ch.Unknown,this.options=n||{}}var Zl=($l.fromSnapshot=function(t,e){for(var n=Ao(),r=Ao(),i=0,o=e.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case Sh.Added:n=n.add(a.doc.key);break;case Sh.Removed:r=r.add(a.doc.key)}}return new $l(t,e.fromCache,n,r)},$l);function $l(t,e,n,r){this.targetId=t,this.fromCache=e,this.addedKeys=n,this.removedKeys=r}var tf=function(t){this.key=t},ef=function(t){this.key=t},nf=(Object.defineProperty(rf.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),rf.prototype.computeDocChanges=function(t,e){var n=this,r=e?e.changeSet:new Nh,i=e?e.documentSet:this.documentSet,o=e?e.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(t.inorderTraversal((function(t,e){var c=i.get(t),h=e instanceof _s?e:null;h&&(Br(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=n.query.matches(h)?h:null);var l=!!c&&n.mutatedKeys.has(c.key),f=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),d=!1;c&&h?c.data().isEqual(h.data())?l!==f&&(r.track({type:Sh.Metadata,doc:h}),d=!0):n.shouldWaitForSyncedDocument(c,h)||(r.track({type:Sh.Modified,doc:h}),d=!0,u&&0<n.query.docComparator(h,u)&&(s=!0)):!c&&h?(r.track({type:Sh.Added,doc:h}),d=!0):c&&!h&&(r.track({type:Sh.Removed,doc:c}),d=!0,u&&(s=!0)),d&&(o=h?(a=a.add(h),f?o.add(t):o.delete(t)):(a=a.delete(t),o.delete(t)))})),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),o=o.delete(c.key),r.track({type:Sh.Removed,doc:c})}return Br(!s||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},rf.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},rf.prototype.applyChanges=function(t,e,n){var r=this;Br(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort((function(t,e){return function(t,e){function n(t){switch(t){case Sh.Added:return 1;case Sh.Modified:case Sh.Metadata:return 2;case Sh.Removed:return 0;default:return Vr("Unknown ChangeType: "+t)}}return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)})),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?Eh.Synced:Eh.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new kh(this.query,t.documentSet,i,o,t.mutatedKeys,s===Eh.Local,u,!1),limboChanges:a}:{limboChanges:a}},rf.prototype.applyOnlineStateChange=function(t){return this.current&&t===ch.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Nh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},rf.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},rf.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach((function(t){return e._syncedDocuments=e._syncedDocuments.add(t)})),t.modifiedDocuments.forEach((function(t){return Br(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")})),t.removedDocuments.forEach((function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)})),this.current=t.current)},rf.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=Ao(),this.documentSet.forEach((function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))}));var n=[];return e.forEach((function(e){t.limboDocuments.has(e)||n.push(new ef(e))})),this.limboDocuments.forEach((function(t){e.has(t)||n.push(new tf(t))})),n},rf.prototype.synchronizeWithPersistedState=function(t){this._syncedDocuments=t.remoteKeys,this.limboDocuments=Ao();var e=this.computeDocChanges(t.documents);return this.applyChanges(e,!0)},rf.prototype.computeInitialSnapshot=function(){return kh.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Eh.Local)},rf);function rf(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=Ao(),this.mutatedKeys=Ao(),this.documentSet=new Ch(t.docComparator.bind(t))}var of=(af.prototype.run=function(){this.runWithBackOff()},af.prototype.runWithBackOff=function(){var t=this;this.backoff.backoffAndRun((function(){return a(t,void 0,void 0,(function(){var t,e,n=this;return s(this,(function(r){return t=this.remoteStore.createTransaction(),(e=this.tryRunUpdateFunction(t))&&e.then((function(e){n.asyncQueue.enqueueAndForget((function(){return t.commit().then((function(){n.deferred.resolve(e)})).catch((function(t){n.handleTransactionError(t)}))}))})).catch((function(t){n.handleTransactionError(t)})),[2]}))}))}))},af.prototype.tryRunUpdateFunction=function(t){try{var e=this.updateFunction(t);return!Gc(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},af.prototype.handleTransactionError=function(t){var e=this;0<this.retries&&this.isRetryableTransactionError(t)?(this.retries-=1,this.asyncQueue.enqueueAndForget((function(){return e.runWithBackOff(),Promise.resolve()}))):this.deferred.reject(t)},af.prototype.isRetryableTransactionError=function(t){if("FirebaseError"!==t.name)return!1;var e=t.code;return"aborted"===e||"failed-precondition"===e||!bh(e)},af);function af(t,e,n,r){this.asyncQueue=t,this.remoteStore=e,this.updateFunction=n,this.deferred=r,this.retries=5,this.backoff=new Hc(this.asyncQueue,Wi.RetryTransaction)}var sf="SyncEngine",uf=function(t,e,n){this.query=t,this.targetId=e,this.view=n},cf=function(t){this.key=t,this.receivedDocument=!1},hf=(Object.defineProperty(lf.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),lf.prototype.subscribe=function(t){Br(null!==t,"SyncEngine listener cannot be null"),Br(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},lf.prototype.listen=function(t){return a(this,void 0,void 0,(function(){var e,n,r,i,o;return s(this,(function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(t))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}}))}))},lf.prototype.initializeViewAndComputeSnapshot=function(t,e){return a(this,void 0,void 0,(function(){var n,r,i,o,a,u,c;return s(this,(function(s){switch(s.label){case 0:return n=t.query,[4,this.localStore.executeQuery(n,!0)];case 1:return r=s.sent(),i=new nf(n,r.remoteKeys),o=i.computeDocChanges(r.documents),a=_h.createSynthesizedTargetChangeForCurrentChange(t.targetId,e&&this.onlineState!==ch.Offline),Br(0===(u=i.applyChanges(o,!0===this.isPrimary,a)).limboChanges.length,"View returned limbo docs before target ack from the server."),Br(!!u.snapshot,"applyChanges for new view should always return a snapshot"),c=new uf(n,t.targetId,i),this.queryViewsByQuery.set(n,c),this.queryViewsByTarget[t.targetId]=c,[2,u.snapshot]}}))}))},lf.prototype.synchronizeViewAndComputeSnapshot=function(t){return a(this,void 0,void 0,(function(){var e,n;return s(this,(function(r){switch(r.label){case 0:return[4,this.localStore.executeQuery(t.query,!0)];case 1:return e=r.sent(),n=t.view.synchronizeWithPersistedState(e),this.isPrimary&&this.updateTrackedLimbos(t.targetId,n.limboChanges),[2,n]}}))}))},lf.prototype.unlisten=function(t){return a(this,void 0,void 0,(function(){var e,n=this;return s(this,(function(r){switch(r.label){case 0:return this.assertSubscribed("unlisten()"),Br(!!(e=this.queryViewsByQuery.get(t)),"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then((function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)})).catch(uc)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(t,!0)];case 4:r.sent(),r.label=5;case 5:return[2]}}))}))},lf.prototype.write=function(t,e){return a(this,void 0,void 0,(function(){var n;return s(this,(function(r){switch(r.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(t)];case 1:return n=r.sent(),this.sharedClientState.addPendingMutation(n.batchId),this.addMutationCallback(n.batchId,e),[4,this.emitNewSnapsAndNotifyLocalStore(n.changes)];case 2:return r.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return r.sent(),[2]}}))}))},lf.prototype.runTransaction=function(t,e,n){new of(t,this.remoteStore,e,n).run()},lf.prototype.applyRemoteEvent=function(t){return a(this,void 0,void 0,(function(){var e,n=this;return s(this,(function(r){switch(r.label){case 0:this.assertSubscribed("applyRemoteEvent()"),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(t)];case 2:return e=r.sent(),Zr(t.targetChanges,(function(t,e){var r=n.limboResolutionsByTarget[Number(t)];r&&(Br(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?r.receivedDocument=!0:0<e.modifiedDocuments.size?Br(r.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(Br(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))})),[4,this.emitNewSnapsAndNotifyLocalStore(e,t)];case 3:return r.sent(),[3,6];case 4:return[4,uc(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},lf.prototype.applyOnlineStateChange=function(t,e){if(this.isPrimary&&e===lh.RemoteStore||!this.isPrimary&&e===lh.SharedClientState){this.assertSubscribed("applyOnlineStateChange()");var n=[];this.queryViewsByQuery.forEach((function(e,r){var i=r.view.applyOnlineStateChange(t);Br(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)})),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(n),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},lf.prototype.rejectListen=function(t,e){return a(this,void 0,void 0,(function(){var n,r,i,o,a,u,c=this;return s(this,(function(s){switch(s.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",e),n=this.limboResolutionsByTarget[t],(r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[t],i=(i=new so(Ki.comparator)).insert(r,new xs(r,oo.forDeletedDoc())),o=Ao().add(r),a=new Mh(oo.MIN,{},new yo(bi),i,o),[2,this.applyRemoteEvent(a)]):[3,1];case 1:return Br(!!(u=this.queryViewsByTarget[t]),"Unknown targetId: "+t),[4,this.localStore.releaseQuery(u.query,!1).then((function(){return c.removeAndCleanupQuery(u)})).catch(uc)];case 2:s.sent(),this.syncEngineListener.onWatchError(u.query,e),s.label=3;case 3:return[2]}}))}))},lf.prototype.applyBatchState=function(t,e,n){return a(this,void 0,void 0,(function(){var r;return s(this,(function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(r=i.sent())?(xr(sf,"Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.processUserCallback(t,n||null),this.localStore.removeCachedMutationBatchMetadata(t)):Vr("Unknown batchState: "+e),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}}))}))},lf.prototype.applySuccessfulWrite=function(t){return a(this,void 0,void 0,(function(){var e,n;return s(this,(function(r){switch(r.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),e=t.batch.batchId,this.processUserCallback(e,null),this.triggerPendingWritesCallbacks(e),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(t)];case 2:return n=r.sent(),this.sharedClientState.updateMutationState(e,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return r.sent(),[3,6];case 4:return[4,uc(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},lf.prototype.rejectFailedWrite=function(t,e){return a(this,void 0,void 0,(function(){var n;return s(this,(function(r){switch(r.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,e),this.triggerPendingWritesCallbacks(t),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(t)];case 2:return n=r.sent(),this.sharedClientState.updateMutationState(t,"rejected",e),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return r.sent(),[3,6];case 4:return[4,uc(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},lf.prototype.registerPendingWritesCallback=function(t){return a(this,void 0,void 0,(function(){var e,n;return s(this,(function(r){switch(r.label){case 0:return this.remoteStore.canUseNetwork()||xr(sf,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(e=r.sent())?t.resolve():((n=this.pendingWritesCallbacks.get(e)||[]).push(t),this.pendingWritesCallbacks.set(e,n)),[2]}}))}))},lf.prototype.triggerPendingWritesCallbacks=function(t){(this.pendingWritesCallbacks.get(t)||[]).forEach((function(t){t.resolve()})),this.pendingWritesCallbacks.delete(t)},lf.prototype.rejectOutstandingPendingWritesCallbacks=function(t){this.pendingWritesCallbacks.forEach((function(e){e.forEach((function(e){e.reject(new Gr(Wr.CANCELLED,t))}))})),this.pendingWritesCallbacks.clear()},lf.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n=(n=n||new so(bi)).insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},lf.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(Br(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},lf.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach((function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)}))}},lf.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},lf.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof tf?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof ef?(xr(sf,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):Vr("Unknown limbo change: "+JSON.stringify(i))}},lf.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){xr(sf,"New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=Jh.atPath(e.path);this.limboResolutionsByTarget[n]=new cf(e),this.remoteStore.listen(new Fu(r,n,Ou.LimboResolution,Mi.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},lf.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},lf.prototype.emitNewSnapsAndNotifyLocalStore=function(t,e){return a(this,void 0,void 0,(function(){var n,r,i,o=this;return s(this,(function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach((function(a,s){i.push(Promise.resolve().then((function(){var e=s.view.computeDocChanges(t);return e.needsRefill?o.localStore.executeQuery(s.query,!1).then((function(t){var n=t.documents;return s.view.computeDocChanges(n,e)})):e})).then((function(t){var i=e&&e.targetChanges[s.targetId],a=s.view.applyChanges(t,!0===o.isPrimary,i);if(o.updateTrackedLimbos(s.targetId,a.limboChanges),a.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,a.snapshot.fromCache?"not-current":"current"),n.push(a.snapshot);var u=Zl.fromSnapshot(s.targetId,a.snapshot);r.push(u)}})))})),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}}))}))},lf.prototype.assertSubscribed=function(t){Br(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},lf.prototype.handleCredentialChange=function(t){return a(this,void 0,void 0,(function(){var e,n;return s(this,(function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(t)]):[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}}))}))},lf.prototype.applyPrimaryState=function(t){return a(this,void 0,void 0,(function(){var e,n,r,i,o,a,u,c=this;return s(this,(function(s){switch(s.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return s.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=s.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,a=[],u=Promise.resolve(),Jr(this.queryViewsByTarget,(function(t,e){c.sharedClientState.isLocalQueryTarget(t)?a.push(t):u=u.then((function(){return c.unlisten(e.query)})),c.remoteStore.unlisten(e.targetId)})),[4,u]);case 4:return s.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(a)];case 5:return s.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:s.sent(),s.label=7;case 7:return[2]}}))}))},lf.prototype.resetLimboDocuments=function(){var t=this;Jr(this.limboResolutionsByTarget,(function(e){t.remoteStore.unlisten(e)})),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new so(Ki.comparator)},lf.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){return a(this,void 0,void 0,(function(){var e,n,r,i,o,a,u,c,h;return s(this,(function(s){switch(s.label){case 0:e=[],n=[],r=0,i=t,s.label=1;case 1:return r<i.length?(o=i[r],a=void 0,(u=this.queryViewsByTarget[o])?[4,this.localStore.releaseQuery(u.query,!0)]:[3,5]):[3,11];case 2:return s.sent(),[4,this.localStore.allocateQuery(u.query)];case 3:return a=s.sent(),[4,this.synchronizeViewAndComputeSnapshot(u)];case 4:return(c=s.sent()).snapshot&&n.push(c.snapshot),[3,9];case 5:return Br(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(o)];case 6:return Br(!!(h=s.sent()),"Query data for target "+o+" not found"),[4,this.localStore.allocateQuery(h)];case 7:return a=s.sent(),[4,this.initializeViewAndComputeSnapshot(a,!1)];case 8:s.sent(),s.label=9;case 9:e.push(a),s.label=10;case 10:return r++,[3,1];case 11:return this.syncEngineListener.onWatchChange(n),[2,e]}}))}))},lf.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},lf.prototype.applyTargetState=function(t,e,n){return a(this,void 0,void 0,(function(){var r,i,o;return s(this,(function(a){switch(a.label){case 0:if(this.isPrimary)return xr(sf,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,7];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,this.localStore.getNewDocumentChanges()];case 2:return r=a.sent(),i=Mh.createSynthesizedRemoteEventForCurrentChange(t,"current"===e),[4,this.emitNewSnapsAndNotifyLocalStore(r,i)];case 3:return a.sent(),[3,7];case 4:return o=this.queryViewsByTarget[t],this.removeAndCleanupQuery(o),[4,this.localStore.releaseQuery(o.query,!0)];case 5:return a.sent(),this.syncEngineListener.onWatchError(o.query,n),[3,7];case 6:Vr("Unexpected target state: "+e),a.label=7;case 7:return[2]}}))}))},lf.prototype.applyActiveTargetsChange=function(t,e){return a(this,void 0,void 0,(function(){var n,r,i,o,a,u,c,h,l,f=this;return s(this,(function(d){switch(d.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,d.label=1;case 1:return n<r.length?(l=r[n],Br(!this.queryViewsByTarget[l],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(l)]):[3,6];case 2:return Br(!!(i=d.sent()),"Query data for active target "+l+" not found"),[4,this.localStore.allocateQuery(i)];case 3:return o=d.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 4:d.sent(),this.remoteStore.listen(o),d.label=5;case 5:return n++,[3,1];case 6:a=function(t){var e;return s(this,(function(n){switch(n.label){case 0:return(e=u.queryViewsByTarget[t])?[4,u.localStore.releaseQuery(e.query,!1).then((function(){f.remoteStore.unlisten(t),f.removeAndCleanupQuery(e)})).catch(uc)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))},u=this,c=0,h=e,d.label=7;case 7:return c<h.length?(l=h[c],[5,a(l)]):[3,10];case 8:d.sent(),d.label=9;case 9:return c++,[3,7];case 10:return[2]}}))}))},lf.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},lf.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},lf.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?Ao().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:Ao()},lf);function lf(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Us((function(t){return t.canonicalId()})),this.queryViewsByTarget={},this.limboTargetsByKey=new so(Ki.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new yc,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=zo.forSyncEngine(),this.isPrimary=void 0,this.onlineState=ch.Unknown}var ff=(df.prototype.isAuthenticated=function(){return null!=this.uid},df.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},df.prototype.isEqual=function(t){return t.uid===this.uid},df.UNAUTHENTICATED=new df(null),df.GOOGLE_CREDENTIALS=new df("google-credentials-uid"),df.FIRST_PARTY=new df("first-party-uid"),df);function df(t){this.uid=t}var pf="SharedClientState",mf="firestore_clients",yf="firestore_mutations",gf="firestore_targets",vf=(bf.fromWebStorageEntry=function(t,e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Gr(r.error.code,r.error.message)),i?new bf(t,e,r.state,o):(qr(pf,"Failed to parse mutation state for ID '"+e+"': "+n),null)},bf.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},bf);function bf(t,e,n,r){this.user=t,this.batchId=e,this.state=n,Br(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}var wf=(Sf.fromWebStorageEntry=function(t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new Gr(n.error.code,n.error.message)),r?new Sf(t,n.state,i):(qr(pf,"Failed to parse target state for ID '"+t+"': "+e),null)},Sf.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Sf);function Sf(t,e,n){this.targetId=t,this.state=e,Br(void 0!==(this.error=n)==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}var Tf=(Ef.fromWebStorageEntry=function(t,e){for(var n=JSON.parse(e),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Ro(),o=0;r&&o<n.activeTargetIds.length;++o)r=zc(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new Ef(t,i):(qr(pf,"Failed to parse client data for instance '"+t+"': "+e),null)},Ef);function Ef(t,e){this.clientId=t,this.activeTargetIds=e}var If=(Cf.fromWebStorageEntry=function(t){var e=JSON.parse(t);return"object"==typeof e&&e.onlineState in ch&&"string"==typeof e.clientId?new Cf(e.clientId,ch[e.onlineState]):(qr(pf,"Failed to parse online state: "+t),null)},Cf);function Cf(t,e){this.clientId=t,this.onlineState=e}var Df=(Nf.prototype.addQueryTarget=function(t){Br(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},Nf.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},Nf.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},Nf);function Nf(){this.activeTargetIds=Ro()}var Af=(kf.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},kf.prototype.start=function(){return a(this,void 0,void 0,(function(){var t,e,n,r,i,o,a,u,c,h,l,f=this;return s(this,(function(s){switch(s.label){case 0:return Br(!this.started,"WebStorageSharedClientState already started"),Br(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Br(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=s.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=Tf.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(u=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(u),c=0,h=this.earlyEvents;c<h.length;c++)l=h[c],this.handleWebStorageEvent(l);return this.earlyEvents=[],this.platform.window.addEventListener("unload",(function(){return f.shutdown()})),this.started=!0,[2]}}))}))},kf.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},kf.prototype.getAllActiveQueryTargets=function(){var t=Ro();return Zr(this.activeClients,(function(e,n){t=t.unionWith(n.activeTargetIds)})),t},kf.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},kf.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},kf.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},kf.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=wf.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},kf.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},kf.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},kf.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},kf.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},kf.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach((function(t){r.removeMutationState(t)})),this.currentUser=t,n.forEach((function(t){r.addPendingMutation(t)}))},kf.prototype.setOnlineState=function(t){this.persistOnlineState(t)},kf.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},kf.prototype.getItem=function(t){var e=this.storage.getItem(t);return xr(pf,"READ",t,e),e},kf.prototype.setItem=function(t,e){xr(pf,"SET",t,e),this.storage.setItem(t,e)},kf.prototype.removeItem=function(t){xr(pf,"REMOVE",t),this.storage.removeItem(t)},kf.prototype.handleWebStorageEvent=function(t){var e=this;if(t.storageArea===this.storage){if(xr(pf,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void qr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget((function(){return a(e,void 0,void 0,(function(){var e,n,r,i,o,a;return s(this,(function(s){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return n=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(o=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(o)]}else t.key===this.sequenceNumberKey&&(Br(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=Mi.INVALID;if(null!=t)try{var n=JSON.parse(t);Br("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){qr(pf,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue))!==Mi.INVALID&&this.sequenceNumberHandler(a));return[2]}))}))}))}},Object.defineProperty(kf.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),kf.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},kf.prototype.persistMutationState=function(t,e,n){var r=new vf(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},kf.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},kf.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:ch[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},kf.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new wf(t,e,n);this.setItem(r,i.toWebStorageJSON())},kf.prototype.toWebStorageClientStateKey=function(t){return Br(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),mf+"_"+this.persistenceKey+"_"+t},kf.prototype.toWebStorageQueryTargetMetadataKey=function(t){return gf+"_"+this.persistenceKey+"_"+t},kf.prototype.toWebStorageMutationBatchKey=function(t){var e=yf+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},kf.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},kf.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Br(null!==n,"Cannot parse client state key '"+t+"'"),Tf.fromWebStorageEntry(n,e)},kf.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Br(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return vf.fromWebStorageEntry(new ff(i),r,e)},kf.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Br(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return wf.fromWebStorageEntry(r,e)},kf.prototype.fromWebStorageOnlineState=function(t){return If.fromWebStorageEntry(t)},kf.prototype.handleMutationBatchEvent=function(t){return a(this,void 0,void 0,(function(){return s(this,(function(e){return t.user.uid!==this.currentUser.uid?(xr(pf,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]}))}))},kf.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},kf.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],u=[];return i.forEach((function(t){return a(n,void 0,void 0,(function(){return s(this,(function(e){return r.has(t)||o.push(t),[2]}))}))})),r.forEach((function(t){return a(n,void 0,void 0,(function(){return s(this,(function(e){return i.has(t)||u.push(t),[2]}))}))})),this.syncEngine.applyActiveTargetsChange(o,u)},kf.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},kf);function kf(t,e,n,r,i){if(this.queue=t,this.platform=e,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!kf.isAvailable(this.platform))throw new Gr(Wr.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+n,this.activeClients[this.localClientId]=new Df,this.clientStateKeyRe=new RegExp("^"+mf+"_"+o+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+yf+"_"+o+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+gf+"_"+o+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+n,this.platform.window.addEventListener("storage",this.storageListener)}var Rf=(Mf.prototype.addPendingMutation=function(t){},Mf.prototype.updateMutationState=function(t,e,n){},Mf.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},Mf.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},Mf.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},Mf.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Mf.prototype.clearQueryState=function(t){delete this.queryState[t]},Mf.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},Mf.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Mf.prototype.start=function(){return this.localState=new Df,Promise.resolve()},Mf.prototype.handleUserChange=function(t,e,n){},Mf.prototype.setOnlineState=function(t){},Mf.prototype.shutdown=function(){},Mf.prototype.writeSequenceNumber=function(t){},Mf);function Mf(){this.localState=new Df,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}var Of="FirestoreClient",_f=(Lf.prototype.lruParams=function(){return Gu.withCacheSize(this.cacheSizeBytes)},Lf);function Lf(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}var Pf=function(){},xf=(qf.prototype.start=function(t){var e=this;this.verifyNotTerminated();var n=new zi,r=new zi,i=!1;return this.credentials.setChangeListener((function(o){i?e.asyncQueue.enqueueAndForget((function(){return e.handleCredentialChange(o)})):(i=!0,e.initializePersistence(t,r,o).then((function(t){return e.initializeRest(o,t)})).then(n.resolve,n.reject))})),this.asyncQueue.enqueueAndForget((function(){return n.promise})),r.promise},qf.prototype.enableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return t.syncEngine.enableNetwork()}))},qf.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof _f?this.startIndexedDbPersistence(n,t).then((function(t){return e.resolve(),t})).catch((function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.startMemoryPersistence()})):(e.resolve(),this.startMemoryPersistence())},qf.prototype.canFallback=function(t){return t instanceof Gr?t.code===Wr.FAILED_PRECONDITION||t.code===Wr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},qf.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new Gr(Wr.FAILED_PRECONDITION,"The client has already been terminated.")},qf.prototype.startIndexedDbPersistence=function(t,e){var n=this,r=ac.buildStoragePrefix(this.databaseInfo),i=new Wl(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then((function(){return a(n,void 0,void 0,(function(){var n,o;return s(this,(function(a){switch(a.label){case 0:if(e.synchronizeTabs&&!Af.isAvailable(this.platform))throw new Gr(Wr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return n=e.lruParams(),this.sharedClientState=e.synchronizeTabs?new Af(this.asyncQueue,this.platform,r,this.clientId,t):new Rf,[4,ac.createIndexedDbPersistence({allowTabSynchronization:e.synchronizeTabs,persistenceKey:r,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:i,lruParams:n,sequenceNumberSyncer:this.sharedClientState})];case 1:return o=a.sent(),[2,(this.persistence=o).referenceDelegate.garbageCollector]}}))}))}))},qf.prototype.startMemoryPersistence=function(){return this.persistence=Mc.createEagerPersistence(this.clientId),this.sharedClientState=new Rf,Promise.resolve(null)},qf.prototype.initializeRest=function(t,e){var n=this;return xr(Of,"Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then((function(r){return a(n,void 0,void 0,(function(){var n,i,o,u,c,h,l=this;return s(this,(function(f){switch(f.label){case 0:return n=new Bc,this.localStore=new Sc(this.persistence,n,t),[4,this.localStore.start()];case 1:return f.sent(),e&&(this.lruScheduler=new Hu(e,this.asyncQueue,this.localStore)),i=this.platform.newConnectivityMonitor(),o=this.platform.newSerializer(this.databaseInfo.databaseId),u=new sh(this.asyncQueue,r,this.credentials,o),c=function(t){return l.syncEngine.applyOnlineStateChange(t,lh.RemoteStore)},h=function(t){return l.syncEngine.applyOnlineStateChange(t,lh.SharedClientState)},this.remoteStore=new zh(this.localStore,u,this.asyncQueue,c,i),this.syncEngine=new hf(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=h,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Hl(this.syncEngine),[4,this.sharedClientState.start()];case 2:return f.sent(),[4,this.remoteStore.start()];case 3:return f.sent(),[4,this.persistence.setPrimaryStateListener((function(t){return a(l,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return e.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}}))}))}))];case 4:return f.sent(),[4,this.persistence.setDatabaseDeletedListener((function(){return a(l,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}}))}))}))];case 5:return f.sent(),[2]}}))}))}))},qf.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),xr(Of,"Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},qf.prototype.disableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return t.syncEngine.disableNetwork()}))},qf.prototype.terminate=function(){var t=this;return this.asyncQueue.enqueueAndInitiateShutdown((function(){return a(t,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}}))}))}))},qf.prototype.waitForPendingWrites=function(){var t=this;this.verifyNotTerminated();var e=new zi;return this.asyncQueue.enqueueAndForget((function(){return t.syncEngine.registerPendingWritesCallback(e)})),e.promise},qf.prototype.listen=function(t,e,n){var r=this;this.verifyNotTerminated();var i=new Xl(t,e,n);return this.asyncQueue.enqueueAndForget((function(){return r.eventMgr.listen(i)})),i},qf.prototype.unlisten=function(t){var e=this;this.clientTerminated||this.asyncQueue.enqueueAndForget((function(){return e.eventMgr.unlisten(t)}))},qf.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return e.localStore.readDocument(t)})).then((function(t){if(t instanceof _s)return t;if(t instanceof xs)return null;throw new Gr(Wr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")}))},qf.prototype.getDocumentsFromLocalCache=function(t){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return a(e,void 0,void 0,(function(){var e,n,r;return s(this,(function(i){switch(i.label){case 0:return[4,this.localStore.executeQuery(t,!0)];case 1:return e=i.sent(),n=new nf(t,e.remoteKeys),r=n.computeDocChanges(e.documents),[2,n.applyChanges(r,!1).snapshot]}}))}))}))},qf.prototype.write=function(t){var e=this;this.verifyNotTerminated();var n=new zi;return this.asyncQueue.enqueueAndForget((function(){return e.syncEngine.write(t,n)})),n.promise},qf.prototype.databaseId=function(){return this.databaseInfo.databaseId},qf.prototype.addSnapshotsInSyncListener=function(t){var e=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget((function(){return e.eventMgr.addSnapshotsInSyncListener(t),Promise.resolve()}))},qf.prototype.removeSnapshotsInSyncListener=function(t){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(t)},Object.defineProperty(qf.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),qf.prototype.transaction=function(t){var e=this;this.verifyNotTerminated();var n=new zi;return this.asyncQueue.enqueueAndForget((function(){return e.syncEngine.runTransaction(e.asyncQueue,t,n),Promise.resolve()})),n.promise},qf);function qf(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=gi.newId()}var Ff=(Vf.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},Vf.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},Vf.prototype.mute=function(){this.muted=!0},Vf.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout((function(){n.muted||t(e)}),0)},Vf);function Vf(t){this.observer=t,this.muted=!1}var Bf=(Uf.documentId=function(){return Uf._DOCUMENT_ID},Uf.prototype.isEqual=function(t){if(!(t instanceof Uf))throw pi("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},Uf._DOCUMENT_ID=new Uf(Ui.keyField().canonicalString()),Uf);function Uf(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<1)throw new Gr(Wr.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least "+yi(1,"element")+".")}(0,t);for(var n=0;n<t.length;++n)if(ii("FieldPath","string",n,t[n]),0===t[n].length)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Ui(t)}var Qf=new RegExp("[~\\*/\\[\\]]"),Kf=function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}},jf=(Wf.prototype.getToken=function(){return Promise.resolve(null)},Wf.prototype.invalidateToken=function(){},Wf.prototype.setChangeListener=function(t){Br(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(ff.UNAUTHENTICATED)},Wf.prototype.removeChangeListener=function(){Br(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},Wf);function Wf(){this.changeListener=null}var Gf=(zf.prototype.getToken=function(){var t=this;Br(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then((function(n){if(t.tokenCounter!==e)throw new Gr(Wr.ABORTED,"getToken aborted due to token change.");return n?(Br("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new Kf(n.accessToken,t.currentUser)):null}))},zf.prototype.invalidateToken=function(){this.forceRefresh=!0},zf.prototype.setChangeListener=function(t){Br(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(this.currentUser)},zf.prototype.removeChangeListener=function(){Br(null!=this.tokenListener,"removeChangeListener() called twice"),Br(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},zf.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Br(null===t||"string"==typeof t,"Received invalid UID: "+t),new ff(t)},zf);function zf(t){var e=this;this.app=t,this.tokenListener=null,this.currentUser=ff.UNAUTHENTICATED,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.currentUser=this.getUser(),this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}var Hf=(Object.defineProperty(Yf.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),Yf);function Yf(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=ff.FIRST_PARTY}var Xf=(Jf.prototype.getToken=function(){return Promise.resolve(new Hf(this.gapi,this.sessionIndex))},Jf.prototype.setChangeListener=function(t){t(ff.FIRST_PARTY)},Jf.prototype.removeChangeListener=function(){},Jf.prototype.invalidateToken=function(){},Jf);function Jf(t,e){this.gapi=t,this.sessionIndex=e}function Zf(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=["next","error","complete"];r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t)}var $f=(td.delete=function(){return ti("FieldValue.delete",arguments),nd.instance},td.serverTimestamp=function(){return ti("FieldValue.serverTimestamp",arguments),od.instance},td.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ni("FieldValue.arrayUnion",arguments,1),new ud(t)},td.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ni("FieldValue.arrayRemove",arguments,1),new ld(t)},td.increment=function(t){return ii("FieldValue.increment","number",1,t),ei("FieldValue.increment",arguments,1),new pd(t)},td.prototype.isEqual=function(t){return this===t},td);function td(t){this._methodName=t}var ed,nd=(n(rd,ed=$f),rd.instance=new rd,rd);function rd(){return ed.call(this,"FieldValue.delete")||this}var id,od=(n(ad,id=$f),ad.instance=new ad,ad);function ad(){return id.call(this,"FieldValue.serverTimestamp")||this}var sd,ud=(n(cd,sd=$f),cd);function cd(t){var e=sd.call(this,"FieldValue.arrayUnion")||this;return e._elements=t,e}var hd,ld=(n(fd,hd=$f),fd);function fd(t){var e=hd.call(this,"FieldValue.arrayRemove")||this;return e._elements=t,e}var dd,pd=(n(md,dd=$f),md);function md(t){var e=dd.call(this,"FieldValue.increment")||this;return e._operand=t,e}var yd=Hr($f,"Use FieldValue.<field>() instead."),gd=/^__.*__$/,vd=(bd.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new Aa(t,this.data,this.fieldMask,e)):n.push(new Ca(t,this.data,e)),0<this.fieldTransforms.length&&n.push(new Ma(t,this.fieldTransforms)),n},bd);function bd(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}var wd,Sd,Td=(Ed.prototype.toMutations=function(t,e){var n=[new Aa(t,this.data,this.fieldMask,e)];return 0<this.fieldTransforms.length&&n.push(new Ma(t,this.fieldTransforms)),n},Ed);function Ed(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function Id(t){switch(t){case wd.Set:case wd.MergeSet:case wd.Update:return!0;case wd.Argument:return!1;default:throw Vr("Unexpected case for UserDataSource: "+t)}}(Sd=wd=wd||{})[Sd.Set=0]="Set",Sd[Sd.Update=1]="Update",Sd[Sd.MergeSet=2]="MergeSet",Sd[Sd.Argument=3]="Argument";var Cd=(Dd.prototype.childContextForField=function(t){var e=null==this.path?null:this.path.child(t),n=new Dd(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePathSegment(t),n},Dd.prototype.childContextForFieldPath=function(t){var e=null==this.path?null:this.path.child(t),n=new Dd(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePath(),n},Dd.prototype.childContextForArray=function(t){return new Dd(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},Dd.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Gr(Wr.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},Dd.prototype.contains=function(t){return void 0!==this.fieldMask.find((function(e){return t.isPrefixOf(e)}))||void 0!==this.fieldTransforms.find((function(e){return t.isPrefixOf(e.field)}))},Dd.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},Dd.prototype.validatePathSegment=function(t){if(Id(this.dataSource)&&gd.test(t))throw this.createError("Document fields cannot begin and end with __")},Dd);function Dd(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}var Nd=function(t,e){this.databaseId=t,this.key=e},Ad=(kd.prototype.parseSetData=function(t,e){var n=new Cd(wd.Set,t,Ui.EMPTY_PATH);Md("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new vd(r,null,n.fieldTransforms)},kd.prototype.parseMergeData=function(t,e,n){var r=new Cd(wd.MergeSet,t,Ui.EMPTY_PATH);Md("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new yo(Ui.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof Bf)l=h._internalPath;else{if("string"!=typeof h)throw Vr("Expected stringOrFieldPath to be a string or a FieldPath");l=_d(t,h)}if(!r.contains(l))throw new Gr(Wr.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=da.fromSet(s),o=r.fieldTransforms.filter((function(t){return i.covers(t.field)}))}else i=da.fromArray(r.fieldMask),o=r.fieldTransforms;return new vd(a,i,o)},kd.prototype.parseUpdateData=function(t,e){var n=this,r=new Cd(wd.Update,t,Ui.EMPTY_PATH);Md("Data must be an object, but it was:",r,e);var i=new yo(Ui.comparator),o=Cs.EMPTY;Zr(e,(function(e,a){var s=_d(t,e),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof nd)i=i.add(s);else{var c=n.parseData(a,u);null!=c&&(i=i.add(s),o=o.set(s,c))}}));var a=da.fromSet(i);return new Td(o,a,r.fieldTransforms)},kd.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Cd(wd.Update,t,Ui.EMPTY_PATH),o=[Od(t,e)],a=[n];if(r.length%2!=0)throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Od(t,r[s])),a.push(r[s+1]);var u=new yo(Ui.comparator),c=Cs.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof nd)u=u.add(h);else{var d=this.parseData(f,l);null!=d&&(u=u.add(h),c=c.set(h,d))}}var p=da.fromSet(u);return new Td(c,p,i.fieldTransforms)},kd.prototype.parseQueryValue=function(t,e){var n=new Cd(wd.Argument,t,Ui.EMPTY_PATH),r=this.parseData(e,n);return Br(null!=r,"Parsed data should not be null."),Br(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},kd.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Ld(t);throw e.createError(n)}},kd.prototype.parseData=function(t,e){if(Rd(t=this.runPreConverter(t,e)))return Md("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof $f)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},kd.prototype.parseObject=function(t,e){var n=this,r=new so(bi);return $r(t)?e.path&&0<e.path.length&&e.fieldMask.push(e.path):Zr(t,(function(t,i){var o=n.parseData(i,e.childContextForField(t));null!=o&&(r=r.insert(t,o))})),new Cs(r)},kd.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],s=this.parseData(a,e.childContextForArray(r));null==s&&(s=Wa.INSTANCE),n.push(s),r++}return new As(n)},kd.prototype.parseSentinelFieldValue=function(t,e){if(!Id(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof nd){if(e.dataSource!==wd.MergeSet)throw e.dataSource===wd.Update?(Br(0<e.path.length,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof od)e.fieldTransforms.push(new ma(e.path,Nl.instance));else if(t instanceof ud){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new kl(n);e.fieldTransforms.push(new ma(e.path,r))}else if(t instanceof ld){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new Ml(n);e.fieldTransforms.push(new ma(e.path,i))}else if(t instanceof pd){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new _l(o);e.fieldTransforms.push(new ma(e.path,a))}else Vr("Unknown FieldValue type: "+t)},kd.prototype.parseScalarValue=function(t,e){if(null===t)return Wa.INSTANCE;if("number"==typeof t)return zc(t)?new es(t):new is(t);if("boolean"==typeof t)return Ha.of(t);if("string"==typeof t)return new ss(t);if(t instanceof Date)return new hs(ro.fromDate(t));if(t instanceof ro)return new hs(new ro(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof Yh)return new Ts(t);if(t instanceof Ii)return new ys(t);if(t instanceof Nd)return new bs(t.databaseId,t.key);throw e.createError("Unsupported field value: "+li(t))},kd.prototype.parseArrayTransformElements=function(t,e){var n=this;return e.map((function(e,r){var i=new Cd(wd.Argument,t,Ui.EMPTY_PATH);return n.parseData(e,i.childContextForArray(r))}))},kd);function kd(t){this.preConverter=t}function Rd(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof ro||t instanceof Yh||t instanceof Ii||t instanceof Nd||t instanceof $f)}function Md(t,e,n){if(!Rd(n)||!hi(n)){var r=li(n);throw"an object"===r?e.createError(t+" a custom object"):e.createError(t+" "+r)}}function Od(t,e){if(e instanceof Bf)return e._internalPath;if("string"==typeof e)return _d(t,e);throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function _d(t,e){try{return function(t){if(0<=t.search(Qf))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(Bf.bind.apply(Bf,u([void 0],t.split("."))))}catch(e){throw new Gr(Wr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=Ld(e);throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function Ld(t){return t instanceof Error?t.message:t.toString()}var Pd=Gu.COLLECTION_DISABLED,xd=(qd.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},qd);function qd(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Gr(Wr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else ai("settings","non-empty string","host",t.host),this.host=t.host,si("settings","boolean","ssl",t.ssl),this.ssl=Xr(t.ssl,!0);if(di("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),si("settings","object","credentials",t.credentials),this.credentials=t.credentials,si("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?qr("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&qr("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=Xr(t.timestampsInSnapshots,!0),si("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=Gu.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Pd&&t.cacheSizeBytes<Gu.MINIMUM_CACHE_SIZE_BYTES)throw new Gr(Wr.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Gu.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}si("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0!==t.experimentalForceLongPolling&&t.experimentalForceLongPolling}var Fd=(Vd.prototype.settings=function(t){if(ei("Firestore.settings",arguments,1),ii("Firestore.settings","object",1,t),Yr(t,"persistence"))throw new Gr(Wr.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new xd(t);if(this._firestoreClient&&!this._settings.isEqual(e))throw new Gr(Wr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._settings=e).credentials&&(this._credentials=function(t){if(!t)return new jf;switch(t.type){case"gapi":var e=t.client;return Br(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Xf(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Gr(Wr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},Vd.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},Vd.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},Vd.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Gr(Wr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&qr("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=Xr(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1)),this.configureClient(new _f(this._settings.cacheSizeBytes,e))},Vd.prototype.clearPersistence=function(){var t=this,e=ac.buildStoragePrefix(this.makeDatabaseInfo()),n=new zi;return this._queue.enqueueAndForgetEvenAfterShutdown((function(){return a(t,void 0,void 0,(function(){var t;return s(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new Gr(Wr.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,ac.clearPersistence(e)];case 1:return r.sent(),n.resolve(),[3,3];case 2:return t=r.sent(),n.reject(t),[3,3];case 3:return[2]}}))}))})),n.promise},Vd.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(Vd.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),Vd.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},Vd.prototype.onSnapshotsInSync=function(t){if(this.ensureClientConfigured(),Zf(t))return this.onSnapshotsInSyncInternal(t);ii("Firestore.onSnapshotsInSync","function",1,t);var e={next:t};return this.onSnapshotsInSyncInternal(e)},Vd.prototype.onSnapshotsInSyncInternal=function(t){var e=this,n=new Ff({next:function(){t.next&&t.next()},error:function(t){throw Vr("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(n),function(){n.mute(),e._firestoreClient.removeSnapshotsInSyncListener(n)}},Vd.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Pf),this._firestoreClient},Vd.prototype.makeDatabaseInfo=function(){return new Ni(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},Vd.prototype.configureClient=function(t){Br(!!this._settings.host,"FirestoreSettings.host is not set"),Br(!this._firestoreClient,"configureClient() called multiple times");var e=this.makeDatabaseInfo();return this._firestoreClient=new xf(Ur.getPlatform(),e,this._credentials,this._queue),this._firestoreClient.start(t)},Vd.prototype.createDataConverter=function(t){return new Ad((function(e){if(e instanceof jd){var n=t,r=e.firestore._databaseId;if(!r.isEqual(n))throw new Gr(Wr.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new Nd(t,e._key)}return e}))},Vd.databaseIdFromApp=function(t){var e=t.options;if(!Yr(e,"projectId"))throw new Gr(Wr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Gr(Wr.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new ki(n)},Object.defineProperty(Vd.prototype,"app",{get:function(){if(!this._firebaseApp)throw new Gr(Wr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),Vd.prototype.collection=function(t){return ei("Firestore.collection",arguments,1),ii("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new ip(qi.fromString(t),this)},Vd.prototype.doc=function(t){return ei("Firestore.doc",arguments,1),ii("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),jd.forPath(qi.fromString(t),this)},Vd.prototype.collectionGroup=function(t){if(ei("Firestore.collectionGroup",arguments,1),ii("Firestore.collectionGroup","non-empty string",1,t),0<=t.indexOf("/"))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new $d(new Jh(qi.EMPTY_PATH,t),this)},Vd.prototype.runTransaction=function(t){var e=this;return ei("Firestore.runTransaction",arguments,1),ii("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction((function(n){return t(new Bd(e,n))}))},Vd.prototype.batch=function(){return this.ensureClientConfigured(),new Qd(this)},Object.defineProperty(Vd,"logLevel",{get:function(){switch(Lr()){case Ir.DEBUG:return"debug";case Ir.ERROR:return"error";case Ir.SILENT:return"silent";default:return Vr("Unknown log level: "+Lr())}},enumerable:!0,configurable:!0}),Vd.setLogLevel=function(t){switch(ei("Firestore.setLogLevel",arguments,1),ii("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":Pr(Ir.DEBUG);break;case"error":Pr(Ir.ERROR);break;case"silent":Pr(Ir.SILENT);break;default:throw new Gr(Wr.INVALID_ARGUMENT,"Invalid log level: "+t)}},Vd.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},Vd);function Vd(t){var e=this;if(this._firebaseApp=null,this._queue=new Xi,this.INTERNAL={delete:function(){return a(e,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return t.sent(),[2]}}))}))}},"object"==typeof t.options){var n=t;this._firebaseApp=n,this._databaseId=Vd.databaseIdFromApp(n),this._persistenceKey=n.name,this._credentials=new Gf(n)}else{var r=t;if(!r.projectId)throw new Gr(Wr.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new ki(r.projectId,r.database),this._persistenceKey="[DEFAULT]",this._credentials=new jf}this._settings=new xd({}),this._dataConverter=this.createDataConverter(this._databaseId)}var Bd=(Ud.prototype.get=function(t){var e=this;ei("Transaction.get",arguments,1);var n=cp("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then((function(t){if(!t||1!==t.length)return Vr("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof xs)return new Hd(e._firestore,n._key,null,!1,!1);if(r instanceof _s)return new Hd(e._firestore,n._key,r,!1,!1);throw Vr("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)}))},Ud.prototype.set=function(t,e,n){ri("Transaction.set",arguments,2,3);var r=cp("Transaction.set",t,this._firestore),i=(n=ap("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},Ud.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return i="string"==typeof e||e instanceof Bf?(ni("Transaction.update",arguments,3),r=cp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):(ei("Transaction.update",arguments,2),r=cp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},Ud.prototype.delete=function(t){ei("Transaction.delete",arguments,1);var e=cp("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},Ud);function Ud(t,e){this._firestore=t,this._transaction=e}var Qd=(Kd.prototype.set=function(t,e,n){ri("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=cp("WriteBatch.set",t,this._firestore),i=(n=ap("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,wa.NONE)),this},Kd.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),i="string"==typeof e||e instanceof Bf?(ni("WriteBatch.update",arguments,3),r=cp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):(ei("WriteBatch.update",arguments,2),r=cp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,wa.exists(!0))),this},Kd.prototype.delete=function(t){ei("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=cp("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Fa(e._key,wa.NONE)),this},Kd.prototype.commit=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]}))}))},Kd.prototype.verifyNotCommitted=function(){if(this._committed)throw new Gr(Wr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},Kd);function Kd(t){this._firestore=t,this._mutations=[],this._committed=!1}var jd=(Wd.forPath=function(t,e){if(t.length%2!=0)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new Wd(new Ki(t),e)},Object.defineProperty(Wd.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(Wd.prototype,"parent",{get:function(){return new ip(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(Wd.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),Wd.prototype.collection=function(t){if(ei("DocumentReference.collection",arguments,1),ii("DocumentReference.collection","non-empty string",1,t),!t)throw new Gr(Wr.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=qi.fromString(t);return new ip(this._key.path.child(e),this.firestore)},Wd.prototype.isEqual=function(t){if(!(t instanceof Wd))throw pi("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)},Wd.prototype.set=function(t,e){ri("DocumentReference.set",arguments,1,2);var n=(e=ap("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,wa.NONE))},Wd.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return n="string"==typeof t||t instanceof Bf?(ni("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):(ei("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,wa.exists(!0)))},Wd.prototype.delete=function(){return ei("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Fa(this._key,wa.NONE)])},Wd.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ri("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Zf(t[i])||(di("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),si("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return n=Zf(t[i])?t[i]:(ii("DocumentReference.onSnapshot","function",i,t[i]),oi("DocumentReference.onSnapshot","function",i+1,t[i+1]),oi("DocumentReference.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},Wd.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Ff({next:function(t){if(e.next){Br(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n._key);e.next(new Hd(n.firestore,n._key,r,t.fromCache,t.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(Jh.atPath(this._key.path),i,t);return function(){i.mute(),n._firestoreClient.unlisten(o)}},Wd.prototype.get=function(t){var e=this;return ri("DocumentReference.get",arguments,0,1),up("DocumentReference.get",t),new Promise((function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentFromLocalCache(e._key).then((function(t){n(new Hd(e.firestore,e._key,t,!0,t instanceof _s&&t.hasLocalMutations))}),r):e.getViaSnapshotListener(n,r,t)}))},Wd.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new Gr(Wr.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new Gr(Wr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},Wd);function Wd(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}var Gd=(zd.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},zd);function zd(t,e){this.hasPendingWrites=t,this.fromCache=e}var Hd=(Yd.prototype.data=function(t){return ri("DocumentSnapshot.data",arguments,0,1),t=sp("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data(),Ba.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},Yd.prototype.get=function(t,e){if(ri("DocumentSnapshot.get",arguments,1,2),e=sp("DocumentSnapshot.get",e),this._document){var n=this._document.data().field(Od("DocumentSnapshot.get",t));if(null!==n)return this.convertValue(n,Ba.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(Yd.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(Yd.prototype,"ref",{get:function(){return new jd(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(Yd.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(Yd.prototype,"metadata",{get:function(){return new Gd(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),Yd.prototype.isEqual=function(t){if(!(t instanceof Yd))throw pi("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))},Yd.prototype.convertObject=function(t,e){var n=this,r={};return t.forEach((function(t,i){r[t]=n.convertValue(i,e)})),r},Yd.prototype.convertValue=function(t,e){if(t instanceof Cs)return this.convertObject(t,e);if(t instanceof As)return this.convertArray(t,e);if(t instanceof bs){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||qr("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new jd(n,this._firestore)}return t.value(e)},Yd.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map((function(t){return n.convertValue(t,e)}))},Yd);function Yd(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}var Xd,Jd=(n(Zd,Xd=Hd),Zd.prototype.data=function(t){var e=Xd.prototype.data.call(this,t);return Br("object"==typeof e,"Document in a QueryDocumentSnapshot should exist"),e},Zd);function Zd(){return null!==Xd&&Xd.apply(this,arguments)||this}var $d=(tp.prototype.where=function(t,e,n){ei("Query.where",arguments,3),fi("Query.where",3,n),"in"!==e&&"array-contains-any"!==e&&function(t,e,n,r){if(!e.some((function(t){return t===r})))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid value "+li(r)+" provided to function Query.where() for its "+mi(2)+" argument. Acceptable values: "+e.join(", "))}(0,["<","<=","==",">=",">","array-contains"],0,e);var r,i=Od("Query.where",t),o=$h.fromString(e);if(i.isKeyField()){if(o===$h.ARRAY_CONTAINS||o===$h.ARRAY_CONTAINS_ANY)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o.toString()+"' queries on FieldPath.documentId().");if(o===$h.IN){this.validateDisjunctiveFilterElements(n,o);for(var a=[],s=0,u=n;s<u.length;s++){var c=u[s];a.push(this.parseDocumentIdValue(c))}r=new As(a)}else r=this.parseDocumentIdValue(n)}else o!==$h.IN&&o!==$h.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(n,o),r=this.firestore._dataConverter.parseQueryValue("Query.where",n);var h=nl.create(i,o,r);return this.validateNewFilter(h),new tp(this._query.addFilter(h),this.firestore)},tp.prototype.orderBy=function(t,e){var n;if(ri("Query.orderBy",arguments,1,2),oi("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)n=bl.ASCENDING;else{if("desc"!==e)throw new Gr(Wr.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");n=bl.DESCENDING}if(null!==this._query.startAt)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var r=Od("Query.orderBy",t),i=new El(r,n);return this.validateNewOrderBy(i),new tp(this._query.addOrderBy(i),this.firestore)},tp.prototype.limit=function(t){if(ei("Query.limit",arguments,1),ii("Query.limit","number",1,t),t<=0)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. Query limit ("+t+") is invalid. Limit must be positive.");return new tp(this._query.withLimit(t),this.firestore)},tp.prototype.startAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];ni("Query.startAt",arguments,1);var r=this.boundFromDocOrFields("Query.startAt",t,e,!0);return new tp(this._query.withStartAt(r),this.firestore)},tp.prototype.startAfter=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];ni("Query.startAfter",arguments,1);var r=this.boundFromDocOrFields("Query.startAfter",t,e,!1);return new tp(this._query.withStartAt(r),this.firestore)},tp.prototype.endBefore=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];ni("Query.endBefore",arguments,1);var r=this.boundFromDocOrFields("Query.endBefore",t,e,!0);return new tp(this._query.withEndAt(r),this.firestore)},tp.prototype.endAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];ni("Query.endAt",arguments,1);var r=this.boundFromDocOrFields("Query.endAt",t,e,!1);return new tp(this._query.withEndAt(r),this.firestore)},tp.prototype.isEqual=function(t){if(!(t instanceof tp))throw pi("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},tp.prototype.boundFromDocOrFields=function(t,e,n,r){if(fi(t,1,e),e instanceof Hd){if(0<n.length)throw new Gr(Wr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Gr(Wr.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},tp.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new bs(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof ds)throw new Gr(Wr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){var u=a.field.canonicalString();throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Sl(r,n)},tp.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Gr(Wr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(qi.fromString(a));if(!Ki.isDocumentKey(s))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Ki(s);i.push(new bs(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new Sl(i,n)},tp.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ri("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||Zf(t[i])||(di("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),si("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),n=Zf(t[i])?t[i]:(ii("Query.onSnapshot","function",i,t[i]),oi("Query.onSnapshot","function",i+1,t[i+1]),oi("Query.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},tp.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Ff({next:function(t){e.next&&e.next(new ep(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},tp.prototype.get=function(t){var e=this;return ri("Query.get",arguments,0,1),up("Query.get",t),new Promise((function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentsFromLocalCache(e._query).then((function(t){n(new ep(e.firestore,e._query,t))}),r):e.getViaSnapshotListener(n,r,t)}))},tp.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new Gr(Wr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},tp.prototype.parseDocumentIdValue=function(t){if("string"==typeof t){if(""===t)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==t.indexOf("/"))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var e=this._query.path.child(qi.fromString(t));if(!Ki.isDocumentKey(e))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+e+"' is not because it has an odd number of segments ("+e.length+").");return new bs(this.firestore._databaseId,new Ki(e))}if(t instanceof jd){var n=t;return new bs(this.firestore._databaseId,n._key)}throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+li(t)+".")},tp.prototype.validateDisjunctiveFilterElements=function(t,e){if(!Array.isArray(t)||0===t.length)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(10<t.length)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.");if(0<=t.indexOf(null))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'null' in the value array.");if(0<t.filter((function(t){return Number.isNaN(t)})).length)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'NaN' in the value array.")},tp.prototype.validateNewFilter=function(t){if(t instanceof nl){var e=[$h.ARRAY_CONTAINS,$h.ARRAY_CONTAINS_ANY],n=[$h.IN,$h.ARRAY_CONTAINS_ANY],r=0<=e.indexOf(t.op),i=0<=n.indexOf(t.op);if(t.isInequality()){var o=this._query.getInequalityFilterField();if(null!==o&&!o.isEqual(t.field))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+o.toString()+"' and '"+t.field.toString()+"'");var a=this._query.getFirstOrderByField();null!==a&&this.validateOrderByAndInequalityMatch(t.field,a)}else if(i||r){var s=null;if(i&&(s=this._query.findFilterOperator(n)),null===s&&r&&(s=this._query.findFilterOperator(e)),null!=s)throw s===t.op?new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+s.toString()+"' filters.")}}},tp.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},tp.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Gr(Wr.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},tp);function tp(t,e){this._query=t,this.firestore=e}var ep=(Object.defineProperty(np.prototype,"docs",{get:function(){var t=[];return this.forEach((function(e){return t.push(e)})),t},enumerable:!0,configurable:!0}),Object.defineProperty(np.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(np.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),np.prototype.forEach=function(t,e){var n=this;ri("QuerySnapshot.forEach",arguments,1,2),ii("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach((function(r){t.call(e,n.convertToDocumentImpl(r))}))},Object.defineProperty(np.prototype,"query",{get:function(){return new $d(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),np.prototype.docChanges=function(t){t&&(di("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),si("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Gr(Wr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map((function(e){var o=new Jd(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key));return Br(e.type===Sh.Added,"Invalid event type for first snapshot"),Br(!r||n.query.docComparator(r,e.doc)<0,"Got added events in wrong order"),r=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}}))}var o=n.oldDocs;return n.docChanges.filter((function(t){return e||t.type!==Sh.Metadata})).map((function(e){var r=new Jd(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key)),i=-1,a=-1;return e.type!==Sh.Added&&(Br(0<=(i=o.indexOf(e.doc.key)),"Index for document not found"),o=o.delete(e.doc.key)),e.type!==Sh.Removed&&(a=(o=o.add(e.doc)).indexOf(e.doc.key)),{type:function(t){switch(t){case Sh.Added:return"added";case Sh.Modified:case Sh.Metadata:return"modified";case Sh.Removed:return"removed";default:return Vr("Unknown change type: "+t)}}(e.type),doc:r,oldIndex:i,newIndex:a}}))}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},np.prototype.isEqual=function(t){if(!(t instanceof np))throw pi("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)},np.prototype.convertToDocumentImpl=function(t){return new Jd(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},np);function np(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new Gd(n.hasPendingWrites,n.fromCache)}u(["length","forEach","map"],"undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach((function(t){try{Object.defineProperty(ep.prototype.docChanges,t,{get:function(){return function(){throw new Gr(Wr.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}}));var rp,ip=(n(op,rp=$d),Object.defineProperty(op.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(op.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new jd(new Ki(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(op.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),op.prototype.doc=function(t){if(ri("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=gi.newId()),ii("CollectionReference.doc","non-empty string",1,t),""===t)throw new Gr(Wr.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=qi.fromString(t);return jd.forPath(this._query.path.child(e),this.firestore)},op.prototype.add=function(t){ei("CollectionReference.add",arguments,1),ii("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then((function(){return e}))},op);function op(t,e){var n=rp.call(this,Jh.atPath(t),e)||this;if(t.length%2!=1)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return n}function ap(t,e){if(void 0===e)return{merge:!1};if(di(t,e,["merge","mergeFields"]),si(t,"boolean","merge",e.merge),function(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+li(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Gr(Wr.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+li(r[o]))}(t,e,n,r,i)}(t,"mergeFields","a string or a FieldPath",e.mergeFields,(function(t){return"string"==typeof t||t instanceof Bf})),void 0!==e.mergeFields&&void 0!==e.merge)throw new Gr(Wr.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function sp(t,e){return void 0===e?{}:(di(t,e,["serverTimestamps"]),ui(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function up(t,e){oi(t,"object",1,e),e&&(di(t,e,["source"]),ui(t,0,"source",e.source,["default","server","cache"]))}function cp(t,e,n){if(e instanceof jd){if(e.firestore!==n)throw new Gr(Wr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw pi(t,"DocumentReference",1,e)}var hp=Hr(Fd,"Use firebase.firestore() instead."),lp=Hr(Bd,"Use firebase.firestore().runTransaction() instead."),fp=Hr(Qd,"Use firebase.firestore().batch() instead."),dp=Hr(jd,"Use firebase.firestore().doc() instead."),pp=Hr(Hd),mp=Hr(Jd),yp=Hr($d),gp=Hr(ep),vp=Hr(ip,"Use firebase.firestore().collection() instead."),bp={Firestore:hp,GeoPoint:Yh,Timestamp:ro,Blob:Di,Transaction:lp,WriteBatch:fp,DocumentReference:dp,DocumentSnapshot:pp,Query:yp,QueryDocumentSnapshot:mp,QuerySnapshot:gp,CollectionReference:vp,FieldPath:Bf,FieldValue:yd,setLogLevel:Fd.setLogLevel,CACHE_SIZE_UNLIMITED:Pd};var wp=(Sp.prototype.addCallback=function(t){},Sp.prototype.shutdown=function(){},Sp);function Sp(){}var Tp="ConnectivityMonitor",Ep=(Ip.prototype.addCallback=function(t){this.callbacks.push(t)},Ip.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Ip.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Ip.prototype.onNetworkAvailable=function(){xr(Tp,"Network connectivity changed: AVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(0)},Ip.prototype.onNetworkUnavailable=function(){xr(Tp,"Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(1)},Ip.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},Ip);function Ip(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}var Cp=(Dp.prototype.onOpen=function(t){Br(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},Dp.prototype.onClose=function(t){Br(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},Dp.prototype.onMessage=function(t){Br(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},Dp.prototype.close=function(){this.closeFn()},Dp.prototype.send=function(t){this.sendFn(t)},Dp.prototype.callOnOpen=function(){Br(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Dp.prototype.callOnClose=function(t){Br(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},Dp.prototype.callOnMessage=function(t){Br(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},Dp);function Dp(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}var Np="Connection",Ap={BatchGetDocuments:"batchGet",Commit:"commit"},kp="gl-js/ fire/"+Or,Rp=(Mp.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=kp},Mp.prototype.invokeRPC=function(t,e,n){var r=this,i=this.makeUrl(t);return new Promise((function(a,s){var u=new Mr;u.listenOnce(kr.COMPLETE,(function(){try{switch(u.getLastErrorCode()){case Ar.NO_ERROR:var e=u.getResponseJson();xr(Np,"XHR received:",JSON.stringify(e)),a(e);break;case Ar.TIMEOUT:xr(Np,'RPC "'+t+'" timed out'),s(new Gr(Wr.DEADLINE_EXCEEDED,"Request time out"));break;case Ar.HTTP_ERROR:var n=u.getStatus();if(xr(Np,'RPC "'+t+'" failed with status:',n,"response text:",u.getResponseText()),0<n){var r=u.getResponseJson().error;if(r&&r.status&&r.message){var i=function(t){var e=t.toLowerCase().replace("_","-");return 0<=Object.values(Wr).indexOf(e)?e:Wr.UNKNOWN}(r.status);s(new Gr(i,r.message))}else s(new Gr(Wr.UNKNOWN,"Server responded with status "+u.getStatus()))}else xr(Np,'RPC "'+t+'" failed'),s(new Gr(Wr.UNAVAILABLE,"Connection failed."));break;default:Vr('RPC "'+t+'" failed with unanticipated webchannel error '+u.getLastErrorCode()+": "+u.getLastError()+", giving up.")}}finally{xr(Np,'RPC "'+t+'" completed.')}}));var c=o({},e);delete c.database;var h=JSON.stringify(c);xr(Np,"XHR sending: ",i+" "+h);var l={"Content-Type":"text/plain"};r.modifyHeadersForRequest(l,n),u.send(i,"POST",h,l,15)}))},Mp.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},Mp.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Nr(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");function a(t,e){s.listen(t,(function(t){try{e(t)}catch(t){setTimeout((function(){throw t}),0)}}))}xr(Np,"Creating WebChannel: "+o+" "+i);var s=r.createWebChannel(o,i),u=!1,c=!1,h=new Cp({sendFn:function(t){c?xr(Np,"Not sending because WebChannel is closed:",t):(u||(xr(Np,"Opening WebChannel transport."),s.open(),u=!0),xr(Np,"WebChannel sending:",t),s.send(t))},closeFn:function(){return s.close()}});return a(Rr.EventType.OPEN,(function(){c||xr(Np,"WebChannel transport opened.")})),a(Rr.EventType.CLOSE,(function(){c||(c=!0,xr(Np,"WebChannel transport closed"),h.callOnClose())})),a(Rr.EventType.ERROR,(function(t){c||(c=!0,xr(Np,"WebChannel transport errored:",t),h.callOnClose(new Gr(Wr.UNAVAILABLE,"The operation could not be completed")))})),a(Rr.EventType.MESSAGE,(function(t){if(!c){var e=t.data[0];Br(!!e,"Got a webchannel message without data.");var n=e,r=n.error||n[0]&&n[0].error;if(r){xr(Np,"WebChannel received error:",r);var i=r.status,o=function(t){var e=mh[t];if(void 0!==e)return wh(e)}(i),a=r.message;void 0===o&&(o=Wr.INTERNAL,a="Unknown error status: "+i+" with message "+r.message),c=!0,h.callOnClose(new Gr(o,a)),s.close()}else xr(Np,"WebChannel received:",e),h.callOnMessage(e)}})),setTimeout((function(){h.callOnOpen()}),0),h},Mp.prototype.makeUrl=function(t){var e=Ap[t];Br(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},Mp);function Mp(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}var Op=(Object.defineProperty(_p.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(_p.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),_p.prototype.loadConnection=function(t){return Promise.resolve(new Rp(t))},_p.prototype.newConnectivityMonitor=function(){return Ep.isAvailable()?new Ep:new wp},_p.prototype.newSerializer=function(t){return new Wl(t,{useProto3Json:!0})},_p.prototype.formatJSON=function(t){return JSON.stringify(t)},_p.prototype.atob=function(t){return atob(t)},_p.prototype.btoa=function(t){return btoa(t)},_p);function _p(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}Ur.setPlatform(new Op),function(t){t.INTERNAL.registerService("firestore",(function(t){return new Fd(t)}),function(t){Br(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(bp))}(t)}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}}));